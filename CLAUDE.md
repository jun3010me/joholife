# Claude開発メモ

このファイルは、Claudeが効率的に開発を進めるための重要な情報を記録しています。

## プロジェクト構造

### プログラミングレッスンシステム

- **レッスン一覧ページ**: `src/pages/programming-lessons/index.astro`
- **個別レッスンページ**: `src/pages/programming-lessons/[lesson_id].astro`
- **Python実行環境**: Pyodideを使用したブラウザ内Python実行

#### プログラミングレッスンの特徴

1. **ステップバイステップ学習**
   - 各レッスンは複数のステップに分かれており、段階的に学習できる
   - 各ステップにはコード例、説明、解説が含まれる

2. **実行可能なコードエディタ**
   - CodeMirrorを使用したシンタックスハイライト付きエディタ
   - Pyodideによるブラウザ内でのPython実行
   - リアルタイムでの実行結果表示

3. **コピー&ペースト機能**
   - 各ステップのコード例をワンクリックでエディタにコピー可能
   - 学習者が手軽にコードを試せる

#### 新しいレッスンを追加する手順

1. **レッスン一覧に追加**
   `src/pages/programming-lessons/index.astro`の`lessons`配列に新しいレッスンを追加：
   ```javascript
   {
       id: 'lesson-id',           // URLに使用されるID
       title: 'レッスンタイトル',
       description: 'レッスンの説明',
       icon: '📝',                // 絵文字アイコン
       difficulty: 'easy|medium|hard',
       estimatedTime: 10,         // 推定学習時間（分）
       color: 'from-blue-500 to-indigo-600'  // Tailwindのグラデーション
   }
   ```

2. **レッスンページの作成**
   `src/pages/programming-lessons/[lesson-id].astro`を作成：
   ```javascript
   const steps = [
       {
           id: 1,
           title: 'ステップタイトル',
           description: 'ステップの説明',
           code: 'print("Hello")',  // コード例（\nで改行）
           explanation: '詳しい解説'
       },
       // 追加のステップ...
   ];
   ```

3. **既存のレッスンをテンプレートとして使用**
   - `src/pages/programming-lessons/print.astro`をコピーして編集
   - `steps`配列の内容を変更するだけで新しいレッスンが作成できる

#### レッスンページの構造

- **左側**: ステップカード（スクロール可能）
  - 各ステップの説明
  - コード例
  - 解説
  - コピーボタン

- **右側**: Pythonエディタ（固定表示）
  - CodeMirrorエディタ
  - 実行ボタン・クリアボタン
  - 実行結果表示エリア

#### レッスン作成のベストプラクティス

1. **適切なステップ数**: 5-10ステップが理想的
2. **段階的な難易度**: 簡単なものから徐々に複雑に
3. **実践的なコード例**: 実際に動くコードを提供
4. **丁寧な解説**: 初心者にもわかりやすい説明
5. **コメント付きコード**: 複雑なコードにはコメントを追加

#### プログラミングレッスン作成依頼のプロンプト例

**基本的な依頼の例：**

```
「じょうほうらいふ」のプログラミングレッスンに「変数」についてのレッスンを追加してください。

以下の内容を段階的に学習できるようにしてください：
- 変数とは何か
- 変数の作り方（代入）
- 変数の使い方
- 変数名のルール
- 複数の変数を使った計算

各ステップには、コード例と解説を含めてください。
```

**詳細な依頼の例：**

```
「じょうほうらいふ」のプログラミングレッスンに「if文（条件分岐）」のレッスンを追加してください。

【基本情報】
- レッスンID: if-statement
- レッスンタイトル: if文（条件分岐）
- 難易度: easy
- 推定学習時間: 15分
- アイコン: 🔀
- カラー: from-green-500 to-teal-600

【学習ステップ（7ステップ）】
1. if文とは何か（基本的な説明）
2. 単純なif文（条件が真の場合のみ実行）
3. if-else文（条件が偽の場合の処理）
4. 比較演算子の使い方（==, !=, >, <, >=, <=）
5. elif文（複数の条件分岐）
6. 論理演算子の使い方（and, or, not）
7. 実践例：年齢判定プログラム

【要望】
- 初心者にもわかりやすい説明を心がける
- 各ステップで実際に動くコードを提供
- コメントを適切に入れる
- 日本語の変数名や値を使って親しみやすくする
```

**複数レッスンの一括依頼の例：**

```
「じょうほうらいふ」のプログラミングレッスンに以下の3つのレッスンを追加してください：

1. **リスト（配列）の基礎**
   - リストの作成
   - 要素の追加・削除
   - インデックスを使った要素へのアクセス
   - リストの操作メソッド（append, remove, pop等）

2. **for文（繰り返し）**
   - for文の基本
   - rangeを使った繰り返し
   - リストの要素を順番に処理
   - ネストしたfor文

3. **関数の定義**
   - 関数とは何か
   - defを使った関数定義
   - 引数と戻り値
   - 関数の呼び出し方
   - 実践例：複数の関数を組み合わせる

各レッスンは5-8ステップで構成し、初心者向けの丁寧な解説とコード例を含めてください。
```

#### よくある依頼パターン

1. **特定のトピックのレッスン作成**
   - 「○○についてのレッスンを作成してください」
   - 学習内容を箇条書きで指定

2. **既存レッスンの改善**
   - 「print関数のレッスンにf文字列のステップを追加してください」
   - 特定のステップの修正や追加

3. **演習問題の追加**
   - 「変数のレッスンに練習問題を追加してください」
   - 学習後の確認問題の作成

### 問題演習システム

- **問題データの場所**: `public/questions/[unit_name]/questions.yaml`
- **問題一覧の管理**: `public/questions/index.yaml`
- **動的ルーティング**: `src/pages/quiz/[unit].astro`

### 新しい単元の問題を追加する手順

1. **問題ディレクトリの作成**
   ```bash
   mkdir public/questions/[unit_name]
   ```

2. **問題ファイルの作成**
   - `public/questions/[unit_name]/questions.yaml`を作成
   - 既存の問題ファイル（例：`public/questions/algorithms/questions.yaml`）と同じ構造を使用

3. **問題一覧への追加**
   - `public/questions/index.yaml`の`questionSets`配列に新しいunit_nameを追加

4. **動的ルーティングは自動更新**
   - `src/pages/quiz/[unit].astro`は`public/questions/index.yaml`から自動的に単元リストを読み取る
   - 手動でgetStaticPaths()を編集する必要はなし（2024年改善済み）

### 問題ファイルの構造

問題文、選択肢、説明などでMarkdown記法が使用可能です：
- **太字**: `**テキスト**` → **テキスト**
- *斜体*: `*テキスト*` → *テキスト*
- `コード`: `` `コード` `` → `コード`
- 改行: `<br>` または `\n`
- リンク: `[テキスト](URL)` → [テキスト](URL)

```yaml
id: unit_name
title: 単元名
description: 単元の説明
icon: 📝
difficulty: easy|medium|hard
estimatedTime: 数値（分）
category: カテゴリ名
tags:
  - タグ1
  - タグ2
questions:
  - id: q1
    type: single-choice|multiple-choice|true-false
    title: 問題のタイトル
    description: 問題文
    options:
      - id: a
        text: 選択肢のテキスト
        isCorrect: true|false
        explanation: 解説
    explanation: 問題全体の解説
    difficulty: easy|medium|hard
    tags:
      - 問題固有のタグ
    points: ポイント数
    hint: ヒント（オプション）
```

## 問題演習システムの動作

### クイズの流れ
1. **氏名入力画面**で名前を入力（修了証発行のため）
2. 問題を表示
3. ユーザーが選択肢を選択
4. 「次の問題」ボタンをクリック
5. **解説画面を表示**（正誤判定、選択肢ごとの解説、問題全体の解説）
6. 「次の問題へ」ボタンで次の問題、または「結果を見る」で終了
7. **100%達成時**: 修了証画面を表示し、ダウンロード可能

### 解説画面の内容
- 正解/不正解の判定と視覚的フィードバック
- 選択肢ごとの正誤表示（正解は緑、ユーザーの誤答は赤）
- 各選択肢の解説（option.explanation）
- 問題全体の詳しい解説（question.explanation）

## 開発時の注意点

- 新しい単元を追加する際は、上記の3つのステップを実行すること（動的ルーティングは自動更新）
- 問題ファイルの構造は既存のものと完全に一致させること（`correct_answer`形式ではなく`isCorrect`形式を使用）
- `public/questions/index.yaml`への追加を忘れると新しい単元にアクセスできない
- 選択肢と問題の両方に`explanation`フィールドを設定することで、より詳細な学習体験を提供

## 現在利用可能な問題セット

1. **binary_conversion** (2進数変換): 2進数と10進数の変換 - 初級レベル
2. **algorithms** (アルゴリズムの基礎): アルゴリズムと計算量 - 中級レベル  
3. **copyright** (著作権): 著作権法の基本概念と事例 - 中級レベル
4. **industrial** (産業財産権): 特許権、実用新案権、意匠権、商標権 - 中級レベル

## ネットワーク構築課題の重要な注意事項 ⚠️

**2025年9月16日の重要な学習事項：**

ネットワーク構築課題でシステム不具合が発生し、正しい解答が不正解と判定される問題が発覚しました。今後の課題作成時は以下に注意してください：

### 必ず確認すべき事項

1. **ネットワークシミュレータのデータ同期**
   - デバイスのIPアドレス変更時に `config.ipAddress` と `config.lan1.ipAddress` が同期されているか
   - JSONファイル保存→読み込み→再保存のフローで整合性が保たれるか

2. **問題演習システムの判定ロジック**
   - YAMLの `expectedChanges` が正しく解析されているか（特に配列形式の場合）
   - 重複IP判定で同じIPが複数回カウントされていないか
   - デバッグログを仕込んで判定過程を可視化する

3. **課題設計のベストプラクティス**
   - YAMLは配列形式より単純なオブジェクト形式を推奨
   - 課題ファイル→修正→判定の全フローを必ずテスト
   - ブラウザコンソールでのデバッグ情報確認を習慣化

### 詳細ガイド
トラブルシューティングの詳細は `/docs/network-exercise-development-guide.md` を参照してください。

---

## プログラミング問題演習システム

### 概要

AtCoderのような、Pythonのコードを入力してその場で判定できるプログラミング問題演習システムです。

### システムの特徴

1. **2カラムレイアウト**
   - 左側：問題文、入出力例、ヒント
   - 右側：Pythonエディタ（スクロール追従）

2. **コード判定機能**
   - 複数のテストケースで自動判定
   - 入力例と出力例のセットを事前登録
   - 正解時に修了証を発行（ソースコード付き）

3. **エディタ機能**
   - 「実行」ボタン：コードを実行して動作確認
   - 「クリア」ボタン：コードをクリア
   - 「判定」ボタン：テストケースで判定

### ファイル構成

- **問題データ**: `public/programming-exercises/[exercise-id].yaml`
- **問題一覧**: `public/programming-exercises/index.yaml`
- **動的ルーティング**: `src/pages/programming-exercise/[exercise].astro`

### プログラミング問題の作成手順

1. **問題YAMLファイルの作成**
   ```bash
   # public/programming-exercises/ディレクトリに新しいYAMLファイルを作成
   touch public/programming-exercises/[problem-id].yaml
   ```

2. **YAMLファイルの記述**
   ```yaml
   id: problem-id
   title: プログラミング課題タイトル
   description: 問題の簡単な説明
   icon: 🐍
   difficulty: easy  # easy, medium, hard
   estimatedTime: 5  # 推定時間（分）
   category: プログラミング
   tags:
     - Python
     - タグ名

   problem:
     statement: 問題文をここに記述
     input: 入力の説明（なしの場合は"なし"）
     output: 出力の説明

   testCases:
     - id: 1
       input: "入力例1（なしの場合は空文字列）"
       output: "期待される出力1"
     - id: 2
       input: "入力例2"
       output: "期待される出力2"
     - id: 3
       input: "入力例3"
       output: "期待される出力3"

   solution: |
     # 模範解答のコード
     print("Hello World!")

   initialCode: |
     # エディタに最初から表示されるコード（穴埋め形式など）
     # このフィールドは任意。設定しない場合はエディタは空
     print("ほげ")

   hints:
     - ヒント1
     - ヒント2
   ```

3. **index.yamlへの追加**
   ```yaml
   # public/programming-exercises/index.yaml
   exerciseSets:
     - hello-world
     - problem-id  # 新しい問題を追加
   ```

4. **問題一覧ページへの追加（重要！）**
   - `src/pages/quiz/index.astro`の`categoryConfig`配列内のプログラミングカテゴリ（404-409行目付近）にある`order`配列に新しい問題IDを追加
   ```javascript
   {
     id: 'programming',
     title: 'プログラミング',
     icon: '🐍',
     order: ['hello-world', 'multiplication', ..., 'problem-id'], // ← 追加
     isProgramming: true
   }
   ```
   - **この手順を忘れると、問題ファイルは作成されても/quizページの一覧に表示されません！**

5. **動作確認**
   - 開発サーバーで `/quiz` にアクセスし、プログラミングカテゴリに新しい問題が表示されることを確認
   - 問題カードをクリックして `/programming-exercise/[problem-id]` にアクセス
   - 模範解答をエディタに入力して判定ボタンを押す
   - 全テストケースが通過することを確認

### プログラミング問題作成のプロンプト例

```
「じょうほうらいふ」のプログラミング問題演習に新しい課題を追加してください。

## 問題情報
- 問題ID: [problem-id]
- タイトル: [課題のタイトル]
- 難易度: easy/medium/hard
- 推定時間: [数値]分
- カテゴリ: プログラミング
- タグ: [Python, タグ1, タグ2]

## 問題内容
【問題文】
[問題の詳細な説明]

【入力】
[入力の説明（入力がない場合は「なし」）]

【出力】
[出力の説明]

【テストケース】
入力例1: [入力内容]
出力例1: [期待される出力]

入力例2: [入力内容]
出力例2: [期待される出力]

入力例3: [入力内容]
出力例3: [期待される出力]

【模範解答】
```python
[正解となるPythonコード]
```

【エディタに挿入する初期コード（任意）】
```python
# 穴埋め形式のヒントコードなど
# 設定しない場合はエディタは空の状態から始まる
```

【ヒント（任意）】
- ヒント1
- ヒント2

以上の内容で、YAMLファイルを作成し、index.yamlに追加してください。
```

### 問題作成時の注意点

1. **問題一覧ページへの追加を忘れずに！（最重要）**
   - プログラミング問題を追加する際は、必ず`src/pages/quiz/index.astro`の`order`配列にも問題IDを追加すること
   - この手順を忘れると、問題ファイルは作成されても`/quiz`ページの一覧に表示されない
   - よく忘れがちな手順なので特に注意

2. **テストケースの設計**
   - 最低3つのテストケースを用意
   - 基本ケース、境界値、特殊ケースをカバー
   - 出力は正確に一致する必要がある（スペース、改行含む）

3. **入出力の扱い**
   - 入力がない問題の場合、input欄は空文字列 `""`
   - 出力の末尾改行は自動的にトリミングされる
   - 複数行の入出力も対応可能

4. **模範解答のテスト**
   - 必ず模範解答で全テストケースが通過することを確認
   - エッジケースでも正しく動作するか検証

5. **初期コード（initialCode）の活用**
   - 穴埋め形式のヒントコードをエディタに最初から表示できる
   - 「ほげ」などのプレースホルダーを使って学習者が埋める形式が効果的
   - 難易度の高い問題では特に有効（例：課題⑫ユークリッド互除法、課題⑬素数判定）
   - 設定しない場合はエディタは空の状態から始まる

6. **修了証の発行**
   - 全テストケース合格時に自動的に修了証モーダルが表示
   - 提出したコードが赤文字で修了証に記載される
   - Canvas APIでPNG画像として生成・ダウンロード可能

### 修了証のデザイン仕様

修了証は`src/pages/programming-exercise/[exercise].astro`の`generateCertificate()`関数（514-655行目）で生成されます。

#### デザイン要素

1. **キャンバスサイズ**: 1200x900px
2. **背景**: グラデーション（#f8fafc → #e2e8f0）
3. **枠線**:
   - 外枠: 緑色（#059669）8px
   - 内枠: 濃い緑色（#047857）2px
4. **タイトル部分**:
   - 「修了証」（日本語）: 太字48px、黒色
   - "Certificate of Completion": 24px、グレー
5. **氏名**: 太字36px、黒色
6. **本文**:
   - 「上記の方は、以下の課題において」
   - 「合格して修了されました」
   - 20px、グレー
7. **課題名**: 太字30px、緑色（#047857）
8. **発行日**: 18px、グレー（日本語形式）
9. **提出コード**:
   - タイトル「提出コード」: 太字20px
   - コードボックス: 背景#f8fafc、枠線#e2e8f0
   - コード本体: 赤色（#dc2626）、等幅フォント16px
   - 最大13行表示（それ以上は...で省略）
10. **サイト名**: 「じょうほうらいふ」太字20px、緑色
11. **なりすまし防止情報**（黄色 #f59e0b）:
    - 発行時刻、アクセス元、端末情報、画面解像度
    - 端末識別コード（SHA-256ハッシュの12桁）
12. **装飾**: 四隅に緑色のグラデーション円

#### 必要な変数

- `userName`: 氏名入力モーダルで取得
- `exerciseTitle`: YAMLの`title`フィールド（`define:vars`で渡す）
- `submittedCode`: 判定合格時のコード

#### ファイル名

`修了証_{課題名}_{氏名}_{日付}.png`

### 現在利用可能なプログラミング問題

1. **hello-world** (プログラミング課題①): print関数の基礎 - 初級レベル

---

## データベース正規化シミュレータ

### 概要

データベースの正規化を学習するための、視覚的でインタラクティブなシミュレータです。ネットワーク構築シミュレータをベースに、テーブルと列の操作に特化した機能を実装しています。

### アクセスURL

- **メインページ**: `/database-simulator`

### ファイル構成

- **メインページ**: `src/pages/database-simulator.astro`
- **コアロジック**: `public/database-simulator/scripts/core/database-simulator.js`
- **メインスタイル**: `public/database-simulator/styles/main.css`
- **モバイルスタイル**: `public/database-simulator/styles/mobile.css`

### 主な機能

#### 1. テーブル操作

- **新規テーブル作成**:
  - ツールバーの「➕ 新しいテーブル」ボタンで作成
  - テーブル名を入力するとダイアログが表示される
  - テーブル名の長さに応じて自動的に幅が調整される（1文字16px + パディング80px、最小幅150px）
  - デフォルトでは列は空（ユーザーが必要な列を追加）

- **テーブル名変更**:
  - **マウス操作**: テーブルのタイトル部分（紫色の部分）をダブルクリック
  - **タッチ操作**: テーブルのタイトル部分をダブルタップ（300ms以内に2回タップ）
  - promptダイアログで新しいテーブル名を入力
  - 列がない場合は幅も自動調整

- **テーブル移動**:
  - テーブル全体をドラッグ&ドロップで移動
  - クリックしたテーブルが最前面（最高zIndex）に移動
  - 重なったテーブルは、視覚的に手前のものが操作対象になる

#### 2. 列操作

- **列の移動**（別テーブルへ）:
  - **マウス操作**: 列をクリックして選択 → ドラッグして別のテーブルにドロップ
  - **タッチ操作**: 列をタッチしてドラッグ（10px以上移動で列ドラッグモード開始）
  - **主キー列**: コピーされ、外部キーとして追加
  - **非主キー列**: 移動され、元のテーブルから削除
  - **データ移動**: 列と一緒にsampleDataも移動

- **列の並び替え**（同じテーブル内）:
  - **マウス操作**: 列をドラッグして同じテーブル内の別の位置にドロップ
  - **タッチ操作**: 列をタッチしてドラッグ（同じテーブル内の別の位置にドロップ）
  - 列の中心を基準に、左半分にドロップで前に、右半分で後ろに挿入
  - 左から右、右から左、どちらの方向にも移動可能

- **主キー設定**:
  - **マウス操作**: 列を右クリック
  - **タッチ操作**: 列を長押し（500ms以上）
  - 主キーのトグル切り替え
  - 主キー列は黄色で表示（🔑マーク付き）

#### 3. データ表示

- **データシートビュー**:
  - 横方向のMS Accessライクなレイアウト
  - 列ヘッダーが横に並び、その下にレコードデータが表示
  - 各列幅は120px固定

- **レコード表示切り替え**:
  - 「全レコード表示」チェックボックス
  - チェック無し: 最大10件のレコードを表示
  - チェック有り: 全レコードを表示

- **空のテーブル表示**:
  - 列がないテーブルでも、タイトル部分が表示される
  - 列を追加すると自動的に通常のテーブル表示に拡張

#### 4. リレーション表示

- **自動検出**:
  - 主キーと同名の列を外部キーとして自動検出
  - テーブル間に緑色の点線矢印で表示

- **最短距離接続**:
  - 2つのテーブルの中心座標を計算
  - 中心同士を結ぶ直線と各テーブルの辺との交点を計算
  - テーブルの位置関係に応じて、最適な辺から接続線が引かれる
  - ネットワーク構築シミュレータと同様の仕組み

#### 5. ドラッグアニメーション

- **列ドラッグ中の視覚フィードバック**:
  - マウス位置に半透明の青いボックスを表示
  - 移動中の列の情報（列名、データ型、主キーマーク）を表示
  - ドロップ先のテーブルを緑色の点線でハイライト
  - カーソルが'grabbing'に変更

#### 6. ビューポート操作

- **ズーム**: マウスホイール（またはピンチ）でズームイン/アウト
- **パン**: 空白部分をドラッグ（または2本指ドラッグ）で画面移動
- **スケール範囲**: 0.1〜3倍

#### 7. データ管理

- **保存**: JSONファイルとしてダウンロード
- **読込**: 保存したJSONファイルを読み込み
- **リセット**: 初期状態（図書館貸出管理の非正規化テーブル）に戻す

#### 8. SQLコマンド機能

- **SQLターミナル**: ツールバーの「💻 SQLコマンド」ボタンでターミナルを開く
- **対応コマンド**:
  - **SELECT**: データの取得（`SELECT * FROM テーブル名`）
  - **INSERT**: データの挿入（`INSERT INTO テーブル名 (列1, 列2) VALUES (値1, 値2)`）
  - **UPDATE**: データの更新（`UPDATE テーブル名 SET 列名 = 値 WHERE 条件`）
  - **DELETE**: データの削除（`DELETE FROM テーブル名 WHERE 条件`）
  - **CREATE TABLE**: テーブル作成（`CREATE TABLE テーブル名 (列1 型, 列2 型 PRIMARY KEY)`）
  - **DROP TABLE**: テーブル削除（`DROP TABLE テーブル名`）
  - **SHOW TABLES**: テーブル一覧表示
  - **DESC/DESCRIBE**: テーブル構造表示（`DESC テーブル名`）
  - **JOIN**: 複数テーブル結合（INNER JOIN, LEFT JOIN対応）
- **サポート構文**:
  - **WHERE句**: 条件フィルタリング（`=`演算子、`IN`句、`BETWEEN`句、`LIKE`句対応）
  - **ORDER BY句**: 並び替え（ASC/DESC）
  - **GROUP BY句**: グループ化（COUNT(*) 集計関数対応）
  - **LIMIT句**: 結果の行数制限（`SELECT * FROM テーブル名 LIMIT 10`）
  - **IN句**: 複数の値のいずれかに一致（`列名 IN ('値1', '値2', '値3')`）
  - **BETWEEN句**: 範囲指定（日付・数値・文字列に対応）
  - **LIKE句**: パターンマッチング（`%`は0文字以上の任意の文字、`_`は1文字の任意の文字）
- **使用例**:
  ```sql
  -- 基本的なSELECT
  SELECT * FROM 会員;

  -- WHERE句で条件フィルタリング
  SELECT * FROM 貸出 WHERE 貸出状態 = '貸出中';

  -- IN句で複数の値に一致
  SELECT * FROM 貸出 WHERE 会員ID IN ('M001', 'M002', 'M003');

  -- BETWEEN句で日付範囲指定
  SELECT * FROM 貸出 WHERE 返却予定日 BETWEEN '2024-12-01' AND '2024-12-05';

  -- LIKE句でパターンマッチング（前方一致）
  SELECT * FROM 貸出テーブル WHERE 書籍ID LIKE 'B00%';

  -- LIKE句でパターンマッチング（部分一致）
  SELECT * FROM 会員 WHERE 会員氏名 LIKE '%田中%';

  -- ORDER BY句で並び替え
  SELECT * FROM 貸出 ORDER BY 貸出ID DESC;

  -- LIMIT句で先頭5件のみ取得
  SELECT * FROM 会員 LIMIT 5;

  -- ORDER BYとLIMITの組み合わせ
  SELECT * FROM 貸出 ORDER BY 貸出日 DESC LIMIT 10;

  -- JOINとLIMITの組み合わせ
  SELECT * FROM 会員 JOIN 貸出 ON 会員.会員番号 = 貸出.会員番号 LIMIT 10;

  -- WHERE句（IN）とORDER BYの組み合わせ
  SELECT * FROM 貸出 WHERE 会員ID IN ('M001', 'M002') ORDER BY 貸出日 DESC;
  ```

### サンプルデータ

初期状態では、図書館貸出管理の非正規化テーブルが表示されます：

```javascript
{
  "貸出ID": "L001",
  "会員番号": "M001",
  "会員氏名": "田中太郎",
  "電話番号": "090-1111-2222",
  "登録日": "2023-04-01",
  "ISBN": "978-1111",
  "書籍名": "データベース入門",
  "著者": "山田一郎",
  "出版社": "A出版",
  "出版年": "2023",
  "貸出日": "2024-01-10",
  "返却予定日": "2024-01-24"
}
```

### データ構造

#### テーブルオブジェクト

```javascript
{
  id: 数値,
  name: "テーブル名",
  x: 数値,  // ワールド座標
  y: 数値,  // ワールド座標
  width: 数値,
  height: 数値,
  zIndex: 数値,  // 描画順序とクリック優先順位
  columns: [
    {
      id: 数値,
      name: "列名",
      isPrimaryKey: true/false,
      dataType: "INT|VARCHAR|DATE"
    }
  ],
  sampleData: [
    {
      "列名1": "値1",
      "列名2": "値2",
      ...
    }
  ]
}
```

#### リレーションオブジェクト

```javascript
{
  fromTable: テーブルID,
  toTable: テーブルID,
  columnName: "列名"
}
```

### 技術的な実装詳細

#### Canvas描画

- **描画順序**: テーブルをzIndex順にソートして描画（小さい順 = 後ろから描画）
- **座標変換**: ワールド座標とCanvas座標の変換を実装
- **動的サイズ計算**: 列数とレコード数に応じてテーブルサイズを自動計算

#### データ移動ロジック

列を移動する際のデータ処理：

1. **移動先が空の場合**:
   - 移動元のsampleDataをベースに新しいレコードを作成
   - 移動先テーブルの既存列を空文字列で初期化
   - 移動する列のデータを追加

2. **移動先に既存レコードがある場合**:
   - レコード数を両テーブルの最大値に合わせて統合
   - 既存レコードをベースに、移動する列のデータを追加

3. **元のテーブルからデータ削除**:
   - 非主キー列のデータは元のテーブルから削除
   - 主キー列のデータはそのまま保持

#### 列並び替えロジック

同じテーブル内で列を並び替える際の処理：

1. 移動する列を配列から削除
2. 目標インデックスを調整（削除の影響を考慮）
3. 調整後のインデックスに挿入

#### 接続線描画アルゴリズム

テーブル間の接続線を最短距離で描画：

1. 2つのテーブルの中心座標を計算
2. 中心同士を結ぶ直線を計算
3. 各テーブルの4辺（上、下、左、右）との交点を計算
4. 最も近い交点を選択して接続線を描画

#### タッチイベント処理（列ドラッグ）

タッチ操作で列をドラッグする際の処理フロー：

**1. handleTouchStart() - タッチ開始時**:
- タッチ位置がテーブルの列かどうかをチェック（`getColumnAt()`）
- 列の場合、`touchStartColumn`, `touchStartTable`, `touchStartColumnInfo`に保存
- 長押しタイマーを設定（500ms後に主キー切り替え）

**2. handleTouchMove() - タッチ移動時**:
- 移動距離が10pxを超えた場合、ドラッグモードを判定
- `touchStartColumn`が存在する場合:
  - 列ドラッグモードに切り替え
  - `isDraggingColumn = true`
  - `draggedColumn`, `draggedFromTable`を設定
  - 長押しタイマーをキャンセル
- `touchStartColumn`が存在しない場合:
  - テーブルドラッグまたはパンモードに切り替え

**3. handleTouchEnd() - タッチ終了時**:
- `isDraggingColumn`が`true`の場合:
  - ドロップ先のテーブルを取得（`getTableAt()`）
  - 同じテーブル内の場合: `reorderColumns()`を呼び出し
  - 別のテーブルの場合: `moveColumns()`を呼び出し
- ドラッグでない場合:
  - タップ判定（300ms以内、10px以内の移動）
  - 列の選択・解除処理

**重要なポイント**:
- 列の長押し（500ms）で主キー切り替え
- 10px以上のドラッグで列移動モード開始
- マウス操作と同じロジックを使用してドロップ処理を実行

### 開発時の注意点

1. **sampleDataの構造**:
   - 列名をキーとするオブジェクトの配列
   - 配列の配列ではなく、`{ "列名": "値" }` の形式

2. **列が空のテーブル**:
   - drawTable()メソッドで、列が空の場合でもタイトル部分を描画
   - 列を追加すると自動的に通常のテーブル表示に拡張

3. **z-index管理**:
   - クリックしたテーブルを最前面に移動
   - getTableAt()で重なったテーブルの最高zIndexを返す

4. **レイアウト**:
   - ページ全体のスクロールを無効化（overflow: hidden）
   - フッターを非表示
   - 100vh固定で全画面表示

### 学習効果

このシミュレータを使用することで、学習者は以下を体験的に理解できます：

1. **正規化の過程**:
   - 非正規化テーブルから列を分割
   - 適切なテーブルに列を配置
   - 主キーと外部キーの関係を視覚的に確認

2. **データの整合性**:
   - 列を移動してもデータが保持される
   - リレーションが自動的に検出される

3. **データベース設計**:
   - テーブル名の変更
   - 列の配置を試行錯誤
   - 最終的な設計をJSONで保存

### 今後の拡張案

- 列の追加機能（新規列の作成）
- 列名の編集機能
- データ型の変更機能
- リレーションの手動作成・削除
- ER図モードへの切り替え
- SQLスキーマの自動生成とエクスポート

---

## コマンド

- 開発サーバー起動: `npm run dev`
- ビルド: `npm run build`
- プレビュー: `npm run preview`