---
// markdown-editor.astro
import Layout from '../layouts/Layout.astro';
---

<Layout
    title="Markdown„Ç®„Éá„Ç£„Çø - „Åò„Çá„ÅÜ„Åª„ÅÜ„Çâ„ÅÑ„Åµ"
    description="„Éñ„É©„Ç¶„Ç∂„ÅßÂãï‰Ωú„Åô„ÇãÈ´òÊ©üËÉΩMarkdown„Ç®„Éá„Ç£„Çø„ÄÇ„É™„Ç¢„É´„Çø„Ç§„É†„Éó„É¨„Éì„É•„Éº„ÄÅËá™Âãï‰øùÂ≠ò„ÄÅ„Çπ„É©„ÉÉ„Ç∑„É•„Ç≥„Éû„É≥„ÉâÂØæÂøú„ÄÇ"
    keywords="Markdown,„Ç®„Éá„Ç£„Çø,„Éû„Éº„ÇØ„ÉÄ„Ç¶„É≥,„Éó„É¨„Éì„É•„Éº,ÊïôËÇ≤,Â≠¶Áøí"
>
    <div class="markdown-editor-container">
        <!-- Header -->
        <div class="editor-header">
            <div class="header-left">
                <h1>üìù Markdown„Ç®„Éá„Ç£„Çø</h1>
            </div>
            <div class="header-controls">
                <label class="layout-toggle" id="layout-toggle-label">
                    <input type="checkbox" id="layout-toggle" checked>
                    <span>„Éó„É¨„Éì„É•„Éº„ÇíÂ∑¶„Å´Ë°®Á§∫</span>
                </label>
                <button id="open-file-btn" class="btn btn-secondary">
                    üìÇ „Éï„Ç°„Ç§„É´„ÇíÈñã„Åè
                </button>
                <button id="download-btn" class="btn btn-success">
                    üíæ „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
                </button>
                <input type="file" id="file-input" accept=".md" style="display: none;">
            </div>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <span id="save-status">üíæ Ëá™Âãï‰øùÂ≠òÊúâÂäπ</span>
            <span id="char-count">0 ÊñáÂ≠ó</span>
        </div>

        <!-- Notification -->
        <div id="notification" class="notification hidden"></div>

        <!-- Main Content Area -->
        <div class="editor-content" id="editor-content">
            <!-- Preview Pane -->
            <div class="pane preview-pane" id="preview-pane">
                <div class="pane-header">
                    <h3>üëÅÔ∏è „Éó„É¨„Éì„É•„Éº</h3>
                </div>
                <div class="pane-content markdown-preview" id="preview-content">
                    <p class="empty-message">„Åì„Åì„Å´Markdown„ÅÆ„Éó„É¨„Éì„É•„Éº„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô</p>
                </div>
            </div>

            <!-- Editor Pane -->
            <div class="pane editor-pane" id="editor-pane">
                <div class="pane-header">
                    <h3>‚úèÔ∏è Á∑®ÈõÜ</h3>
                </div>
                <div class="pane-content">
                    <div id="codemirror-editor"></div>
                </div>
            </div>
        </div>
    </div>
</Layout>

<style>
    /* Base Styles */
    .markdown-editor-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
        overflow: hidden;
        background: #f8fafc;
    }

    /* Header */
    .editor-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.5rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .header-left h1 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 700;
    }

    .header-controls {
        display: flex;
        gap: 0.75rem;
        align-items: center;
    }

    .layout-toggle {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
        font-size: 0.9rem;
        background: rgba(255, 255, 255, 0.2);
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        transition: background 0.2s;
    }

    .layout-toggle:hover {
        background: rgba(255, 255, 255, 0.3);
    }

    .layout-toggle input {
        cursor: pointer;
    }

    /* Buttons */
    .btn {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 0.5rem;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .btn-secondary {
        background: white;
        color: #667eea;
    }

    .btn-secondary:hover {
        background: #f0f0f0;
        transform: translateY(-1px);
    }

    .btn-success {
        background: #10b981;
        color: white;
    }

    .btn-success:hover {
        background: #059669;
        transform: translateY(-1px);
    }

    /* Status Bar */
    .status-bar {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 1.5rem;
        background: #e2e8f0;
        font-size: 0.85rem;
        color: #64748b;
        border-bottom: 1px solid #cbd5e1;
    }

    /* Notification */
    .notification {
        position: fixed;
        top: 5rem;
        right: 1.5rem;
        padding: 1rem 1.5rem;
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        max-width: 400px;
        animation: slideIn 0.3s ease-out;
    }

    .notification.hidden {
        display: none;
    }

    .notification.info {
        border-left: 4px solid #3b82f6;
    }

    .notification.success {
        border-left: 4px solid #10b981;
    }

    .notification.warning {
        border-left: 4px solid #f59e0b;
    }

    .notification.error {
        border-left: 4px solid #ef4444;
    }

    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    /* Editor Content */
    .editor-content {
        display: flex;
        flex: 1;
        overflow: hidden;
        gap: 1px;
        background: #cbd5e1;
    }

    /* Layout Variants */
    .editor-content.preview-left {
        flex-direction: row;
    }

    .editor-content.preview-right {
        flex-direction: row-reverse;
    }

    /* Panes */
    .pane {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: white;
        overflow: hidden;
    }

    .pane-header {
        padding: 0.75rem 1rem;
        background: #f1f5f9;
        border-bottom: 1px solid #e2e8f0;
    }

    .pane-header h3 {
        margin: 0;
        font-size: 1rem;
        font-weight: 600;
        color: #334155;
    }

    .pane-content {
        flex: 1;
        overflow: auto;
        padding: 1rem;
    }

    /* CodeMirror Editor */
    #codemirror-editor {
        height: 100%;
        font-size: 14px;
    }

    .editor-pane .pane-content {
        padding: 0;
    }

    /* Markdown Preview */
    .markdown-preview {
        line-height: 1.8;
        color: #1e293b;
    }

    .markdown-preview .empty-message {
        color: #94a3b8;
        font-style: italic;
        text-align: center;
        margin-top: 2rem;
    }

    /* Markdown Styles */
    .markdown-preview h1,
    .markdown-preview h2,
    .markdown-preview h3,
    .markdown-preview h4,
    .markdown-preview h5,
    .markdown-preview h6 {
        margin-top: 1.5em;
        margin-bottom: 0.5em;
        font-weight: 600;
        line-height: 1.3;
    }

    .markdown-preview h1 {
        font-size: 2em;
        border-bottom: 2px solid #e2e8f0;
        padding-bottom: 0.3em;
    }

    .markdown-preview h2 {
        font-size: 1.5em;
        border-bottom: 1px solid #e2e8f0;
        padding-bottom: 0.3em;
    }

    .markdown-preview h3 {
        font-size: 1.25em;
    }

    .markdown-preview p {
        margin: 1em 0;
    }

    .markdown-preview a {
        color: #3b82f6;
        text-decoration: none;
    }

    .markdown-preview a:hover {
        text-decoration: underline;
    }

    .markdown-preview code {
        background: #f1f5f9;
        padding: 0.2em 0.4em;
        border-radius: 0.25rem;
        font-family: 'Courier New', monospace;
        font-size: 0.9em;
    }

    .markdown-preview pre {
        background: #1e293b;
        color: #e2e8f0;
        padding: 1em;
        border-radius: 0.5rem;
        overflow-x: auto;
        margin: 1em 0;
    }

    .markdown-preview pre code {
        background: transparent;
        padding: 0;
        color: inherit;
    }

    .markdown-preview blockquote {
        border-left: 4px solid #3b82f6;
        padding-left: 1em;
        margin: 1em 0;
        color: #64748b;
        font-style: italic;
    }

    .markdown-preview ul,
    .markdown-preview ol {
        margin: 1em 0;
        padding-left: 2em;
    }

    .markdown-preview li {
        margin: 0.5em 0;
    }

    .markdown-preview table {
        border-collapse: collapse;
        width: 100%;
        margin: 1em 0;
    }

    .markdown-preview th,
    .markdown-preview td {
        border: 1px solid #e2e8f0;
        padding: 0.5em 1em;
        text-align: left;
    }

    .markdown-preview th {
        background: #f1f5f9;
        font-weight: 600;
    }

    .markdown-preview img {
        max-width: 100%;
        height: auto;
        border-radius: 0.5rem;
        margin: 1em 0;
    }

    .markdown-preview hr {
        border: none;
        border-top: 2px solid #e2e8f0;
        margin: 2em 0;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
        .editor-header {
            flex-direction: column;
            gap: 0.75rem;
            padding: 1rem;
        }

        .header-left h1 {
            font-size: 1.25rem;
        }

        .header-controls {
            width: 100%;
            flex-wrap: wrap;
            justify-content: space-between;
        }

        .layout-toggle {
            display: none !important;
        }

        .preview-pane {
            display: none !important;
        }

        .editor-pane {
            flex: 1;
        }

        .status-bar {
            flex-direction: column;
            gap: 0.25rem;
        }

        .btn {
            font-size: 0.85rem;
            padding: 0.4rem 0.8rem;
        }
    }

    /* Hide footer on this page */
    :global(footer) {
        display: none;
    }
</style>

<script>
    // Import CodeMirror
    import { EditorView, basicSetup } from 'codemirror';
    import { EditorState } from '@codemirror/state';
    import { markdown } from '@codemirror/lang-markdown';
    import { autocompletion, CompletionContext } from '@codemirror/autocomplete';
    import markdownit from 'markdown-it';

    // Initialize Markdown parser
    const md = markdownit({
        html: true,
        linkify: true,
        typographer: true,
        breaks: true,
    });

    // Global state
    let editorView: EditorView;
    let fileHandle: FileSystemFileHandle | null = null;
    let autoSaveTimeout: number | null = null;
    let hasPromptedForSave = false;

    // LocalStorage keys
    const STORAGE_KEY_CONTENT = 'editorContent';
    const STORAGE_KEY_LAYOUT = 'editorLayout';

    // Initialize editor on page load
    document.addEventListener('DOMContentLoaded', () => {
        initializeEditor();
        initializeLayoutToggle();
        initializeFileHandlers();
        restoreContent();
    });

    // Initialize CodeMirror editor
    function initializeEditor() {
        const container = document.getElementById('codemirror-editor');
        if (!container) return;

        const startState = EditorState.create({
            doc: '',
            extensions: [
                basicSetup,
                markdown(),
                autocompletion({
                    override: [slashCommands],
                }),
                EditorView.updateListener.of((update) => {
                    if (update.docChanged) {
                        handleContentChange();
                    }
                }),
            ],
        });

        editorView = new EditorView({
            state: startState,
            parent: container,
        });
    }

    // Slash commands autocomplete
    function slashCommands(context: CompletionContext) {
        const word = context.matchBefore(/\/\w*/);
        if (!word) return null;
        if (word.from === word.to && !context.explicit) return null;

        const options = [
            { label: '/h1', detail: 'Ë¶ãÂá∫„Åó1', apply: '# ', type: 'keyword' },
            { label: '/h2', detail: 'Ë¶ãÂá∫„Åó2', apply: '## ', type: 'keyword' },
            { label: '/h3', detail: 'Ë¶ãÂá∫„Åó3', apply: '### ', type: 'keyword' },
            { label: '/bold', detail: 'Âº∑Ë™ø', apply: '**text**', type: 'keyword' },
            { label: '/ul', detail: 'ÁÆáÊù°Êõ∏„Åç', apply: '- ', type: 'keyword' },
            { label: '/ol', detail: 'Áï™Âè∑‰ªò„Åç„É™„Çπ„Éà', apply: '1. ', type: 'keyword' },
            {
                label: '/table',
                detail: '„ÉÜ„Éº„Éñ„É´',
                apply: '| Âàó1 | Âàó2 | Âàó3 |\n| --- | --- | --- |\n| „Éá„Éº„Çø1 | „Éá„Éº„Çø2 | „Éá„Éº„Çø3 |',
                type: 'keyword',
            },
            { label: '/code', detail: '„Ç≥„Éº„Éâ„Éñ„É≠„ÉÉ„ÇØ', apply: '```\n\n```', type: 'keyword' },
        ];

        return {
            from: word.from,
            options,
        };
    }

    // Handle content change
    function handleContentChange() {
        const content = editorView.state.doc.toString();

        // Update character count
        updateCharCount(content.length);

        // Update preview
        updatePreview(content);

        // Save to localStorage
        saveToLocalStorage(content);

        // Check for 100-character threshold
        if (content.length > 100 && !hasPromptedForSave && !fileHandle) {
            promptForSave();
        }

        // Auto-save to file if handle exists
        if (fileHandle) {
            scheduleAutoSave(content);
        }
    }

    // Update character count
    function updateCharCount(count: number) {
        const charCountEl = document.getElementById('char-count');
        if (charCountEl) {
            charCountEl.textContent = `${count} ÊñáÂ≠ó`;
        }
    }

    // Update preview
    function updatePreview(content: string) {
        const previewEl = document.getElementById('preview-content');
        if (!previewEl) return;

        if (content.trim() === '') {
            previewEl.innerHTML = '<p class="empty-message">„Åì„Åì„Å´Markdown„ÅÆ„Éó„É¨„Éì„É•„Éº„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô</p>';
        } else {
            previewEl.innerHTML = md.render(content);
        }
    }

    // Save to localStorage
    function saveToLocalStorage(content: string) {
        try {
            localStorage.setItem(STORAGE_KEY_CONTENT, content);
        } catch (e) {
            console.error('LocalStorage save failed:', e);
        }
    }

    // Restore content from localStorage
    function restoreContent() {
        try {
            const saved = localStorage.getItem(STORAGE_KEY_CONTENT);
            if (saved) {
                editorView.dispatch({
                    changes: { from: 0, to: editorView.state.doc.length, insert: saved },
                });
            }
        } catch (e) {
            console.error('LocalStorage restore failed:', e);
        }
    }

    // Prompt for save at 100 characters
    function promptForSave() {
        hasPromptedForSave = true;
        showNotification(
            '100ÊñáÂ≠ó„ÇíË∂Ö„Åà„Åæ„Åó„Åü„ÄÇ„Éï„Ç°„Ç§„É´„Å®„Åó„Å¶‰øùÂ≠ò„Åó„Åæ„Åô„ÅãÔºü',
            'warning',
            [
                {
                    text: '‰øùÂ≠ò„Åô„Çã',
                    action: () => initiateFileSave(),
                },
                {
                    text: 'Âæå„Åß',
                    action: () => {},
                },
            ]
        );
    }

    // Show notification
    function showNotification(
        message: string,
        type: 'info' | 'success' | 'warning' | 'error' = 'info',
        actions: Array<{ text: string; action: () => void }> = []
    ) {
        const notificationEl = document.getElementById('notification');
        if (!notificationEl) return;

        notificationEl.className = `notification ${type}`;

        let html = `<div>${message}</div>`;
        if (actions.length > 0) {
            html += '<div style="margin-top: 0.75rem; display: flex; gap: 0.5rem;">';
            actions.forEach((action, index) => {
                html += `<button class="btn btn-${index === 0 ? 'success' : 'secondary'}" onclick="notificationActions[${index}]()" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">${action.text}</button>`;
            });
            html += '</div>';
        }

        notificationEl.innerHTML = html;
        notificationEl.classList.remove('hidden');

        // Store actions globally for onclick
        (window as any).notificationActions = actions.map((a) => () => {
            a.action();
            notificationEl.classList.add('hidden');
        });

        // Auto-hide after 5 seconds if no actions
        if (actions.length === 0) {
            setTimeout(() => {
                notificationEl.classList.add('hidden');
            }, 5000);
        }
    }

    // Initiate file save via File System Access API
    async function initiateFileSave() {
        try {
            const options = {
                types: [
                    {
                        description: 'Markdown Files',
                        accept: { 'text/markdown': ['.md'] },
                    },
                ],
                suggestedName: 'document.md',
            };

            fileHandle = await (window as any).showSaveFilePicker(options);
            const content = editorView.state.doc.toString();
            await saveToFile(content);
            showNotification('„Éï„Ç°„Ç§„É´„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü', 'success');
            updateSaveStatus('üíæ Ëá™Âãï‰øùÂ≠ò: ÊúâÂäπ');
        } catch (err: any) {
            if (err.name !== 'AbortError') {
                console.error('File save failed:', err);
                showNotification('„Éï„Ç°„Ç§„É´„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
        }
    }

    // Save to file
    async function saveToFile(content: string) {
        if (!fileHandle) return;

        try {
            const writable = await fileHandle.createWritable();
            await writable.write(content);
            await writable.close();
        } catch (err) {
            console.error('File write failed:', err);
            throw err;
        }
    }

    // Schedule auto-save (debounce)
    function scheduleAutoSave(content: string) {
        if (autoSaveTimeout !== null) {
            clearTimeout(autoSaveTimeout);
        }

        autoSaveTimeout = window.setTimeout(async () => {
            try {
                updateSaveStatus('üíæ ‰øùÂ≠ò‰∏≠...');
                await saveToFile(content);
                updateSaveStatus('üíæ Ëá™Âãï‰øùÂ≠ò: ÊúÄÊñ∞');
            } catch (err) {
                console.error('Auto-save failed:', err);
                updateSaveStatus('üíæ Ëá™Âãï‰øùÂ≠ò: Â§±Êïó');
            }
        }, 3000);
    }

    // Update save status
    function updateSaveStatus(status: string) {
        const statusEl = document.getElementById('save-status');
        if (statusEl) {
            statusEl.textContent = status;
        }
    }

    // Initialize layout toggle
    function initializeLayoutToggle() {
        const toggle = document.getElementById('layout-toggle') as HTMLInputElement;
        const content = document.getElementById('editor-content');

        if (!toggle || !content) return;

        // Restore layout preference
        const savedLayout = localStorage.getItem(STORAGE_KEY_LAYOUT) || 'preview-left';
        const isPreviewLeft = savedLayout === 'preview-left';

        toggle.checked = isPreviewLeft;
        content.className = `editor-content ${savedLayout}`;

        // Handle toggle change
        toggle.addEventListener('change', () => {
            const layout = toggle.checked ? 'preview-left' : 'preview-right';
            content.className = `editor-content ${layout}`;
            localStorage.setItem(STORAGE_KEY_LAYOUT, layout);
        });
    }

    // Initialize file handlers
    function initializeFileHandlers() {
        const openBtn = document.getElementById('open-file-btn');
        const downloadBtn = document.getElementById('download-btn');
        const fileInput = document.getElementById('file-input') as HTMLInputElement;

        // Open file
        openBtn?.addEventListener('click', () => {
            fileInput?.click();
        });

        fileInput?.addEventListener('change', async (e) => {
            const file = (e.target as HTMLInputElement).files?.[0];
            if (!file) return;

            try {
                const content = await file.text();
                editorView.dispatch({
                    changes: { from: 0, to: editorView.state.doc.length, insert: content },
                });
                showNotification(`„Éï„Ç°„Ç§„É´„Äå${file.name}„Äç„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü`, 'success');
            } catch (err) {
                console.error('File read failed:', err);
                showNotification('„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }

            // Reset input
            fileInput.value = '';
        });

        // Download file
        downloadBtn?.addEventListener('click', () => {
            const content = editorView.state.doc.toString();
            const blob = new Blob([content], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'document.md';
            a.click();
            URL.revokeObjectURL(url);
            showNotification('„Éï„Ç°„Ç§„É´„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü', 'success');
        });
    }
</script>
