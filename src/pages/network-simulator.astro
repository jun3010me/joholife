---
// network-simulator.astro
import Layout from '../layouts/Layout.astro';
---

<Layout title="ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é€šä¿¡ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿">
    <div class="network-simulator">
        <div class="simulator-header">
            <h1>ğŸŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é€šä¿¡ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿</h1>
            <p>ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ã‚µãƒ¼ãƒãƒ¼é–“ã®ãƒ‘ã‚±ãƒƒãƒˆé€šä¿¡ã‚’è¦–è¦šçš„ã«å­¦ã¼ã†ï¼</p>
        </div>

        <div class="simulator-content">
            <div class="network-section">
                <div class="section-header">
                    <h3>ğŸ“¡ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å›³</h3>
                    <div class="controls">
                        <button id="start-communication" class="btn btn-primary">
                            â–¶ï¸ é€šä¿¡é–‹å§‹
                        </button>
                        <button id="stop-communication" class="btn btn-secondary">
                            â¹ï¸ åœæ­¢
                        </button>
                        <button id="step-backward" class="btn btn-outline" disabled>
                            â—€ï¸ æˆ»ã‚‹
                        </button>
                        <button id="step-forward" class="btn btn-outline">
                            â–¶ï¸ é€²ã‚€
                        </button>
                        <button id="reset-network" class="btn btn-secondary">
                            ğŸ”„ ãƒªã‚»ãƒƒãƒˆ
                        </button>
                    </div>
                </div>
                <div id="network-container"></div>
            </div>

            <div class="info-section">
                <div class="section-header">
                    <h3>ğŸ“Š é€šä¿¡ãƒ­ã‚°</h3>
                    <button id="clear-log" class="btn btn-outline">ğŸ—‘ï¸ ã‚¯ãƒªã‚¢</button>
                </div>
                <div id="communication-log">
                    <div class="log-item">
                        ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é€šä¿¡ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãŒæº–å‚™ã§ãã¾ã—ãŸã€‚
                    </div>
                </div>

                <div class="network-info">
                    <h4>ğŸ’¡ å­¦ç¿’ãƒã‚¤ãƒ³ãƒˆ</h4>
                    <ul>
                        <li><strong>DNSè§£æ±º</strong>: ãƒ‰ãƒ¡ã‚¤ãƒ³åã‚’IPã‚¢ãƒ‰ãƒ¬ã‚¹ã«å¤‰æ›ã™ã‚‹ä»•çµ„ã¿</li>
                        <li><strong>HTTPé€šä¿¡</strong>: ãƒ–ãƒ©ã‚¦ã‚¶ã¨Webã‚µãƒ¼ãƒãƒ¼ã®åŸºæœ¬çš„ãªé€šä¿¡æ–¹å¼</li>
                        <li><strong>ãƒªã‚¯ã‚¨ã‚¹ãƒˆ</strong>: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒã‚µãƒ¼ãƒãƒ¼ã«é€ã‚‹è¦æ±‚</li>
                        <li><strong>ãƒ¬ã‚¹ãƒãƒ³ã‚¹</strong>: ã‚µãƒ¼ãƒãƒ¼ãŒã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«è¿”ã™å¿œç­”</li>
                        <li><strong>ãƒ‘ã‚±ãƒƒãƒˆ</strong>: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã§é€å—ä¿¡ã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ã®å¡Š</li>
                        <li><strong>ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°</strong>: ãƒ‘ã‚±ãƒƒãƒˆãŒç›®çš„åœ°ã¾ã§å±ŠããŸã‚ã®çµŒè·¯é¸æŠ</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="explanation-section">
            <h3>ğŸ“š ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é€šä¿¡ã®ä»•çµ„ã¿</h3>
            <div class="explanation-grid">
                <div class="explanation-card">
                    <h4>1ï¸âƒ£ DNSè§£æ±º</h4>
                    <p>ãƒ–ãƒ©ã‚¦ã‚¶ãŒã€Œexample.comã€ã®ã‚ˆã†ãªãƒ‰ãƒ¡ã‚¤ãƒ³åã‚’IPã‚¢ãƒ‰ãƒ¬ã‚¹ã«å¤‰æ›ã™ã‚‹ãŸã‚DNSã‚µãƒ¼ãƒãƒ¼ã«å•ã„åˆã‚ã›ã¾ã™ã€‚</p>
                </div>
                <div class="explanation-card">
                    <h4>2ï¸âƒ£ HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆ</h4>
                    <p>IPã‚¢ãƒ‰ãƒ¬ã‚¹ãŒåˆ†ã‹ã£ãŸã‚‰ã€ãƒ–ãƒ©ã‚¦ã‚¶ãŒWebã‚µãƒ¼ãƒãƒ¼ã«HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¾ã™ã€‚</p>
                </div>
                <div class="explanation-card">
                    <h4>3ï¸âƒ£ ãƒ‘ã‚±ãƒƒãƒˆãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°</h4>
                    <p>ãƒ‘ã‚±ãƒƒãƒˆã¯ãƒ«ãƒ¼ã‚¿ãƒ¼ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‚’çµŒç”±ã—ã¦ç›®çš„ã®ã‚µãƒ¼ãƒãƒ¼ã¾ã§å±Šã‘ã‚‰ã‚Œã¾ã™ã€‚</p>
                </div>
                <div class="explanation-card">
                    <h4>4ï¸âƒ£ HTTPãƒ¬ã‚¹ãƒãƒ³ã‚¹</h4>
                    <p>ã‚µãƒ¼ãƒãƒ¼ãŒè¦æ±‚ã•ã‚ŒãŸWebãƒšãƒ¼ã‚¸ã‚’åŒã˜çµŒè·¯ã‚’é€šã£ã¦ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«è¿”é€ã—ã¾ã™ã€‚</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Vis.js Network CSS -->
    <link rel="stylesheet" href="https://unpkg.com/vis-network/standalone/umd/vis-network.min.css">
    
    <script>
        let network = null;
        let nodes = null;
        let edges = null;
        let isAnimating = false;
        let animationInterval = null;
        let packetCounter = 0;
        let currentStep = 0;
        let totalSteps = 0;
        let animationSteps = [];
        let isManualMode = false;

        // é›²ã®SVGã‚’ä½œæˆ
        function createCloudSVG() {
            const svgString = `
                <svg xmlns="http://www.w3.org/2000/svg" width="90" height="70" viewBox="0 0 90 70">
                    <path d="M20,45 Q8,32 20,27 Q15,15 25,22 Q30,8 40,15 Q50,3 60,15 Q70,8 78,22 Q88,15 83,27 Q95,32 83,45 Q88,58 78,53 Q70,67 60,58 Q50,72 40,58 Q30,67 25,53 Q15,58 20,45 Z" 
                          fill="#e0f2fe" stroke="#0ea5e9" stroke-width="2"/>
                    <text x="45" y="40" text-anchor="middle" font-family="Arial" font-size="9" fill="#0ea5e9">Internet</text>
                </svg>
            `;
            return 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svgString);
        }

        // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®åˆæœŸåŒ–
        function initNetwork() {
            // ãƒãƒ¼ãƒ‰ï¼ˆãƒ‡ãƒã‚¤ã‚¹ï¼‰ã®å®šç¾©
            nodes = new vis.DataSet([
                {
                    id: 'client',
                    label: 'ğŸ’» ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆPC\n(ãƒ–ãƒ©ã‚¦ã‚¶)',
                    x: -300,
                    y: 0,
                    color: {border: '#2563eb', background: '#dbeafe'},
                    font: {size: 12, color: '#1e293b'},
                    shape: 'box',
                    widthConstraint: 120,
                    heightConstraint: 80,
                    physics: false
                },
                {
                    id: 'router',
                    label: 'ğŸŒ ãƒ«ãƒ¼ã‚¿ãƒ¼',
                    x: -150,
                    y: 0,
                    color: {border: '#059669', background: '#d1fae5'},
                    font: {size: 12, color: '#1e293b'},
                    shape: 'diamond',
                    size: 25,
                    physics: false
                },
                {
                    id: 'internet',
                    label: 'â˜ï¸ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆ',
                    x: 0,
                    y: 0,
                    color: {border: '#0ea5e9', background: '#e0f2fe'},
                    font: {size: 12, color: '#1e293b'},
                    shape: 'image',
                    image: createCloudSVG(),
                    size: 50,
                    physics: false
                },
                {
                    id: 'dns',
                    label: 'ğŸ” DNSã‚µãƒ¼ãƒãƒ¼\n(8.8.8.8)',
                    x: 50,
                    y: -180,
                    color: {border: '#7c3aed', background: '#ede9fe'},
                    font: {size: 12, color: '#1e293b'},
                    shape: 'box',
                    widthConstraint: 120,
                    heightConstraint: 80,
                    physics: false
                },
                {
                    id: 'server',
                    label: 'ğŸ–¥ï¸ Webã‚µãƒ¼ãƒãƒ¼\n(example.com)',
                    x: 250,
                    y: 0,
                    color: {border: '#dc2626', background: '#fee2e2'},
                    font: {size: 12, color: '#1e293b'},
                    shape: 'box',
                    widthConstraint: 120,
                    heightConstraint: 80,
                    physics: false
                }
            ]);

            // ã‚¨ãƒƒã‚¸ï¼ˆæ¥ç¶šï¼‰ã®å®šç¾©
            edges = new vis.DataSet([
                {
                    id: 'client-router',
                    from: 'client',
                    to: 'router',
                    label: 'LAN',
                    color: {color: '#64748b'},
                    width: 2,
                    arrows: {to: false}
                },
                {
                    id: 'router-internet',
                    from: 'router',
                    to: 'internet',
                    label: 'ISP',
                    color: {color: '#64748b'},
                    width: 2,
                    arrows: {to: false}
                },
                {
                    id: 'internet-dns',
                    from: 'internet',
                    to: 'dns',
                    label: 'DNSæ¥ç¶š',
                    color: {color: '#7c3aed'},
                    width: 2,
                    arrows: {to: false}
                },
                {
                    id: 'internet-server',
                    from: 'internet',
                    to: 'server',
                    label: 'HTTPæ¥ç¶š',
                    color: {color: '#dc2626'},
                    width: 2,
                    arrows: {to: false}
                }
            ]);

            const container = document.getElementById('network-container');
            const data = { nodes, edges };
            const options = {
                layout: {
                    hierarchical: false
                },
                physics: {
                    enabled: false
                },
                interaction: {
                    dragNodes: false,
                    dragView: true,
                    zoomView: true
                },
                nodes: {
                    borderWidth: 2,
                    shadow: true
                },
                edges: {
                    shadow: true,
                    smooth: {
                        type: 'continuous'
                    }
                }
            };

            network = new vis.Network(container, data, options);
            
            // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®åˆæœŸè¡¨ç¤ºèª¿æ•´
            network.fit();
        }

        // ãƒ‘ã‚±ãƒƒãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®ãƒãƒ¼ãƒ‰ã‚’ä½œæˆ
        function createPacket(id, label, fromPos, toPos, color = '#f59e0b') {
            return {
                id: id,
                label: label,
                x: fromPos.x,
                y: fromPos.y,
                color: {border: color, background: color + '80'},
                font: {size: 10, color: '#ffffff'},
                shape: 'dot',
                size: 15,
                physics: false
            };
        }

        // ãƒ‘ã‚±ãƒƒãƒˆã‚’ç§»å‹•ã•ã›ã‚‹
        function movePacket(packetId, fromPos, toPos, duration = 2000) {
            return new Promise((resolve) => {
                const startTime = Date.now();
                const packetInterval = setInterval(() => {
                    const elapsed = Date.now() - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    
                    // ã‚¤ãƒ¼ã‚¸ãƒ³ã‚°é–¢æ•°ï¼ˆæ»‘ã‚‰ã‹ãªç§»å‹•ï¼‰
                    const easeProgress = 1 - Math.pow(1 - progress, 3);
                    
                    const currentX = fromPos.x + (toPos.x - fromPos.x) * easeProgress;
                    const currentY = fromPos.y + (toPos.y - fromPos.y) * easeProgress;
                    
                    try {
                        nodes.update({
                            id: packetId,
                            x: currentX,
                            y: currentY
                        });
                    } catch (e) {
                        // ãƒãƒ¼ãƒ‰ãŒæ—¢ã«å‰Šé™¤ã•ã‚Œã¦ã„ã‚‹å ´åˆ
                        clearInterval(packetInterval);
                        resolve();
                        return;
                    }
                    
                    if (progress >= 1) {
                        clearInterval(packetInterval);
                        // ãƒ‘ã‚±ãƒƒãƒˆã‚’å‰Šé™¤
                        try {
                            nodes.remove(packetId);
                        } catch (e) {
                            // ãƒãƒ¼ãƒ‰ãŒæ—¢ã«å‰Šé™¤ã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã‚¨ãƒ©ãƒ¼ã‚’ç„¡è¦–
                        }
                        resolve();
                    }
                }, 16); // 60FPS
            });
        }

        // é€šä¿¡ãƒ­ã‚°ã«è¿½åŠ 
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('communication-log');
            const logItem = document.createElement('div');
            logItem.className = `log-item ${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            logItem.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${message}`;
            
            logContainer.appendChild(logItem);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒƒãƒ—ã‚’æº–å‚™
        function prepareAnimationSteps() {
            const clientPos = network.getPositions(['client'])['client'];
            const routerPos = network.getPositions(['router'])['router'];
            const internetPos = network.getPositions(['internet'])['internet'];
            const dnsPos = network.getPositions(['dns'])['dns'];
            const serverPos = network.getPositions(['server'])['server'];

            const dnsQueryId = `dns-query-${++packetCounter}`;
            const dnsResponseId = `dns-response-${packetCounter}`;
            const requestId = `http-request-${++packetCounter}`;
            const responseId = `http-response-${packetCounter}`;

            animationSteps = [
                // DNSè§£æ±ºãƒ•ã‚§ãƒ¼ã‚º
                { type: 'log', message: 'ğŸ” ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ: example.com ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è§£æ±ºä¸­...', logType: 'dns' },
                
                // DNS Query steps
                { type: 'packet', id: dnsQueryId + '-1', label: 'DNS Query\nexample.com', from: clientPos, to: routerPos, color: '#7c3aed' },
                { type: 'packet', id: dnsQueryId + '-2', label: 'DNS Query\nexample.com', from: routerPos, to: internetPos, color: '#7c3aed' },
                { type: 'packet', id: dnsQueryId + '-3', label: 'DNS Query\nexample.com', from: internetPos, to: dnsPos, color: '#7c3aed' },
                
                { type: 'log', message: 'ğŸ” DNSã‚µãƒ¼ãƒãƒ¼: ãƒ‰ãƒ¡ã‚¤ãƒ³åã‚’è§£æ±ºä¸­...', logType: 'processing' },
                { type: 'log', message: 'ğŸ” DNSã‚µãƒ¼ãƒãƒ¼: IPã‚¢ãƒ‰ãƒ¬ã‚¹ 192.168.1.100 ã‚’è¿”é€', logType: 'dns' },
                
                // DNS Response steps
                { type: 'packet', id: dnsResponseId + '-1', label: 'DNS Response\n192.168.1.100', from: dnsPos, to: internetPos, color: '#a855f7' },
                { type: 'packet', id: dnsResponseId + '-2', label: 'DNS Response\n192.168.1.100', from: internetPos, to: routerPos, color: '#a855f7' },
                { type: 'packet', id: dnsResponseId + '-3', label: 'DNS Response\n192.168.1.100', from: routerPos, to: clientPos, color: '#a855f7' },
                
                { type: 'log', message: 'âœ… ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ: DNSè§£æ±ºå®Œäº† (example.com â†’ 192.168.1.100)', logType: 'success' },
                
                // HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ•ã‚§ãƒ¼ã‚º
                { type: 'log', message: 'ğŸ”µ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ: HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ä¸­...', logType: 'request' },
                
                // HTTP Request steps
                { type: 'packet', id: requestId + '-1', label: 'GET /index.html\nHost: example.com', from: clientPos, to: routerPos, color: '#2563eb' },
                { type: 'log', message: 'ğŸŒ ãƒ«ãƒ¼ã‚¿ãƒ¼: HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è»¢é€ä¸­...', logType: 'info' },
                { type: 'packet', id: requestId + '-2', label: 'GET /index.html\nHost: example.com', from: routerPos, to: internetPos, color: '#2563eb' },
                { type: 'log', message: 'â˜ï¸ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆ: ãƒ‘ã‚±ãƒƒãƒˆã‚’ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ä¸­...', logType: 'info' },
                { type: 'packet', id: requestId + '-3', label: 'GET /index.html\nHost: example.com', from: internetPos, to: serverPos, color: '#2563eb' },
                
                // ã‚µãƒ¼ãƒãƒ¼å‡¦ç†
                { type: 'log', message: 'ğŸ–¥ï¸ Webã‚µãƒ¼ãƒãƒ¼: ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†ä¸­...', logType: 'processing' },
                
                // HTTPãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ•ã‚§ãƒ¼ã‚º
                { type: 'log', message: 'ğŸ”´ Webã‚µãƒ¼ãƒãƒ¼: HTTPãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’é€ä¿¡ä¸­...', logType: 'response' },
                
                // HTTP Response steps
                { type: 'packet', id: responseId + '-1', label: '200 OK\nHTML Data', from: serverPos, to: internetPos, color: '#dc2626' },
                { type: 'log', message: 'â˜ï¸ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆ: ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ä¸­...', logType: 'info' },
                { type: 'packet', id: responseId + '-2', label: '200 OK\nHTML Data', from: internetPos, to: routerPos, color: '#dc2626' },
                { type: 'log', message: 'ğŸŒ ãƒ«ãƒ¼ã‚¿ãƒ¼: ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è»¢é€ä¸­...', logType: 'info' },
                { type: 'packet', id: responseId + '-3', label: '200 OK\nHTML Data', from: routerPos, to: clientPos, color: '#dc2626' },
                
                { type: 'log', message: 'âœ… ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ: Webãƒšãƒ¼ã‚¸ã®è¡¨ç¤ºãŒå®Œäº†ã—ã¾ã—ãŸï¼', logType: 'success' }
            ];

            totalSteps = animationSteps.length;
            currentStep = 0;
        }

        // ã‚¹ãƒ†ãƒƒãƒ—ã‚’å®Ÿè¡Œ
        async function executeStep(stepIndex, isReverse = false) {
            if (stepIndex < 0 || stepIndex >= animationSteps.length) return;
            
            const step = animationSteps[stepIndex];
            
            if (step.type === 'log') {
                if (!isReverse) {
                    addLog(step.message, step.logType);
                } else {
                    // æˆ»ã‚‹å ´åˆã¯ãƒ­ã‚°ã‚’å‰Šé™¤ï¼ˆæœ€å¾Œã®ãƒ­ã‚°ã‚¨ãƒ³ãƒˆãƒªã‚’å‰Šé™¤ï¼‰
                    const logContainer = document.getElementById('communication-log');
                    const lastLog = logContainer.lastElementChild;
                    if (lastLog && lastLog.classList.contains('log-item')) {
                        logContainer.removeChild(lastLog);
                    }
                }
            } else if (step.type === 'packet') {
                if (!isReverse) {
                    // ãƒ‘ã‚±ãƒƒãƒˆã‚’ä½œæˆã—ã¦ç§»å‹•ï¼ˆæ—¢å­˜ãƒã‚§ãƒƒã‚¯ä»˜ãï¼‰
                    try {
                        // æ—¢ã«å­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                        const existingNode = nodes.get(step.id);
                        if (!existingNode) {
                            const packet = createPacket(step.id, step.label, step.from, step.to, step.color);
                            nodes.add(packet);
                            await movePacket(step.id, step.from, step.to, isManualMode ? 800 : 1000);
                        }
                    } catch (e) {
                        console.warn(`ãƒ‘ã‚±ãƒƒãƒˆ ${step.id} ã®ä½œæˆã§ã‚¨ãƒ©ãƒ¼:`, e);
                    }
                } else {
                    // æˆ»ã‚‹å ´åˆã¯é€†ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œ
                    try {
                        // ãƒ‘ã‚±ãƒƒãƒˆãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆã—ã¦é€†æ–¹å‘ã«ç§»å‹•
                        const existingNode = nodes.get(step.id);
                        if (!existingNode) {
                            const packet = createPacket(step.id, step.label, step.to, step.from, step.color);
                            nodes.add(packet);
                            // é€†æ–¹å‘ã«ç§»å‹•ï¼ˆto -> fromï¼‰
                            await movePacket(step.id, step.to, step.from, 800);
                        } else {
                            // æ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯ãã®ã¾ã¾å‰Šé™¤
                            nodes.remove(step.id);
                        }
                    } catch (e) {
                        console.warn(`ãƒ‘ã‚±ãƒƒãƒˆ ${step.id} ã®æˆ»ã—ã§ã‚¨ãƒ©ãƒ¼:`, e);
                    }
                }
            }
        }

        // HTTPé€šä¿¡ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
        async function simulateHttpCommunication() {
            if (!isManualMode) {
                // è‡ªå‹•ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯å¾“æ¥é€šã‚Š
                prepareAnimationSteps();
                for (let i = 0; i < animationSteps.length; i++) {
                    if (!isAnimating) break;
                    await executeStep(i);
                    if (animationSteps[i].type === 'log' && animationSteps[i].logType === 'processing') {
                        await new Promise(resolve => setTimeout(resolve, 800));
                    }
                }
            }
        }

        // é€šä¿¡é–‹å§‹
        async function startCommunication() {
            if (isAnimating) return;
            
            // ãƒªã‚»ãƒƒãƒˆã—ã¦ã‹ã‚‰é–‹å§‹
            resetNetwork();
            
            isAnimating = true;
            isManualMode = false;
            document.getElementById('start-communication').disabled = true;
            document.getElementById('step-forward').disabled = true;
            document.getElementById('step-backward').disabled = true;
            
            addLog('ğŸš€ HTTPé€šä¿¡ã‚’é–‹å§‹ã—ã¾ã™...', 'info');
            
            try {
                await simulateHttpCommunication();
                
                // é€£ç¶šå®Ÿè¡Œã®å ´åˆ
                if (isAnimating) {
                    animationInterval = setTimeout(() => {
                        if (isAnimating) {
                            startCommunication();
                        }
                    }, 3000);
                }
            } catch (error) {
                console.error('Animation error:', error);
                addLog('âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            } finally {
                if (!animationInterval) {
                    isAnimating = false;
                    document.getElementById('start-communication').disabled = false;
                    document.getElementById('step-forward').disabled = false;
                    document.getElementById('step-backward').disabled = false;
                }
            }
        }

        // é€šä¿¡åœæ­¢
        function stopCommunication() {
            isAnimating = false;
            isManualMode = true;
            if (animationInterval) {
                clearTimeout(animationInterval);
                animationInterval = null;
            }
            document.getElementById('start-communication').disabled = false;
            document.getElementById('step-forward').disabled = false;
            document.getElementById('step-backward').disabled = false;
            addLog('â¹ï¸ é€šä¿¡ã‚’åœæ­¢ã—ã¾ã—ãŸï¼ˆæ‰‹å‹•ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆï¼‰', 'info');
            
            // ã‚¹ãƒ†ãƒƒãƒ—ãŒæº–å‚™ã•ã‚Œã¦ã„ãªã„å ´åˆã¯æº–å‚™
            if (animationSteps.length === 0) {
                prepareAnimationSteps();
            }
        }

        // æ‰‹å‹•ã§æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã«é€²ã‚€
        async function stepForward() {
            // ã‚¹ãƒ†ãƒƒãƒ—ãŒæº–å‚™ã•ã‚Œã¦ã„ãªã„å ´åˆã¯æº–å‚™
            if (animationSteps.length === 0) {
                prepareAnimationSteps();
                addLog('ğŸ“‹ æ‰‹å‹•ãƒ¢ãƒ¼ãƒ‰ã§ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã—ã¾ã™', 'info');
                isManualMode = true;
            }
            
            if (currentStep >= totalSteps) {
                addLog('ğŸ¯ å…¨ã¦ã®ã‚¹ãƒ†ãƒƒãƒ—ãŒæ—¢ã«å®Œäº†ã—ã¦ã„ã¾ã™', 'info');
                return;
            }
            
            // é‡è¤‡å®Ÿè¡Œã®é˜²æ­¢
            const button = document.getElementById('step-forward');
            if (button.disabled) return;
            
            button.disabled = true;
            
            try {
                await executeStep(currentStep);
                currentStep++;
                
                // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
                document.getElementById('step-backward').disabled = currentStep === 0;
                document.getElementById('step-forward').disabled = currentStep >= totalSteps;
                
                if (currentStep >= totalSteps) {
                    addLog('ğŸ¯ å…¨ã¦ã®ã‚¹ãƒ†ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸ', 'success');
                }
            } finally {
                // ãƒœã‚¿ãƒ³ã‚’å†æœ‰åŠ¹åŒ–ï¼ˆå®Œäº†ã—ã¦ã„ãªã„å ´åˆã®ã¿ï¼‰
                if (currentStep < totalSteps) {
                    button.disabled = false;
                }
            }
        }

        // æ‰‹å‹•ã§å‰ã®ã‚¹ãƒ†ãƒƒãƒ—ã«æˆ»ã‚‹
        async function stepBackward() {
            if (currentStep <= 0) {
                addLog('ğŸ”™ æ—¢ã«æœ€åˆã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã™', 'info');
                return;
            }
            
            // é‡è¤‡å®Ÿè¡Œã®é˜²æ­¢
            const button = document.getElementById('step-backward');
            if (button.disabled) return;
            
            button.disabled = true;
            
            try {
                // ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’1ã¤æˆ»ã—ã¦ã€ãã®ã‚¹ãƒ†ãƒƒãƒ—ã®é€†æ“ä½œã‚’å®Ÿè¡Œ
                currentStep--;
                const step = animationSteps[currentStep];
                
                if (step.type === 'log') {
                    // ãƒ­ã‚°ã®å‰Šé™¤
                    const logContainer = document.getElementById('communication-log');
                    const lastLog = logContainer.lastElementChild;
                    if (lastLog && lastLog.classList.contains('log-item')) {
                        logContainer.removeChild(lastLog);
                    }
                } else if (step.type === 'packet') {
                    // ãƒ‘ã‚±ãƒƒãƒˆã®é€†ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                    try {
                        // ãƒ‘ã‚±ãƒƒãƒˆã‚’ä½œæˆã—ã¦é€†æ–¹å‘ã«ç§»å‹•
                        const packet = createPacket(step.id + '-reverse', step.label, step.to, step.from, step.color);
                        nodes.add(packet);
                        await movePacket(step.id + '-reverse', step.to, step.from, 800);
                        
                        // å…ƒã®ãƒ‘ã‚±ãƒƒãƒˆã‚‚å‰Šé™¤ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
                        try {
                            nodes.remove(step.id);
                        } catch (e) {
                            // å…ƒã®ãƒ‘ã‚±ãƒƒãƒˆãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ç„¡è¦–
                        }
                    } catch (e) {
                        console.warn(`ãƒ‘ã‚±ãƒƒãƒˆ ${step.id} ã®é€†ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã§ã‚¨ãƒ©ãƒ¼:`, e);
                    }
                }
                
                // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
                document.getElementById('step-backward').disabled = currentStep === 0;
                document.getElementById('step-forward').disabled = currentStep >= totalSteps;
                
                addLog(`âª ã‚¹ãƒ†ãƒƒãƒ— ${currentStep + 1} ã«æˆ»ã‚Šã¾ã—ãŸ`, 'info');
            } finally {
                // ãƒœã‚¿ãƒ³ã‚’å†æœ‰åŠ¹åŒ–ï¼ˆæœ€åˆã§ãªã„å ´åˆã®ã¿ï¼‰
                if (currentStep > 0) {
                    button.disabled = false;
                }
            }
        }

        // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒªã‚»ãƒƒãƒˆ
        function resetNetwork() {
            stopCommunication();
            
            // ãƒ‘ã‚±ãƒƒãƒˆãƒãƒ¼ãƒ‰ã®ã¿ã‚’å‰Šé™¤ï¼ˆDNSã‚µãƒ¼ãƒãƒ¼ãªã©ã®å›ºå®šãƒãƒ¼ãƒ‰ã¯æ®‹ã™ï¼‰
            const allNodes = nodes.get();
            const packetNodes = allNodes.filter(node => 
                node.id.includes('request') || node.id.includes('response') || 
                (node.id.includes('dns') && (node.id.includes('query') || node.id.includes('response')))
            );
            
            packetNodes.forEach(packet => {
                try {
                    nodes.remove(packet.id);
                } catch (e) {
                    // æ—¢ã«å‰Šé™¤æ¸ˆã¿ã®å ´åˆã¯ç„¡è¦–
                }
            });
            
            // ã‚¹ãƒ†ãƒƒãƒ—ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
            packetCounter = 0;
            currentStep = 0;
            totalSteps = 0;
            animationSteps = [];
            isManualMode = false;
            
            // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('start-communication').disabled = false;
            document.getElementById('step-forward').disabled = false;
            document.getElementById('step-backward').disabled = true;
            
            addLog('ğŸ”„ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ', 'info');
        }

        // ãƒ­ã‚°ã‚¯ãƒªã‚¢
        function clearLog() {
            const logContainer = document.getElementById('communication-log');
            logContainer.innerHTML = '<div class="log-item">ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚</div>';
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
        document.addEventListener('DOMContentLoaded', () => {
            // Vis.jsã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’èª­ã¿è¾¼ã¿
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/vis-network/standalone/umd/vis-network.min.js';
            script.onload = () => {
                initNetwork();
                addLog('ğŸ“¡ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãŒåˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸ', 'success');
            };
            script.onerror = () => {
                addLog('âŒ Vis.jsãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            };
            document.head.appendChild(script);

            // ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
            document.getElementById('start-communication').addEventListener('click', startCommunication);
            document.getElementById('stop-communication').addEventListener('click', stopCommunication);
            document.getElementById('step-forward').addEventListener('click', stepForward);
            document.getElementById('step-backward').addEventListener('click', stepBackward);
            document.getElementById('reset-network').addEventListener('click', resetNetwork);
            document.getElementById('clear-log').addEventListener('click', clearLog);
        });
    </script>

    <style>
        .network-simulator {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .simulator-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .simulator-header h1 {
            color: #2563eb;
            margin-bottom: 10px;
            font-size: clamp(1.4rem, 4vw, 2.25rem);
        }

        .simulator-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px 15px;
            background: #f8fafc;
            border-radius: 8px;
            border-left: 4px solid #2563eb;
            flex-wrap: wrap;
            gap: 10px;
        }

        .section-header h3 {
            margin: 0;
            color: #1e293b;
            font-size: clamp(1rem, 2.5vw, 1.25rem);
        }

        .controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        #network-container {
            width: 100%;
            height: 400px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: #ffffff;
        }

        #communication-log {
            height: 300px;
            padding: 15px;
            background: #1e293b;
            color: #e2e8f0;
            border-radius: 8px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 12px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .log-item {
            margin-bottom: 8px;
            padding: 4px 0;
            border-bottom: 1px solid #334155;
        }

        .log-item:last-child {
            border-bottom: none;
        }

        .log-item.request {
            color: #60a5fa;
        }

        .log-item.response {
            color: #f87171;
        }

        .log-item.processing {
            color: #fbbf24;
        }

        .log-item.success {
            color: #34d399;
        }

        .log-item.error {
            color: #ef4444;
        }

        .log-item.info {
            color: #a1a1aa;
        }

        .log-item.dns {
            color: #c084fc;
        }

        .timestamp {
            color: #64748b;
            font-size: 10px;
        }

        .network-info {
            background: #f0f9ff;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #0ea5e9;
        }

        .network-info h4 {
            color: #0c4a6e;
            margin-bottom: 15px;
        }

        .network-info ul {
            list-style: none;
            padding: 0;
        }

        .network-info li {
            padding: 8px 0;
            border-bottom: 1px solid #bae6fd;
        }

        .network-info li:last-child {
            border-bottom: none;
        }

        .explanation-section {
            background: #f8fafc;
            padding: 30px;
            border-radius: 12px;
            border-left: 4px solid #10b981;
        }

        .explanation-section h3 {
            color: #1e293b;
            margin-bottom: 20px;
            text-align: center;
        }

        .explanation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .explanation-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .explanation-card h4 {
            color: #2563eb;
            margin-bottom: 10px;
        }

        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.875rem;
            white-space: nowrap;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #2563eb;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #1d4ed8;
        }

        .btn-secondary {
            background: #64748b;
            color: white;
        }

        .btn-secondary:hover {
            background: #475569;
        }

        .btn-outline {
            background: transparent;
            color: #64748b;
            border: 1px solid #d1d5db;
        }

        .btn-outline:hover {
            background: #f9fafb;
            border-color: #9ca3af;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
        @media (max-width: 1024px) {
            .simulator-content {
                grid-template-columns: 1fr;
            }
            
            #network-container {
                height: 350px;
            }
        }

        @media (max-width: 768px) {
            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
            
            .controls {
                width: 100%;
                justify-content: center;
            }
            
            .explanation-grid {
                grid-template-columns: 1fr;
            }
            
            #communication-log {
                height: 250px;
            }
        }
    </style>
</Layout>