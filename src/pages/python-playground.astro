---
// python-playground.astro
import Layout from '../layouts/Layout.astro';
---

<Layout title="Python ãƒ—ãƒ¬ã‚¤ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰">
    <div class="python-playground">
        <div class="playground-header">
            <h1>ğŸ Python ãƒ—ãƒ¬ã‚¤ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰</h1>
            <p>ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã§Pythonã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã¿ã‚ˆã†ï¼</p>
        </div>

        <div class="playground-content">
            <div class="code-section">
                <div class="section-header">
                    <h3>ğŸ“ ã‚³ãƒ¼ãƒ‰ã‚¨ãƒ‡ã‚£ã‚¿</h3>
                    <div class="controls">
                        <button id="run-btn" class="btn btn-primary" disabled>
                            â–¶ï¸ å®Ÿè¡Œ
                        </button>
                        <button id="clear-btn" class="btn btn-secondary">
                            ğŸ—‘ï¸ ã‚¯ãƒªã‚¢
                        </button>
                        <button id="example-btn" class="btn btn-secondary">
                            ğŸ“š ã‚µãƒ³ãƒ—ãƒ«
                        </button>
                        <button id="save-btn" class="btn btn-success">
                            ğŸ’¾ ä¿å­˜
                        </button>
                        <button id="load-btn" class="btn btn-info">
                            ğŸ“‚ èª­è¾¼
                        </button>
                        <input type="file" id="file-input" accept=".py" style="display: none;">
                    </div>
                </div>
                <div id="code-editor-container">
                    <div id="code-editor"></div>
                </div>
            </div>

            <div class="output-section">
                <div class="section-header">
                    <h3>ğŸ“¤ å®Ÿè¡Œçµæœ</h3>
                    <div class="status">
                        <label class="error-lang-toggle">
                            <input type="checkbox" id="japanese-error-toggle" checked>
                            <span>ã‚¨ãƒ©ãƒ¼ã‚’æ—¥æœ¬èªåŒ–ã™ã‚‹</span>
                        </label>
                        <span id="python-status">Pythonã‚¨ãƒ³ã‚¸ãƒ³ã‚’èª­ã¿è¾¼ã¿ä¸­...</span>
                    </div>
                </div>
                <div id="output-area">
                    <div class="loading">
                        ğŸ”„ Pyodideã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„
                    </div>
                </div>
            </div>
        </div>

        <div class="debug-panels">
            <div class="debug-panel">
                <div class="debug-header">
                    <h3>ğŸ” å¤‰æ•°ãƒˆãƒ©ãƒƒã‚«ãƒ¼</h3>
                </div>
                <div id="variable-tracker" class="debug-content">
                    <div class="debug-empty">å¤‰æ•°ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>
                </div>
            </div>

            <div class="debug-panel">
                <div class="debug-header">
                    <h3>ğŸ”„ ãƒ«ãƒ¼ãƒ—å®Ÿè¡Œã‚«ã‚¦ãƒ³ã‚¿ãƒ¼</h3>
                </div>
                <div id="loop-tracker" class="debug-content">
                    <div class="debug-empty">ãƒ«ãƒ¼ãƒ—ã¯ã¾ã å®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã›ã‚“</div>
                </div>
            </div>

            <div class="debug-panel">
                <div class="debug-header">
                    <h3>ğŸ” å†å¸°ãƒˆãƒ©ãƒƒã‚«ãƒ¼</h3>
                </div>
                <div id="recursion-tracker" class="debug-content">
                    <div class="debug-empty">å†å¸°é–¢æ•°ã¯ã¾ã å‘¼ã°ã‚Œã¦ã„ã¾ã›ã‚“</div>
                </div>
            </div>
        </div>

        <div class="help-section">
            <h3>ğŸ’¡ ä½¿ã„æ–¹</h3>
            <ul>
                <li><strong>print()</strong>: æ–‡å­—åˆ—ã‚„å€¤ã‚’å‡ºåŠ›ã—ã¾ã™</li>
                <li><strong>input()</strong>: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®å…¥åŠ›ã‚’å—ã‘å–ã‚Šã¾ã™</li>
                <li><strong>å¤‰æ•°</strong>: name = "å€¤" ã§å¤‰æ•°ã‚’å®šç¾©ã§ãã¾ã™</li>
                <li><strong>è¨ˆç®—</strong>: +, -, *, / ãªã©ã®æ¼”ç®—å­ãŒä½¿ãˆã¾ã™</li>
                <li><strong>ç¹°ã‚Šè¿”ã—</strong>: foræ–‡ã‚„whileæ–‡ãŒä½¿ãˆã¾ã™</li>
            </ul>
        </div>
    </div>

    <!-- CodeMirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/material-darker.min.css">
    
    <script>
        let pyodide = null;
        let inputQueue = [];
        let isWaitingForInput = false;
        let inputResolver = null;
        let codeEditor = null;
        let variableState = {};
        let loopCounts = {};
        let recursionData = {};
        let outputLineCount = 0;
        const MAX_OUTPUT_LINES = 10000; // æœ€å¤§å‡ºåŠ›è¡Œæ•°

        // CodeMirrorã®èª­ã¿è¾¼ã¿ã¨åˆæœŸåŒ–
        async function initCodeEditor() {
            try {
                // CodeMirrorã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’èª­ã¿è¾¼ã¿
                await loadScript('https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js');
                await loadScript('https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js');
                await loadScript('https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closebrackets.min.js');
                await loadScript('https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/matchbrackets.min.js');
                await loadScript('https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/selection/active-line.min.js');
                
                // CodeMirrorã‚¨ãƒ‡ã‚£ã‚¿ã‚’åˆæœŸåŒ–
                const editorElement = document.getElementById('code-editor');
                codeEditor = CodeMirror(editorElement, {
                    value: '',
                    mode: 'python',
                    theme: 'material-darker',
                    lineNumbers: true,
                    indentUnit: 4,
                    indentWithTabs: false,
                    autoCloseBrackets: true,
                    matchBrackets: true,
                    styleActiveLine: true,
                    lineWrapping: true,
                    viewportMargin: Infinity,
                    extraKeys: {
                        "Ctrl-Enter": function(cm) {
                            runCode();
                        },
                        "Tab": function(cm) {
                            // Tabã‚­ãƒ¼ã§ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆ
                            if (cm.somethingSelected()) {
                                cm.indentSelection("add");
                            } else {
                                cm.replaceSelection("    "); // 4ã‚¹ãƒšãƒ¼ã‚¹
                            }
                        },
                        "Shift-Tab": function(cm) {
                            // Shift+Tabã§ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆè§£é™¤
                            cm.indentSelection("subtract");
                        }
                    }
                });
                
                // ã‚¨ãƒ‡ã‚£ã‚¿ã®ã‚µã‚¤ã‚ºã‚’å¼·åˆ¶çš„ã«èª¿æ•´
                setTimeout(() => {
                    const isMobile = window.innerWidth <= 768;
                    const height = isMobile ? 350 : 400;
                    codeEditor.setSize(null, height);
                    codeEditor.refresh();
                }, 100);
                
                // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºæ™‚ã«é«˜ã•ã‚’å†èª¿æ•´
                window.addEventListener('resize', () => {
                    setTimeout(() => {
                        const isMobile = window.innerWidth <= 768;
                        const height = isMobile ? 350 : 400;
                        codeEditor.setSize(null, height);
                        codeEditor.refresh();
                    }, 100);
                });
                
                console.log('CodeMirror editor initialized');
                
            } catch (error) {
                console.error('Failed to initialize CodeMirror:', error);
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: é€šå¸¸ã®textareaã‚’ä½¿ç”¨
                document.getElementById('code-editor').innerHTML = '<textarea id="fallback-editor" style="width:100%;height:400px;font-family:monospace;"></textarea>';
            }
        }

        // ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿ç”¨ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        // Pyodideã®èª­ã¿è¾¼ã¿
        async function loadPyodide() {
            try {
                const statusElement = document.getElementById('python-status');
                const outputArea = document.getElementById('output-area');
                
                statusElement.textContent = 'Pythonã‚¨ãƒ³ã‚¸ãƒ³ã‚’åˆæœŸåŒ–ä¸­...';
                
                // Pyodideã‚’CDNã‹ã‚‰èª­ã¿è¾¼ã¿
                if (!window.loadPyodide) {
                    await loadScript('https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js');
                }

                statusElement.textContent = 'Pythonç’°å¢ƒã‚’æ§‹ç¯‰ä¸­...';

                // Pyodideã‚’åˆæœŸåŒ–ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ã®loadPyodideé–¢æ•°ã‚’ä½¿ç”¨ï¼‰
                pyodide = await window.loadPyodide({
                    indexURL: "https://cdn.jsdelivr.net/pyodide/v0.24.1/full/",
                    stdout: (text) => {
                        // ãƒ†ã‚­ã‚¹ãƒˆã‚’æ”¹è¡Œã§åˆ†å‰²ã—ã¦1è¡Œãšã¤è¿½åŠ 
                        const lines = text.split('\n');
                        for (let i = 0; i < lines.length; i++) {
                            if (i === lines.length - 1 && lines[i] === '') continue;
                            appendOutput(lines[i], 'stdout');
                        }
                    },
                    stderr: (text) => {
                        const lines = text.split('\n');
                        for (let i = 0; i < lines.length; i++) {
                            if (i === lines.length - 1 && lines[i] === '') continue;
                            appendOutput(lines[i], 'stderr');
                        }
                    }
                });

                // stdoutã®ãƒãƒƒãƒ•ã‚¡ãƒªãƒ³ã‚°ã‚’ç„¡åŠ¹åŒ–
                pyodide.runPython(`
import sys
import io

class UnbufferedTextIO(io.TextIOWrapper):
    def write(self, s):
        super().write(s)
        self.flush()
        return len(s)

sys.stdout = UnbufferedTextIO(sys.stdout.buffer, encoding='utf-8', line_buffering=False)
sys.stderr = UnbufferedTextIO(sys.stderr.buffer, encoding='utf-8', line_buffering=False)
                `);

                console.log('Pyodide loaded successfully');

                // inputé–¢æ•°ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰
                pyodide.runPython(`
import builtins
from js import prompt

def custom_input(prompt_text=""):
    result = prompt(str(prompt_text))
    return result if result is not None else ""

# çµ„ã¿è¾¼ã¿ã®inputé–¢æ•°ã‚’ç½®ãæ›ãˆ
builtins.input = custom_input
                `);

                statusElement.textContent = 'âœ… Pythonæº–å‚™å®Œäº†';
                outputArea.innerHTML = '<div class="ready">Pythonç’°å¢ƒãŒæº–å‚™ã§ãã¾ã—ãŸï¼ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚</div>';
                
                // å®Ÿè¡Œãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
                document.getElementById('run-btn').disabled = false;
                
            } catch (error) {
                console.error('Pyodideèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                const statusElement = document.getElementById('python-status');
                const outputArea = document.getElementById('output-area');
                statusElement.textContent = 'âŒ èª­ã¿è¾¼ã¿å¤±æ•—';
                outputArea.innerHTML = `<div class="error">Pythonã‚¨ãƒ³ã‚¸ãƒ³ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br>ã‚¨ãƒ©ãƒ¼: ${error.message}<br>ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ã¿ã¦ãã ã•ã„ã€‚</div>`;
            }
        }

        // å‡ºåŠ›ã‚¨ãƒªã‚¢ã«ãƒ†ã‚­ã‚¹ãƒˆã‚’è¿½åŠ ï¼ˆ1è¡Œãšã¤ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ï¼‰
        function appendOutput(text, type = 'stdout') {
            const outputArea = document.getElementById('output-area');

            // æœ€å¤§è¡Œæ•°ãƒã‚§ãƒƒã‚¯
            if (outputLineCount >= MAX_OUTPUT_LINES) {
                if (outputLineCount === MAX_OUTPUT_LINES) {
                    const warningLine = document.createElement('div');
                    warningLine.className = 'output-line info';
                    warningLine.textContent = `\nâš ï¸ å‡ºåŠ›ãŒ${MAX_OUTPUT_LINES}è¡Œã‚’è¶…ãˆã¾ã—ãŸã€‚ã“ã‚Œä»¥ä¸Šã®å‡ºåŠ›ã¯çœç•¥ã•ã‚Œã¾ã™ã€‚`;
                    outputArea.appendChild(warningLine);
                    outputLineCount++;
                }
                return;
            }

            // ã€Œå®Ÿè¡Œä¸­...ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æœ€åˆã®å‡ºåŠ›ã§å‰Šé™¤
            const runningMsg = outputArea.querySelector('.running-msg');
            if (runningMsg) {
                runningMsg.remove();
            }

            if (outputArea.querySelector('.loading') || outputArea.querySelector('.ready')) {
                outputArea.innerHTML = '';
            }

            // 1è¡Œãšã¤å³åº§ã«è¿½åŠ 
            const outputLine = document.createElement('div');
            outputLine.className = `output-line ${type}`;
            outputLine.textContent = text;
            outputArea.appendChild(outputLine);

            outputLineCount++;

            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¯é©åº¦ã«ï¼ˆ100è¡Œã”ã¨ï¼‰
            if (outputLineCount % 100 === 0) {
                outputArea.scrollTop = outputArea.scrollHeight;
            }
        }

        // å¤‰æ•°ãƒˆãƒ©ãƒƒã‚«ãƒ¼ã®æ›´æ–°
        function updateVariableTracker(variables) {
            const tracker = document.getElementById('variable-tracker');
            if (Object.keys(variables).length === 0) {
                tracker.innerHTML = '<div class="debug-empty">å¤‰æ•°ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            let html = '<div class="variable-list">';
            for (const [name, value] of Object.entries(variables)) {
                const valueStr = JSON.stringify(value);
                const typeStr = typeof value;
                html += `
                    <div class="variable-item">
                        <span class="var-name">${name}</span>
                        <span class="var-type">${typeStr}</span>
                        <span class="var-value">${valueStr}</span>
                    </div>
                `;
            }
            html += '</div>';
            tracker.innerHTML = html;
        }

        // ãƒ«ãƒ¼ãƒ—ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã®æ›´æ–°
        function updateLoopTracker(counts, codeLines, loopIterations) {
            const tracker = document.getElementById('loop-tracker');
            if (Object.keys(counts).length === 0) {
                tracker.innerHTML = '<div class="debug-empty">ãƒ«ãƒ¼ãƒ—ã¯ã¾ã å®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
                return;
            }

            let html = '<div class="loop-list">';

            // ãƒ«ãƒ¼ãƒ—ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
            const loopGroups = {};
            for (const [line, count] of Object.entries(counts)) {
                // ã“ã®è¡ŒãŒã©ã®ãƒ«ãƒ¼ãƒ—ã«å±ã™ã‚‹ã‹æ¢ã™
                let belongsToLoop = null;
                for (const loopLine of Object.keys(loopIterations)) {
                    const loopLineNum = parseInt(loopLine);
                    const currentLineNum = parseInt(line);
                    if (currentLineNum > loopLineNum) {
                        belongsToLoop = loopLine;
                    }
                }

                if (!belongsToLoop) {
                    // ãƒ«ãƒ¼ãƒ—è¡Œã‹ã‚‰æœ€ã‚‚è¿‘ã„ãƒ«ãƒ¼ãƒ—ã‚’æ¢ã™
                    const sortedLoops = Object.keys(loopIterations).map(Number).sort((a, b) => a - b);
                    for (const loopLine of sortedLoops) {
                        if (loopLine < parseInt(line)) {
                            belongsToLoop = loopLine.toString();
                        }
                    }
                }

                if (belongsToLoop) {
                    if (!loopGroups[belongsToLoop]) {
                        loopGroups[belongsToLoop] = [];
                    }
                    loopGroups[belongsToLoop].push([line, count]);
                }
            }

            // ãƒ«ãƒ¼ãƒ—ã”ã¨ã«è¡¨ç¤º
            for (const [loopLine, lines] of Object.entries(loopGroups)) {
                const loopLineNum = parseInt(loopLine);
                const loopCodeSnippet = codeLines[loopLineNum - 1] || '';
                const iterations = loopIterations[loopLine]?.iterations || 0;

                html += `
                    <div class="loop-group">
                        <div class="loop-header">
                            <span class="loop-header-line">è¡Œ ${loopLine}</span>
                            <span class="loop-iteration-count">ğŸ”„ ${iterations}å›ãƒ«ãƒ¼ãƒ—</span>
                        </div>
                        <div class="loop-header-code">${escapeHtml(loopCodeSnippet.trim())}</div>
                `;

                // è¡Œç•ªå·ã§ã‚½ãƒ¼ãƒˆ
                const sortedLines = lines.sort((a, b) => parseInt(a[0]) - parseInt(b[0]));
                const maxCount = Math.max(...lines.map(l => l[1]));

                for (const [line, count] of sortedLines) {
                    const lineNum = parseInt(line);
                    const codeSnippet = codeLines[lineNum - 1] || '';
                    const trimmedCode = codeSnippet.trim();
                    const percentage = (count / maxCount) * 100;
                    const dots = 'â—'.repeat(Math.min(count, 10)) + (count > 10 ? '...' : '');

                    html += `
                        <div class="loop-item">
                            <div class="loop-info">
                                <span class="loop-line">è¡Œ ${line}</span>
                                <span class="loop-iterations">${dots}</span>
                                <span class="loop-count">${count}å›</span>
                            </div>
                            <div class="loop-progress-bar">
                                <div class="loop-progress-fill" style="width: ${percentage}%"></div>
                            </div>
                            <div class="loop-code">${escapeHtml(trimmedCode)}</div>
                        </div>
                    `;
                }

                html += '</div>';
            }

            html += '</div>';
            tracker.innerHTML = html;
        }

        // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Pythonã‚¨ãƒ©ãƒ¼ã‚’æ—¥æœ¬èªã«ç¿»è¨³
        function translatePythonError(errorMessage) {
            // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡Œã”ã¨ã«å‡¦ç†
            const lines = errorMessage.split('\n');
            const translatedLines = [];

            for (let line of lines) {
                let translatedLine = line;

                // ã‚ˆãã‚ã‚‹ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ—¥æœ¬èªåŒ–
                const errorPatterns = [
                    // SyntaxErrorç³»ï¼ˆè©³ç´°ç‰ˆï¼‰
                    { pattern: /SyntaxError: invalid syntax\. Perhaps you forgot a comma\?/i, replacement: 'æ–‡æ³•ã‚¨ãƒ©ãƒ¼: ã‚«ãƒ³ãƒï¼ˆ,ï¼‰ã‚’å¿˜ã‚Œã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿ' },
                    { pattern: /SyntaxError: expected ':'/i, replacement: 'æ–‡æ³•ã‚¨ãƒ©ãƒ¼: ã‚³ãƒ­ãƒ³ï¼ˆ:ï¼‰ãŒå¿…è¦ã§ã™ï¼ˆifã€forã€whileã€defã€classã®å¾Œã‚ã«ã¯å¿…ãšã‚³ãƒ­ãƒ³ãŒå¿…è¦ã§ã™ï¼‰' },
                    { pattern: /SyntaxError: expected '\('/i, replacement: 'æ–‡æ³•ã‚¨ãƒ©ãƒ¼: é–‹ãæ‹¬å¼§ ( ãŒå¿…è¦ã§ã™' },
                    { pattern: /SyntaxError: expected '\)'/i, replacement: 'æ–‡æ³•ã‚¨ãƒ©ãƒ¼: é–‰ã˜æ‹¬å¼§ ) ãŒå¿…è¦ã§ã™' },
                    { pattern: /SyntaxError: '(.+?)' was never closed/i, replacement: 'æ–‡æ³•ã‚¨ãƒ©ãƒ¼: $1 ãŒé–‰ã˜ã‚‰ã‚Œã¦ã„ã¾ã›ã‚“' },
                    { pattern: /SyntaxError: closing parenthesis '\)' does not match opening parenthesis '\['/i, replacement: 'æ–‡æ³•ã‚¨ãƒ©ãƒ¼: æ‹¬å¼§ã®ç¨®é¡ãŒåˆã£ã¦ã„ã¾ã›ã‚“ï¼ˆ[ ã§é–‹ã„ãŸã‚‰ ] ã§é–‰ã˜ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼‰' },
                    { pattern: /SyntaxError: closing parenthesis '\)' does not match opening parenthesis '\{'/i, replacement: 'æ–‡æ³•ã‚¨ãƒ©ãƒ¼: æ‹¬å¼§ã®ç¨®é¡ãŒåˆã£ã¦ã„ã¾ã›ã‚“ï¼ˆ{ ã§é–‹ã„ãŸã‚‰ } ã§é–‰ã˜ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼‰' },
                    { pattern: /SyntaxError: unmatched '\)'/i, replacement: 'æ–‡æ³•ã‚¨ãƒ©ãƒ¼: é–‰ã˜æ‹¬å¼§ ) ã«å¯¾å¿œã™ã‚‹é–‹ãæ‹¬å¼§ãŒã‚ã‚Šã¾ã›ã‚“' },
                    { pattern: /SyntaxError: unmatched '\]'/i, replacement: 'æ–‡æ³•ã‚¨ãƒ©ãƒ¼: é–‰ã˜æ‹¬å¼§ ] ã«å¯¾å¿œã™ã‚‹é–‹ãæ‹¬å¼§ãŒã‚ã‚Šã¾ã›ã‚“' },
                    { pattern: /SyntaxError: unmatched '\}'/i, replacement: 'æ–‡æ³•ã‚¨ãƒ©ãƒ¼: é–‰ã˜æ‹¬å¼§ } ã«å¯¾å¿œã™ã‚‹é–‹ãæ‹¬å¼§ãŒã‚ã‚Šã¾ã›ã‚“' },
                    { pattern: /SyntaxError: EOL while scanning string literal/i, replacement: 'æ–‡æ³•ã‚¨ãƒ©ãƒ¼: æ–‡å­—åˆ—ã®é–‰ã˜æ‹¬å¼§ï¼ˆ\'ã¾ãŸã¯"ï¼‰ãŒè¶³ã‚Šã¾ã›ã‚“ï¼ˆæ–‡å­—åˆ—ã‚’é–‹å§‹ã—ãŸã‚‰åŒã˜æ‹¬å¼§ã§é–‰ã˜ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼‰' },
                    { pattern: /SyntaxError: unexpected EOF while parsing/i, replacement: 'æ–‡æ³•ã‚¨ãƒ©ãƒ¼: ã‚«ãƒƒã‚³ã‚„æ‹¬å¼§ãŒé–‰ã˜ã‚‰ã‚Œã¦ã„ã¾ã›ã‚“ï¼ˆãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®é€”ä¸­ã§çµ‚ã‚ã£ã¦ã„ã¾ã™ï¼‰' },
                    { pattern: /SyntaxError: invalid character '(.+?)'/i, replacement: 'æ–‡æ³•ã‚¨ãƒ©ãƒ¼: ä½¿ãˆãªã„æ–‡å­—ã€Œ$1ã€ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ï¼ˆå…¨è§’æ–‡å­—ã‚„ç‰¹æ®Šæ–‡å­—ãŒç´›ã‚Œè¾¼ã‚“ã§ã„ã¾ã›ã‚“ã‹ï¼Ÿï¼‰' },
                    { pattern: /SyntaxError: invalid character in identifier/i, replacement: 'æ–‡æ³•ã‚¨ãƒ©ãƒ¼: å¤‰æ•°åã‚„é–¢æ•°åã«ä½¿ãˆãªã„æ–‡å­—ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ï¼ˆå…¨è§’æ–‡å­—ãŒç´›ã‚Œè¾¼ã‚“ã§ã„ã¾ã›ã‚“ã‹ï¼Ÿï¼‰' },
                    { pattern: /SyntaxError: cannot assign to (.+)/i, replacement: 'æ–‡æ³•ã‚¨ãƒ©ãƒ¼: $1 ã«å€¤ã‚’ä»£å…¥ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“' },
                    { pattern: /SyntaxError: invalid syntax/i, replacement: 'æ–‡æ³•ã‚¨ãƒ©ãƒ¼: æ›¸ãæ–¹ãŒé–“é•ã£ã¦ã„ã¾ã™ï¼ˆã‚³ãƒ­ãƒ³ã€æ‹¬å¼§ã€ã‚«ãƒ³ãƒãªã©ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰' },
                    { pattern: /SyntaxError: /i, replacement: 'æ–‡æ³•ã‚¨ãƒ©ãƒ¼: ' },

                    // NameErrorç³»
                    { pattern: /NameError: name '(.+?)' is not defined/i, replacement: 'å¤‰æ•°ã‚¨ãƒ©ãƒ¼: ã€Œ$1ã€ã¨ã„ã†å¤‰æ•°ã‚„é–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆå®šç¾©ã•ã‚Œã¦ã„ãªã„ã‹ã€ã‚¹ãƒšãƒ«ãƒŸã‚¹ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼‰' },
                    { pattern: /NameError: /i, replacement: 'å¤‰æ•°ã‚¨ãƒ©ãƒ¼: ' },

                    // TypeErrorç³»
                    { pattern: /TypeError: unsupported operand type\(s\) for \+: '(.+?)' and '(.+?)'/i, replacement: 'å‹ã‚¨ãƒ©ãƒ¼: $1ã¨$2ã‚’ã€Œ+ã€ã§è¶³ã™ã“ã¨ã¯ã§ãã¾ã›ã‚“ï¼ˆç•°ãªã‚‹å‹åŒå£«ã®è¨ˆç®—ã¯ã§ãã¾ã›ã‚“ï¼‰' },
                    { pattern: /TypeError: unsupported operand type\(s\) for -: '(.+?)' and '(.+?)'/i, replacement: 'å‹ã‚¨ãƒ©ãƒ¼: $1ã¨$2ã‚’ã€Œ-ã€ã§å¼•ãã“ã¨ã¯ã§ãã¾ã›ã‚“ï¼ˆç•°ãªã‚‹å‹åŒå£«ã®è¨ˆç®—ã¯ã§ãã¾ã›ã‚“ï¼‰' },
                    { pattern: /TypeError: unsupported operand type\(s\) for \*: '(.+?)' and '(.+?)'/i, replacement: 'å‹ã‚¨ãƒ©ãƒ¼: $1ã¨$2ã‚’ã€Œ*ã€ã§æ›ã‘ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ï¼ˆç•°ãªã‚‹å‹åŒå£«ã®è¨ˆç®—ã¯ã§ãã¾ã›ã‚“ï¼‰' },
                    { pattern: /TypeError: unsupported operand type\(s\) for \/: '(.+?)' and '(.+?)'/i, replacement: 'å‹ã‚¨ãƒ©ãƒ¼: $1ã¨$2ã‚’ã€Œ/ã€ã§å‰²ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ï¼ˆç•°ãªã‚‹å‹åŒå£«ã®è¨ˆç®—ã¯ã§ãã¾ã›ã‚“ï¼‰' },
                    { pattern: /TypeError: can only concatenate str .+ to str/i, replacement: 'å‹ã‚¨ãƒ©ãƒ¼: æ–‡å­—åˆ—ã«ã¯æ–‡å­—åˆ—ã—ã‹é€£çµã§ãã¾ã›ã‚“ï¼ˆæ•°å€¤ã‚’é€£çµã—ãŸã„å ´åˆã¯ str() ã§æ–‡å­—åˆ—ã«å¤‰æ›ã—ã¦ãã ã•ã„ï¼‰' },
                    { pattern: /TypeError: '(.+?)' object is not subscriptable/i, replacement: 'å‹ã‚¨ãƒ©ãƒ¼: $1 ã«ã¯ [ ] ã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ï¼ˆãƒªã‚¹ãƒˆã‚„æ–‡å­—åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰' },
                    { pattern: /TypeError: '(.+?)' object is not callable/i, replacement: 'å‹ã‚¨ãƒ©ãƒ¼: $1 ã¯é–¢æ•°ã§ã¯ãªã„ã®ã§ ( ) ã§å‘¼ã³å‡ºã›ã¾ã›ã‚“' },
                    { pattern: /TypeError: (.+?)\(\) missing (\d+) required positional argument/i, replacement: 'å‹ã‚¨ãƒ©ãƒ¼: $1() é–¢æ•°ã«å¿…è¦ãªå¼•æ•°ãŒ $2 å€‹è¶³ã‚Šã¾ã›ã‚“' },
                    { pattern: /TypeError: (.+?)\(\) takes (\d+) positional argument but (\d+) were given/i, replacement: 'å‹ã‚¨ãƒ©ãƒ¼: $1() é–¢æ•°ã¯ $2 å€‹ã®å¼•æ•°ã—ã‹å—ã‘å–ã‚Œã¾ã›ã‚“ãŒã€$3 å€‹ã®å¼•æ•°ãŒæ¸¡ã•ã‚Œã¦ã„ã¾ã™' },
                    { pattern: /TypeError: /i, replacement: 'å‹ã‚¨ãƒ©ãƒ¼: ' },

                    // ValueErrorç³»
                    { pattern: /ValueError: invalid literal for int\(\) with base (.+?): '(.+?)'/i, replacement: 'å€¤ã‚¨ãƒ©ãƒ¼: ã€Œ$2ã€ã‚’æ•°å€¤ï¼ˆæ•´æ•°ï¼‰ã«å¤‰æ›ã§ãã¾ã›ã‚“ï¼ˆæ•°å­—ä»¥å¤–ã®æ–‡å­—ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ï¼‰' },
                    { pattern: /ValueError: invalid literal for float\(\): '(.+?)'/i, replacement: 'å€¤ã‚¨ãƒ©ãƒ¼: ã€Œ$1ã€ã‚’å°æ•°ï¼ˆfloatï¼‰ã«å¤‰æ›ã§ãã¾ã›ã‚“ï¼ˆæ•°å­—ä»¥å¤–ã®æ–‡å­—ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ï¼‰' },
                    { pattern: /ValueError: not enough values to unpack \(expected (\d+), got (\d+)\)/i, replacement: 'å€¤ã‚¨ãƒ©ãƒ¼: å±•é–‹ã™ã‚‹å€¤ãŒè¶³ã‚Šã¾ã›ã‚“ï¼ˆ$1å€‹å¿…è¦ã§ã™ãŒã€$2å€‹ã—ã‹ã‚ã‚Šã¾ã›ã‚“ï¼‰' },
                    { pattern: /ValueError: too many values to unpack \(expected (\d+)\)/i, replacement: 'å€¤ã‚¨ãƒ©ãƒ¼: å±•é–‹ã™ã‚‹å€¤ãŒå¤šã™ãã¾ã™ï¼ˆ$1å€‹ã—ã‹å—ã‘å–ã‚Œã¾ã›ã‚“ï¼‰' },
                    { pattern: /ValueError: /i, replacement: 'å€¤ã‚¨ãƒ©ãƒ¼: ' },

                    // IndexErrorç³»
                    { pattern: /IndexError: list index out of range/i, replacement: 'ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚¨ãƒ©ãƒ¼: ãƒªã‚¹ãƒˆã®ç¯„å›²å¤–ã‚’å‚ç…§ã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ï¼ˆãƒªã‚¹ãƒˆã®é•·ã•ã‚’è¶…ãˆãŸä½ç½®ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã„ã¾ã™ï¼‰' },
                    { pattern: /IndexError: string index out of range/i, replacement: 'ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚¨ãƒ©ãƒ¼: æ–‡å­—åˆ—ã®ç¯„å›²å¤–ã‚’å‚ç…§ã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ï¼ˆæ–‡å­—åˆ—ã®é•·ã•ã‚’è¶…ãˆãŸä½ç½®ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã„ã¾ã™ï¼‰' },
                    { pattern: /IndexError: tuple index out of range/i, replacement: 'ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚¨ãƒ©ãƒ¼: ã‚¿ãƒ—ãƒ«ã®ç¯„å›²å¤–ã‚’å‚ç…§ã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ï¼ˆã‚¿ãƒ—ãƒ«ã®é•·ã•ã‚’è¶…ãˆãŸä½ç½®ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã„ã¾ã™ï¼‰' },
                    { pattern: /IndexError: /i, replacement: 'ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚¨ãƒ©ãƒ¼: ' },

                    // KeyErrorç³»
                    { pattern: /KeyError: '(.+?)'/i, replacement: 'ã‚­ãƒ¼ã‚¨ãƒ©ãƒ¼: è¾æ›¸ã«ã€Œ$1ã€ã¨ã„ã†ã‚­ãƒ¼ãŒå­˜åœ¨ã—ã¾ã›ã‚“ï¼ˆã‚¹ãƒšãƒ«ãƒŸã‚¹ã‚„å­˜åœ¨ã—ãªã„ã‚­ãƒ¼ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã„ã¾ã™ï¼‰' },
                    { pattern: /KeyError: (\d+)/i, replacement: 'ã‚­ãƒ¼ã‚¨ãƒ©ãƒ¼: è¾æ›¸ã« $1 ã¨ã„ã†ã‚­ãƒ¼ãŒå­˜åœ¨ã—ã¾ã›ã‚“' },
                    { pattern: /KeyError: /i, replacement: 'ã‚­ãƒ¼ã‚¨ãƒ©ãƒ¼: ' },

                    // AttributeErrorç³»
                    { pattern: /AttributeError: '(.+?)' object has no attribute '(.+?)'/i, replacement: 'å±æ€§ã‚¨ãƒ©ãƒ¼: $1 ã«ã¯ã€Œ$2ã€ã¨ã„ã†å±æ€§ã‚„ãƒ¡ã‚½ãƒƒãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆã‚¹ãƒšãƒ«ãƒŸã‚¹ã‚„å­˜åœ¨ã—ãªã„ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã—ã¦ã„ã¾ã™ï¼‰' },
                    { pattern: /AttributeError: /i, replacement: 'å±æ€§ã‚¨ãƒ©ãƒ¼: ' },

                    // ZeroDivisionErrorç³»
                    { pattern: /ZeroDivisionError: division by zero/i, replacement: 'ã‚¼ãƒ­é™¤ç®—ã‚¨ãƒ©ãƒ¼: 0ã§å‰²ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ï¼ˆå‰²ã‚‹æ•°ãŒ0ã«ãªã£ã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿï¼‰' },
                    { pattern: /ZeroDivisionError: /i, replacement: 'ã‚¼ãƒ­é™¤ç®—ã‚¨ãƒ©ãƒ¼: ' },

                    // IndentationErrorç³»
                    { pattern: /IndentationError: expected an indented block after '(.+?)'/i, replacement: 'ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã‚¨ãƒ©ãƒ¼: $1 ã®å¾Œã«ã¯ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆï¼ˆå­—ä¸‹ã’ï¼‰ãŒå¿…è¦ã§ã™' },
                    { pattern: /IndentationError: expected an indented block/i, replacement: 'ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã‚¨ãƒ©ãƒ¼: ã“ã“ã«ã¯ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆï¼ˆå­—ä¸‹ã’ï¼‰ãŒå¿…è¦ã§ã™ï¼ˆifã€forã€whileã€def ã®æ¬¡ã®è¡Œã¯å¿…ãšå­—ä¸‹ã’ã—ã¾ã™ï¼‰' },
                    { pattern: /IndentationError: unexpected indent/i, replacement: 'ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã‚¨ãƒ©ãƒ¼: äºˆæœŸã—ãªã„ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆï¼ˆå­—ä¸‹ã’ï¼‰ãŒã‚ã‚Šã¾ã™ï¼ˆã“ã“ã«å­—ä¸‹ã’ã¯å¿…è¦ã‚ã‚Šã¾ã›ã‚“ï¼‰' },
                    { pattern: /IndentationError: unindent does not match any outer indentation level/i, replacement: 'ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã‚¨ãƒ©ãƒ¼: ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆï¼ˆå­—ä¸‹ã’ï¼‰ã®æ·±ã•ãŒåˆã£ã¦ã„ã¾ã›ã‚“ï¼ˆå­—ä¸‹ã’ã®æ•°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰' },
                    { pattern: /IndentationError: /i, replacement: 'ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã‚¨ãƒ©ãƒ¼: ' },

                    // RecursionErrorç³»
                    { pattern: /RecursionError: maximum recursion depth exceeded/i, replacement: 'å†å¸°ã‚¨ãƒ©ãƒ¼: é–¢æ•°ã®å‘¼ã³å‡ºã—ãŒæ·±ã™ãã¾ã™ï¼ˆç„¡é™ãƒ«ãƒ¼ãƒ—ã«ãªã£ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚çµ‚äº†æ¡ä»¶ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰' },
                    { pattern: /RecursionError: /i, replacement: 'å†å¸°ã‚¨ãƒ©ãƒ¼: ' },

                    // ImportErrorç³»
                    { pattern: /ImportError: No module named '(.+?)'/i, replacement: 'ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: ã€Œ$1ã€ã¨ã„ã†ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒã§ã¯ä½¿ãˆãªã„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã§ã™ï¼‰' },
                    { pattern: /ImportError: /i, replacement: 'ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: ' },

                    // ModuleNotFoundErrorç³»
                    { pattern: /ModuleNotFoundError: No module named '(.+?)'/i, replacement: 'ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æœªæ¤œå‡ºã‚¨ãƒ©ãƒ¼: ã€Œ$1ã€ã¨ã„ã†ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒã§ã¯ä½¿ãˆãªã„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã§ã™ï¼‰' },

                    // ãã®ä»–ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                    { pattern: /File "<exec>", line (\d+)/i, replacement: 'ğŸ“ $1è¡Œç›®ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' },
                    { pattern: /Traceback \(most recent call last\):/i, replacement: 'ğŸ” ã‚¨ãƒ©ãƒ¼ã®è©³ç´°:' },
                    { pattern: /\^+/i, replacement: '  â†‘ ã“ã®éƒ¨åˆ†ã«å•é¡ŒãŒã‚ã‚Šã¾ã™' },
                ];

                // ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°ã§ç¿»è¨³
                for (const { pattern, replacement } of errorPatterns) {
                    if (pattern.test(translatedLine)) {
                        translatedLine = translatedLine.replace(pattern, replacement);
                        break; // æœ€åˆã«ãƒãƒƒãƒã—ãŸãƒ‘ã‚¿ãƒ¼ãƒ³ã®ã¿é©ç”¨
                    }
                }

                translatedLines.push(translatedLine);
            }

            // æœ€åˆã®è¡Œã«ã€ŒâŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€ã‚’è¿½åŠ 
            const result = ['âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', '', ...translatedLines];
            return result.join('\n');
        }

        // å†å¸°ãƒˆãƒ©ãƒƒã‚«ãƒ¼ã®æ›´æ–°
        function updateRecursionTracker(data) {
            const tracker = document.getElementById('recursion-tracker');
            if (Object.keys(data).length === 0) {
                tracker.innerHTML = '<div class="debug-empty">å†å¸°é–¢æ•°ã¯ã¾ã å‘¼ã°ã‚Œã¦ã„ã¾ã›ã‚“</div>';
                return;
            }

            let html = '<div class="recursion-list">';

            for (const [funcName, info] of Object.entries(data)) {
                const maxDepth = info.max_depth;
                const totalCalls = info.total_calls;
                const depthBars = 'â”'.repeat(Math.min(maxDepth, 20));

                html += `
                    <div class="recursion-item">
                        <div class="recursion-header">
                            <span class="recursion-name">${funcName}()</span>
                            <span class="recursion-stats">
                                <span class="stat-badge">å‘¼å‡º: ${totalCalls}å›</span>
                                <span class="stat-badge depth">æ·±ã•: ${maxDepth}</span>
                            </span>
                        </div>
                        <div class="recursion-depth-bar">
                            <div class="depth-fill" style="width: ${Math.min(maxDepth * 10, 100)}%">
                                ${depthBars}
                            </div>
                        </div>
                    </div>
                `;
            }

            html += '</div>';
            tracker.innerHTML = html;
        }

        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã®ã‚¯ãƒªã‚¢
        function clearDebugInfo() {
            variableState = {};
            loopCounts = {};
            recursionData = {};
            outputLineCount = 0;
            updateVariableTracker({});
            updateLoopTracker({});
            updateRecursionTracker({});
        }

        // ã‚³ãƒ¼ãƒ‰å®Ÿè¡Œ
        async function runCode() {
            if (!pyodide) {
                const outputArea = document.getElementById('output-area');
                outputArea.innerHTML = '';
                appendOutput('Pythonã‚¨ãƒ³ã‚¸ãƒ³ãŒã¾ã èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚', 'stderr');
                return;
            }

            // CodeMirrorã¾ãŸã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚¨ãƒ‡ã‚£ã‚¿ã‹ã‚‰ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
            let code;
            if (codeEditor) {
                code = codeEditor.getValue().trim();
            } else {
                const fallbackEditor = document.getElementById('fallback-editor');
                code = fallbackEditor ? fallbackEditor.value.trim() : '';
            }

            if (!code) {
                const outputArea = document.getElementById('output-area');
                outputArea.innerHTML = '';
                appendOutput('å®Ÿè¡Œã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'stderr');
                return;
            }

            const outputArea = document.getElementById('output-area');
            const runBtn = document.getElementById('run-btn');

            // å‡ºåŠ›ã‚¨ãƒªã‚¢ã‚’å®Œå…¨ã«ã‚¯ãƒªã‚¢ï¼ˆä»¥å‰ã®ã‚¨ãƒ©ãƒ¼ã‚„å‡ºåŠ›ã‚’ç¢ºå®Ÿã«å‰Šé™¤ï¼‰
            outputArea.innerHTML = '';
            outputLineCount = 0;

            // å®Ÿè¡Œä¸­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            outputArea.innerHTML = '<div class="running-msg">ğŸ”„ å®Ÿè¡Œä¸­...<br><small style="color: #94a3b8;">â€»å¤§é‡ã®å‡ºåŠ›ã¯å®Ÿè¡Œå®Œäº†å¾Œã«è¡¨ç¤ºã•ã‚Œã¾ã™</small></div>';
            clearDebugInfo();
            runBtn.disabled = true;

            try {
                // ãƒˆãƒ¬ãƒ¼ã‚µãƒ¼ã‚’è¨­å®šã™ã‚‹Pythonã‚³ãƒ¼ãƒ‰
                const tracerCode = `
import sys
import json
import re

__loop_counts__ = {}
__loop_iterations__ = {}  # ãƒ«ãƒ¼ãƒ—ã”ã¨ã®åå¾©å›æ•°ã‚’è¨˜éŒ²
__variables__ = {}
__all_variables__ = {}  # ã™ã¹ã¦ã®å¤‰æ•°ã‚’åé›†
__recursion_data__ = {}  # å†å¸°æƒ…å ±ã‚’è¿½è·¡
__call_stack__ = {}  # é–¢æ•°å‘¼ã³å‡ºã—ã‚¹ã‚¿ãƒƒã‚¯
__user_code_file__ = '<exec>'
__tracing_enabled__ = False
__user_code_lines__ = []
__loop_stack__ = []  # ãƒ«ãƒ¼ãƒ—ã®ãƒã‚¹ãƒˆã‚’è¿½è·¡
__in_loop__ = False

def __is_loop_start__(line_text):
    """è¡ŒãŒforã¾ãŸã¯whileã§å§‹ã¾ã‚‹ã‹ãƒã‚§ãƒƒã‚¯"""
    stripped = line_text.lstrip()
    return stripped.startswith('for ') or stripped.startswith('while ')

def __get_indent__(line_text):
    """è¡Œã®ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆãƒ¬ãƒ™ãƒ«ã‚’å–å¾—"""
    return len(line_text) - len(line_text.lstrip())

def __tracer__(frame, event, arg):
    global __loop_counts__, __loop_iterations__, __variables__, __all_variables__, __recursion_data__, __call_stack__
    global __tracing_enabled__, __loop_stack__, __in_loop__

    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ¼ãƒ‰ã®ã¿ã‚’è¿½è·¡ï¼ˆ<exec>ãƒ•ã‚¡ã‚¤ãƒ«åã§ãƒ•ã‚£ãƒ«ã‚¿ï¼‰
    filename = frame.f_code.co_filename
    if filename != __user_code_file__:
        return __tracer__

    # é–¢æ•°å‘¼ã³å‡ºã—ã¨å†å¸°ã®è¿½è·¡
    if event == 'call' and __tracing_enabled__:
        func_name = frame.f_code.co_name

        # é™¤å¤–ã™ã‚‹é–¢æ•°å
        excluded_funcs = {
            '<module>', '<listcomp>', '<dictcomp>', '<setcomp>', '<genexpr>',
            'write', 'flush', 'custom_input', 'custom_print'
        }

        # ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œã‚„çµ„ã¿è¾¼ã¿é–¢æ•°ã‚’é™¤å¤–
        if func_name not in excluded_funcs and not func_name.startswith('_'):
            # ã‚¹ã‚¿ãƒƒã‚¯ã«è¿½åŠ 
            if func_name not in __call_stack__:
                __call_stack__[func_name] = 0
            __call_stack__[func_name] += 1

            current_depth = __call_stack__[func_name]

            # å†å¸°ãƒ‡ãƒ¼ã‚¿ã‚’è¨˜éŒ²
            if func_name not in __recursion_data__:
                __recursion_data__[func_name] = {
                    'total_calls': 0,
                    'max_depth': 0
                }

            __recursion_data__[func_name]['total_calls'] += 1
            if current_depth > __recursion_data__[func_name]['max_depth']:
                __recursion_data__[func_name]['max_depth'] = current_depth

    # é–¢æ•°ã‹ã‚‰ã®æˆ»ã‚Š
    if event == 'return' and __tracing_enabled__:
        func_name = frame.f_code.co_name
        if func_name in __call_stack__ and __call_stack__[func_name] > 0:
            __call_stack__[func_name] -= 1

    # ãƒ«ãƒ¼ãƒ—ã®ã‚«ã‚¦ãƒ³ãƒˆï¼ˆè¡Œç•ªå·ãƒ™ãƒ¼ã‚¹ï¼‰
    if event == 'line' and __tracing_enabled__:
        lineno = frame.f_lineno

        if lineno <= len(__user_code_lines__):
            line_text = __user_code_lines__[lineno - 1]
            current_indent = __get_indent__(line_text)

            # ãƒ«ãƒ¼ãƒ—ã®é–‹å§‹ã‚’æ¤œå‡º
            if __is_loop_start__(line_text):
                __loop_stack__.append({
                    'line': lineno,
                    'indent': current_indent,
                    'iterations': 0
                })
                __in_loop__ = True

            # ãƒ«ãƒ¼ãƒ—æœ¬ä½“å†…ã®è¡Œã‚’ã‚«ã‚¦ãƒ³ãƒˆ
            elif __loop_stack__:
                # ç¾åœ¨ã®ãƒ«ãƒ¼ãƒ—ã®ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆãƒ¬ãƒ™ãƒ«
                loop_info = __loop_stack__[-1]
                loop_indent = loop_info['indent']
                loop_line = loop_info['line']

                # ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆãŒãƒ«ãƒ¼ãƒ—ã‚ˆã‚Šæ·±ã„ = ãƒ«ãƒ¼ãƒ—æœ¬ä½“å†…
                if current_indent > loop_indent:
                    if lineno in __loop_counts__:
                        __loop_counts__[lineno] += 1
                    else:
                        __loop_counts__[lineno] = 1

                    # ãƒ«ãƒ¼ãƒ—ã®æœ€åˆã®è¡Œã«æˆ»ã£ãŸã‚‰åå¾©å›æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
                    # ï¼ˆãƒ«ãƒ¼ãƒ—æœ¬ä½“ã®æœ€å°è¡Œç•ªå·ã‚’åŸºæº–ã«åˆ¤å®šï¼‰
                    if loop_line not in __loop_iterations__:
                        __loop_iterations__[loop_line] = {'iterations': 0, 'first_body_line': lineno}

                    # æœ€åˆã®æœ¬ä½“è¡Œã«æˆ»ã£ã¦ããŸã‚‰åå¾©å›æ•°ã‚’å¢—ã‚„ã™
                    if lineno == __loop_iterations__[loop_line]['first_body_line']:
                        __loop_iterations__[loop_line]['iterations'] += 1

                # ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆãŒæˆ»ã£ãŸ = ãƒ«ãƒ¼ãƒ—çµ‚äº†
                elif current_indent <= loop_indent:
                    __loop_stack__.pop()
                    if not __loop_stack__:
                        __in_loop__ = False

    # ã™ã¹ã¦ã®å¤‰æ•°ã‚’åé›†ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ« + ãƒ­ãƒ¼ã‚«ãƒ«ï¼‰
    if event in ['line', 'call', 'return'] and __tracing_enabled__:
        # ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ã®ã¿ã‚’å–å¾—ï¼ˆé–¢æ•°å†…ã®å¤‰æ•°ï¼‰
        locals_dict = frame.f_locals.copy()

        # ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’å–å¾—ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾©ã®ã¿ï¼‰
        globals_dict = frame.f_globals.copy()

        # é™¤å¤–ã™ã‚‹ã‚­ãƒ¼
        excluded_keys = {
            'sys', 'json', 're', 'io', 'builtins', 'prompt',
            'UnbufferedTextIO', 'self', 's', 'custom_input'
        }

        # çµ„ã¿åˆã‚ã›ã¦ã€å†…éƒ¨å¤‰æ•°ã‚„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’é™¤å¤–
        for k, v in {**globals_dict, **locals_dict}.items():
            if (not k.startswith('_') and
                k not in excluded_keys and
                not callable(v) and
                'TextIO' not in str(type(v)) and
                '<_io.' not in str(v) and
                str(type(v)) not in ['<class \\'module\\'>', '<class \\'type\\'>']):
                try:
                    # ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºå¯èƒ½ãªå€¤ã®ã¿ä¿å­˜
                    json.dumps(v)
                    __all_variables__[k] = v
                except:
                    # ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã§ããªã„å€¤ã¯ã‚¹ã‚­ãƒƒãƒ—
                    pass

    return __tracer__
`;

                // ãƒˆãƒ¬ãƒ¼ã‚µãƒ¼ã‚’è¨­å®š
                await pyodide.runPythonAsync(tracerCode);

                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ¼ãƒ‰ã®è¡Œã‚’è¨­å®šï¼ˆã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆåˆ¤å®šç”¨ï¼‰
                const codeLines = code.split('\n');
                pyodide.globals.set('__user_code_lines__', codeLines);

                // ãƒˆãƒ¬ãƒ¼ã‚µãƒ¼ã‚’æœ‰åŠ¹åŒ–ã—ã¦ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œ
                await pyodide.runPythonAsync('sys.settrace(__tracer__)');
                await pyodide.runPythonAsync('__tracing_enabled__ = True');

                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œ
                const result = await pyodide.runPythonAsync(code);

                // ãƒˆãƒ¬ãƒ¼ã‚µãƒ¼ã‚’ç„¡åŠ¹åŒ–
                await pyodide.runPythonAsync('__tracing_enabled__ = False');
                await pyodide.runPythonAsync('sys.settrace(None)');

                // æœ€çµ‚çš„ãªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                const outputArea = document.getElementById('output-area');
                outputArea.scrollTop = outputArea.scrollHeight;

                // å¤‰æ•°ã€ãƒ«ãƒ¼ãƒ—ã‚«ã‚¦ãƒ³ãƒˆã€å†å¸°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const variables = pyodide.globals.get('__all_variables__');
                const loopCountsRaw = pyodide.globals.get('__loop_counts__');
                const recursionDataRaw = pyodide.globals.get('__recursion_data__');

                // JavaScriptã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›
                if (variables) {
                    variableState = variables.toJs({dict_converter: Object.fromEntries});
                    updateVariableTracker(variableState);
                }

                if (loopCountsRaw) {
                    const loopCountsObj = loopCountsRaw.toJs({dict_converter: Object.fromEntries});
                    loopCounts = loopCountsObj;

                    // ãƒ«ãƒ¼ãƒ—åå¾©å›æ•°ã‚’å–å¾—
                    const loopIterationsRaw = pyodide.globals.get('__loop_iterations__');
                    let loopIterationsObj = {};
                    if (loopIterationsRaw) {
                        loopIterationsObj = loopIterationsRaw.toJs({dict_converter: Object.fromEntries});
                    }

                    updateLoopTracker(loopCounts, codeLines, loopIterationsObj);
                }

                if (recursionDataRaw) {
                    recursionData = recursionDataRaw.toJs({dict_converter: Object.fromEntries});
                    updateRecursionTracker(recursionData);
                }

                // ã€Œå®Ÿè¡Œä¸­...ã€ãŒæ®‹ã£ã¦ã„ãŸã‚‰å‰Šé™¤
                const runningMsg = outputArea.querySelector('.running-msg');
                if (runningMsg) {
                    runningMsg.remove();
                }

                // çµæœãŒã‚ã‚‹å ´åˆã¯è¡¨ç¤º
                if (result !== undefined && result !== null && result !== '') {
                    appendOutput(`çµæœ: ${result}`, 'info');
                }

                // å‡ºåŠ›ãŒãªã‹ã£ãŸå ´åˆã®ã¿ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
                if (outputArea.children.length === 0) {
                    appendOutput('âœ… å®Ÿè¡Œå®Œäº†ï¼ˆå‡ºåŠ›ãªã—ï¼‰', 'info');
                }

            } catch (error) {
                console.error('Pythonå®Ÿè¡Œã‚¨ãƒ©ãƒ¼:', error);

                // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚å‡ºåŠ›ã‚¨ãƒªã‚¢ã‚’å®Œå…¨ã«ã‚¯ãƒªã‚¢ã—ã¦ã‹ã‚‰è¡¨ç¤º
                const outputArea = document.getElementById('output-area');
                outputArea.innerHTML = '';
                outputLineCount = 0;

                // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã‚’ç¢ºèª
                const japaneseErrorToggle = document.getElementById('japanese-error-toggle');
                const useJapanese = japaneseErrorToggle ? japaneseErrorToggle.checked : true;

                // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ—¥æœ¬èªåŒ–ã™ã‚‹ã‹ã©ã†ã‹
                const errorMessage = useJapanese ? translatePythonError(error.message) : `ã‚¨ãƒ©ãƒ¼:\n${error.message}`;
                appendOutput(errorMessage, 'stderr');
            } finally {
                runBtn.disabled = false;
            }
        }

        // ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã®æŒ¿å…¥
        function insertSampleCode() {
            const samples = [
                '# åŸºæœ¬çš„ãªè¨ˆç®—\\nprint("=== è¨ˆç®—ã®ä¾‹ ===")\\nprint("10 + 5 =", 10 + 5)\\nprint("10 - 3 =", 10 - 3)\\nprint("4 * 6 =", 4 * 6)\\nprint("15 / 3 =", 15 / 3)',

                '# å¤‰æ•°ã¨æ–‡å­—åˆ—\\nprint("=== å¤‰æ•°ã®ä¾‹ ===")\\nname = "å¤ªéƒ"\\nage = 16\\nprint(f"åå‰: {name}")\\nprint(f"å¹´é½¢: {age}æ­³")\\nprint(f"{name}ã•ã‚“ã¯{age}æ­³ã§ã™")',

                '# ç¹°ã‚Šè¿”ã—å‡¦ç†\\nprint("=== ç¹°ã‚Šè¿”ã—ã®ä¾‹ ===")\\nfor i in range(5):\\n    print(f"ã‚«ã‚¦ãƒ³ãƒˆ: {i}")\\n\\nprint("\\nå¶æ•°ã®è¡¨ç¤º:")\\nfor i in range(10):\\n    if i % 2 == 0:\\n        print(f"{i}ã¯å¶æ•°")',

                '# ãƒªã‚¹ãƒˆã®æ“ä½œ\\nprint("=== ãƒªã‚¹ãƒˆã®ä¾‹ ===")\\nfruits = ["ã‚Šã‚“ã”", "ãƒãƒŠãƒŠ", "ã‚ªãƒ¬ãƒ³ã‚¸"]\\nprint("æœç‰©ãƒªã‚¹ãƒˆ:", fruits)\\n\\nfruits.append("ã¶ã©ã†")\\nprint("è¿½åŠ å¾Œ:", fruits)\\n\\nfor fruit in fruits:\\n    print(f"- {fruit}")',

                '# é–¢æ•°ã®å®šç¾©\\nprint("=== é–¢æ•°ã®ä¾‹ ===")\\ndef greet(name):\\n    return f"ã“ã‚“ã«ã¡ã¯ã€{name}ã•ã‚“!"\\n\\ndef add_numbers(a, b):\\n    return a + b\\n\\nprint(greet("èŠ±å­"))\\nprint(f"5 + 3 = {add_numbers(5, 3)}")',
            ];

            const randomSample = samples[Math.floor(Math.random() * samples.length)];
            const formattedCode = randomSample.replace(/\\n/g, '\n');
            
            if (codeEditor) {
                codeEditor.setValue(formattedCode);
            } else {
                const fallbackEditor = document.getElementById('fallback-editor');
                if (fallbackEditor) {
                    fallbackEditor.value = formattedCode;
                }
            }
        }

        // ã‚³ãƒ¼ãƒ‰ã‚¨ãƒ‡ã‚£ã‚¿ã‚’ã‚¯ãƒªã‚¢
        function clearCode() {
            if (codeEditor) {
                codeEditor.setValue('');
            } else {
                const fallbackEditor = document.getElementById('fallback-editor');
                if (fallbackEditor) {
                    fallbackEditor.value = '';
                }
            }
            document.getElementById('output-area').innerHTML = '<div class="ready">ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦å®Ÿè¡Œãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</div>';
            clearDebugInfo();
        }

        // ä¿å­˜æ©Ÿèƒ½
        function saveCode() {
            if (!codeEditor) {
                alert('ã‚¨ãƒ‡ã‚£ã‚¿ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }

            const code = codeEditor.getValue();
            if (!code.trim()) {
                alert('ä¿å­˜ã™ã‚‹ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            const blob = new Blob([code], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `python_playground_${new Date().toISOString().split('T')[0]}.py`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // èª­è¾¼æ©Ÿèƒ½
        function loadCode() {
            const fileInput = document.getElementById('file-input');
            fileInput.click();
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.name.endsWith('.py')) {
                alert('.pyãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                if (codeEditor) {
                    codeEditor.setValue(e.target.result);
                }
            };
            reader.readAsText(file);

            // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆåŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†åº¦èª­ã¿è¾¼ã‚ã‚‹ã‚ˆã†ã«ã™ã‚‹ï¼‰
            event.target.value = '';
        }

        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—æ©Ÿèƒ½
        function setupDragAndDrop() {
            const editorContainer = document.getElementById('code-editor-container');

            editorContainer.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                editorContainer.style.border = '3px dashed #3b82f6';
                editorContainer.style.background = 'rgba(59, 130, 246, 0.05)';
            });

            editorContainer.addEventListener('dragleave', (e) => {
                e.preventDefault();
                e.stopPropagation();
                editorContainer.style.border = '2px solid #e2e8f0';
                editorContainer.style.background = '';
            });

            editorContainer.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                editorContainer.style.border = '2px solid #e2e8f0';
                editorContainer.style.background = '';

                const files = e.dataTransfer.files;
                if (files.length === 0) return;

                const file = files[0];
                if (!file.name.endsWith('.py')) {
                    alert('.pyãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ãã ã•ã„');
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(event) {
                    if (codeEditor) {
                        codeEditor.setValue(event.target.result);
                    }
                };
                reader.readAsText(file);
            });
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('DOM loaded, starting CodeMirror and Pyodide initialization...');
            
            // CodeMirrorã‚¨ãƒ‡ã‚£ã‚¿ã‚’åˆæœŸåŒ–
            await initCodeEditor();
            
            // Pyodideã‚’èª­ã¿è¾¼ã¿
            loadPyodide().catch(error => {
                console.error('Failed to load Pyodide:', error);
                const statusElement = document.getElementById('python-status');
                const outputArea = document.getElementById('output-area');
                statusElement.textContent = 'âŒ èª­ã¿è¾¼ã¿å¤±æ•—';
                outputArea.innerHTML = `<div class="error">Pythonã‚¨ãƒ³ã‚¸ãƒ³ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br>ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚<br>è©³ç´°: ${error.message}</div>`;
            });

            // ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
            document.getElementById('run-btn').addEventListener('click', runCode);
            document.getElementById('clear-btn').addEventListener('click', clearCode);
            document.getElementById('example-btn').addEventListener('click', insertSampleCode);
            document.getElementById('save-btn').addEventListener('click', saveCode);
            document.getElementById('load-btn').addEventListener('click', loadCode);
            document.getElementById('file-input').addEventListener('change', handleFileSelect);

            // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—æ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–
            setupDragAndDrop();
        });
    </script>

    <style>
        .python-playground {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .playground-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .playground-header h1 {
            color: #2563eb;
            margin-bottom: 10px;
            font-size: clamp(1.75rem, 5vw, 2.25rem);
        }

        .playground-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px 15px;
            background: #f8fafc;
            border-radius: 8px;
            border-left: 4px solid #2563eb;
            flex-wrap: wrap;
            gap: 10px;
        }

        .section-header h3 {
            margin: 0;
            color: #1e293b;
            font-size: clamp(1rem, 2.5vw, 1.25rem);
            white-space: nowrap;
        }

        .controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        .status {
            font-size: 14px;
            color: #64748b;
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: flex-end;
        }

        .error-lang-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            font-size: 13px;
            color: #475569;
            user-select: none;
        }

        .error-lang-toggle input[type="checkbox"] {
            cursor: pointer;
            width: 16px;
            height: 16px;
        }

        .error-lang-toggle span {
            white-space: nowrap;
        }

        .error-lang-toggle:hover {
            color: #1e293b;
        }

        #code-editor-container {
            width: 100%;
            height: 400px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
            transition: border-color 0.3s;
            display: flex;
            flex-direction: column;
        }

        #code-editor-container:focus-within {
            border-color: #2563eb;
        }

        /* CodeMirrorã‚¨ãƒ‡ã‚£ã‚¿ã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ */
        .CodeMirror {
            height: 400px !important;
            font-family: 'Monaco', 'Menlo', 'Consolas', 'Liberation Mono', 'Courier New', monospace;
            font-size: 16px; /* ãƒ¢ãƒã‚¤ãƒ«ã§ã‚ºãƒ¼ãƒ ã‚’é˜²ããŸã‚16pxä»¥ä¸Šã« */
            line-height: 1.5;
            border-radius: 6px;
            flex: 1;
            -webkit-text-size-adjust: 100%; /* Webkitç³»ã§ã®ãƒ†ã‚­ã‚¹ãƒˆã‚µã‚¤ã‚ºèª¿æ•´ã‚’é˜²ã */
        }

        .CodeMirror-scroll {
            min-height: 400px !important;
        }

        .CodeMirror-lines {
            padding: 4px 0;
        }

        .CodeMirror-focused .CodeMirror-cursor {
            border-left: 2px solid #2563eb;
        }

        .CodeMirror-selected {
            background: rgba(37, 99, 235, 0.2);
        }

        .CodeMirror-line::selection, 
        .CodeMirror-line > span::selection, 
        .CodeMirror-line > span > span::selection {
            background: rgba(37, 99, 235, 0.2);
        }

        /* ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚¨ãƒ‡ã‚£ã‚¿ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #fallback-editor {
            width: 100%;
            height: 400px;
            padding: 15px;
            border: none;
            outline: none;
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
            font-size: 16px; /* ãƒ¢ãƒã‚¤ãƒ«ã§ã‚ºãƒ¼ãƒ ã‚’é˜²ããŸã‚16pxä»¥ä¸Šã« */
            line-height: 1.5;
            resize: vertical;
            -webkit-text-size-adjust: 100%; /* Webkitç³»ã§ã®ãƒ†ã‚­ã‚¹ãƒˆã‚µã‚¤ã‚ºèª¿æ•´ã‚’é˜²ã */
        }

        #output-area {
            height: 400px;
            padding: 15px;
            background: #1e293b;
            color: #e2e8f0;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .output-line {
            margin-bottom: 4px;
        }

        .output-line.stderr {
            color: #ef4444;
        }

        .output-line.info {
            color: #10b981;
        }

        .loading, .ready, .running-msg {
            color: #64748b;
            font-style: italic;
            text-align: center;
            padding: 20px;
        }

        .running-msg {
            color: #3b82f6;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .error {
            color: #ef4444;
            padding: 20px;
            text-align: center;
        }

        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            font-size: clamp(0.75rem, 1.8vw, 0.875rem);
            white-space: nowrap;
            min-width: fit-content;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #2563eb;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #1d4ed8;
        }

        .btn-secondary {
            background: #64748b;
            color: white;
        }

        .btn-secondary:hover {
            background: #475569;
        }

        .btn-success {
            background: #22c55e;
            color: white;
        }

        .btn-success:hover {
            background: #16a34a;
        }

        .btn-info {
            background: #06b6d4;
            color: white;
        }

        .btn-info:hover {
            background: #0891b2;
        }

        .help-section {
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #10b981;
        }

        .help-section h3 {
            color: #1e293b;
            margin-bottom: 15px;
        }

        .help-section ul {
            list-style: none;
            padding: 0;
        }

        .help-section li {
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .help-section li:last-child {
            border-bottom: none;
        }

        /* ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ« */
        .debug-panels {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .debug-panel {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
        }

        .debug-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 15px;
        }

        .debug-header h3 {
            margin: 0;
            font-size: 1rem;
        }

        .debug-content {
            padding: 15px;
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
            font-size: 14px;
        }

        .debug-empty {
            color: #94a3b8;
            text-align: center;
            padding: 40px 20px;
            font-style: italic;
        }

        .variable-list, .loop-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .variable-item {
            background: #f8fafc;
            padding: 10px 12px;
            border-radius: 6px;
            border-left: 3px solid #3b82f6;
            display: grid;
            grid-template-columns: auto auto 1fr;
            gap: 10px;
            align-items: center;
        }

        .var-name {
            font-weight: 600;
            color: #1e293b;
        }

        .var-type {
            font-size: 11px;
            color: #64748b;
            background: #e2e8f0;
            padding: 2px 6px;
            border-radius: 3px;
        }

        .var-value {
            color: #059669;
            font-weight: 500;
            text-align: right;
        }

        .loop-group {
            margin-bottom: 20px;
            background: #fffbeb;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #f59e0b;
        }

        .loop-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .loop-header-line {
            font-weight: 700;
            color: #92400e;
            font-size: 15px;
        }

        .loop-iteration-count {
            background: #f59e0b;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 13px;
        }

        .loop-header-code {
            background: white;
            padding: 8px 10px;
            border-radius: 6px;
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
            font-size: 13px;
            color: #92400e;
            border: 1px solid #fde68a;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .loop-item {
            background: #fef3c7;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #fbbf24;
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 8px;
        }

        .loop-item:last-child {
            margin-bottom: 0;
        }

        .loop-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .loop-line {
            font-weight: 600;
            color: #92400e;
            min-width: 50px;
        }

        .loop-iterations {
            color: #f59e0b;
            font-size: 14px;
            letter-spacing: 2px;
            flex: 1;
        }

        .loop-count {
            color: #b45309;
            font-weight: 600;
            background: white;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 13px;
            white-space: nowrap;
        }

        .loop-progress-bar {
            height: 6px;
            background: #fde68a;
            border-radius: 3px;
            overflow: hidden;
        }

        .loop-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%);
            transition: width 0.3s ease;
            border-radius: 3px;
        }

        .loop-code {
            background: white;
            padding: 8px 10px;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
            font-size: 13px;
            color: #1e293b;
            border: 1px solid #fde68a;
            overflow-x: auto;
            white-space: pre;
            line-height: 1.4;
        }

        /* å†å¸°ãƒˆãƒ©ãƒƒã‚«ãƒ¼ */
        .recursion-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .recursion-item {
            background: #f0f9ff;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
        }

        .recursion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            gap: 10px;
            flex-wrap: wrap;
        }

        .recursion-name {
            font-weight: 700;
            color: #1e40af;
            font-size: 15px;
        }

        .recursion-stats {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .stat-badge {
            background: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            color: #475569;
            font-weight: 500;
            border: 1px solid #dbeafe;
        }

        .stat-badge.depth {
            background: #dbeafe;
            color: #1e40af;
            font-weight: 600;
        }

        .recursion-depth-bar {
            background: #dbeafe;
            border-radius: 4px;
            padding: 6px 8px;
            overflow-x: auto;
        }

        .depth-fill {
            color: #3b82f6;
            font-weight: 700;
            font-family: monospace;
            letter-spacing: 1px;
            white-space: nowrap;
            font-size: 14px;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
        @media (max-width: 768px) {
            .playground-content {
                grid-template-columns: 1fr;
            }

            .debug-panels {
                grid-template-columns: 1fr;
            }

            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .section-header h3 {
                font-size: 1.1rem;
            }

            .controls {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(70px, 1fr));
                gap: 6px;
                width: 100%;
            }

            .btn {
                padding: 10px 8px;
                font-size: 0.8rem;
            }

            #code-editor-container {
                height: 350px;
            }

            .CodeMirror {
                height: 350px !important;
            }

            .CodeMirror-scroll {
                min-height: 350px !important;
            }

            #output-area {
                height: 350px;
            }

            .debug-content {
                max-height: 300px;
            }

            .variable-item {
                grid-template-columns: 1fr;
                gap: 5px;
            }

            .var-value {
                text-align: left;
            }
        }

        @media (max-width: 480px) {
            .controls {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .btn {
                padding: 12px 6px;
                font-size: 0.75rem;
            }
        }
    </style>
</Layout>