---
import Layout from '../layouts/Layout.astro';
---

<Layout title="ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ­£è¦åŒ– - ã˜ã‚‡ã†ã»ã†ã‚‰ã„ãµ">
  <div class="container">
    <header class="page-header">
      <h1>ğŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ­£è¦åŒ–ã‚’ä½“é¨“ã—ã‚ˆã†</h1>
      <p class="header-description">
        ãƒã‚¦ã‚¹ã§åˆ—ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ã€å®Ÿéš›ã«æ‰‹ã‚’å‹•ã‹ã—ã¦æ­£è¦åŒ–ã‚’å­¦ã³ã¾ã—ã‚‡ã†
      </p>
    </header>

    <!-- ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ -->
    <div class="toolbar">
      <div class="toolbar-left">
        <button id="new-table-btn" class="btn btn-green">
          <span class="btn-icon">â•</span>
          æ–°ã—ã„ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆ
        </button>
        <button id="reset-btn" class="btn btn-purple">
          <span class="btn-icon">ğŸ”„</span>
          æœ€åˆã«æˆ»ã‚‹
        </button>
      </div>
      <div class="toolbar-right">
        <button id="hint-btn" class="btn btn-yellow">
          <span class="btn-icon">ğŸ’¡</span>
          ãƒ’ãƒ³ãƒˆã‚’è¦‹ã‚‹
        </button>
        <button id="check-btn" class="btn btn-blue">
          <span class="btn-icon">âœ“</span>
          åˆ¤å®šã™ã‚‹
        </button>
      </div>
    </div>

    <!-- èª¬æ˜ã‚«ãƒ¼ãƒ‰ -->
    <div class="usage-card">
      <h2>ğŸ“ ä½¿ã„æ–¹</h2>
      <div class="usage-grid">
        <div class="usage-item">
          <span class="usage-icon">ğŸ‘†</span>
          <div>
            <p class="usage-title">åˆ—ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯</p>
            <p class="usage-desc">åˆ—ã‚’é¸æŠï¼ˆCtrl/Cmdã§è¤‡æ•°é¸æŠï¼‰</p>
          </div>
        </div>
        <div class="usage-item">
          <span class="usage-icon">âœŠ</span>
          <div>
            <p class="usage-title">åˆ—ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ãƒ‰ãƒ©ãƒƒã‚°</p>
            <p class="usage-desc">åˆ¥ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«ç§»å‹•</p>
          </div>
        </div>
        <div class="usage-item">
          <span class="usage-icon">ğŸ”‘</span>
          <div>
            <p class="usage-title">åˆ—ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’å³ã‚¯ãƒªãƒƒã‚¯</p>
            <p class="usage-desc">ä¸»ã‚­ãƒ¼ã«è¨­å®š</p>
          </div>
        </div>
        <div class="usage-item">
          <span class="usage-icon">âœï¸</span>
          <div>
            <p class="usage-title">ãƒ†ãƒ¼ãƒ–ãƒ«åã‚’ã‚¯ãƒªãƒƒã‚¯</p>
            <p class="usage-desc">ãƒ†ãƒ¼ãƒ–ãƒ«åã‚’ç·¨é›†</p>
          </div>
        </div>
      </div>
    </div>

    <!-- ãƒ†ãƒ¼ãƒ–ãƒ«ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div id="tables-container" class="tables-container">
      <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
    </div>

    <!-- ãƒ’ãƒ³ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="hint-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2><span class="modal-icon">ğŸ’¡</span>æ­£è¦åŒ–ã®ãƒ’ãƒ³ãƒˆ</h2>
          <button id="close-hint-btn" class="modal-close">Ã—</button>
        </div>
        <div class="modal-body">
          <div class="hint-card hint-yellow">
            <h3>ğŸ¯ ç›®æ¨™</h3>
            <p>å›³æ›¸é¤¨ã®è²¸ã—å‡ºã—ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã‚’ç¬¬3æ­£è¦å½¢ã¾ã§æ­£è¦åŒ–ã—ã¾ã—ã‚‡ã†</p>
          </div>
          <div class="hint-card hint-blue">
            <h3>ğŸ“‹ ã‚¹ãƒ†ãƒƒãƒ—1: ç¬¬1æ­£è¦å½¢</h3>
            <p>ç¹°ã‚Šè¿”ã—é …ç›®ã‚’æ’é™¤ã—ã¾ã™ã€‚ç¾åœ¨ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã§ã¯ã™ã§ã«ç¬¬1æ­£è¦å½¢ã«ãªã£ã¦ã„ã¾ã™ã€‚</p>
          </div>
          <div class="hint-card hint-green">
            <h3>ğŸ‘¤ ã‚¹ãƒ†ãƒƒãƒ—2: ä¼šå“¡æƒ…å ±ã‚’åˆ†é›¢</h3>
            <ul>
              <li>ã€Œä¼šå“¡ç•ªå·ã€ã€Œä¼šå“¡æ°åã€ã€Œé›»è©±ç•ªå·ã€ã€Œç™»éŒ²æ—¥ã€ã‚’æ–°ã—ã„ãƒ†ãƒ¼ãƒ–ãƒ«ã«ç§»å‹•</li>
              <li>ä¼šå“¡ç•ªå·ã‚’ä¸»ã‚­ãƒ¼ã«è¨­å®šï¼ˆå³ã‚¯ãƒªãƒƒã‚¯ï¼‰</li>
              <li>ãƒ†ãƒ¼ãƒ–ãƒ«åã‚’ã€Œä¼šå“¡ãƒ†ãƒ¼ãƒ–ãƒ«ã€ã«å¤‰æ›´</li>
            </ul>
          </div>
          <div class="hint-card hint-purple">
            <h3>ğŸ“š ã‚¹ãƒ†ãƒƒãƒ—3: æ›¸ç±æƒ…å ±ã‚’åˆ†é›¢</h3>
            <ul>
              <li>ã€ŒISBNã€ã€Œæ›¸ç±åã€ã€Œè‘—è€…ã€ã€Œå‡ºç‰ˆç¤¾ã€ã€Œå‡ºç‰ˆå¹´ã€ã‚’æ–°ã—ã„ãƒ†ãƒ¼ãƒ–ãƒ«ã«ç§»å‹•</li>
              <li>ISBNã‚’ä¸»ã‚­ãƒ¼ã«è¨­å®šï¼ˆå³ã‚¯ãƒªãƒƒã‚¯ï¼‰</li>
              <li>ãƒ†ãƒ¼ãƒ–ãƒ«åã‚’ã€Œæ›¸ç±ãƒ†ãƒ¼ãƒ–ãƒ«ã€ã«å¤‰æ›´</li>
            </ul>
          </div>
          <div class="hint-card hint-orange">
            <h3>ğŸ¢ ã‚¹ãƒ†ãƒƒãƒ—4: å‡ºç‰ˆç¤¾æƒ…å ±ã‚’åˆ†é›¢ï¼ˆç¬¬3æ­£è¦å½¢ï¼‰</h3>
            <ul>
              <li>ã€Œå‡ºç‰ˆç¤¾ã€ã‚’æ–°ã—ã„ãƒ†ãƒ¼ãƒ–ãƒ«ã«ç§»å‹•</li>
              <li>å‡ºç‰ˆç¤¾åã‚’ä¸»ã‚­ãƒ¼ã«è¨­å®šï¼ˆå³ã‚¯ãƒªãƒƒã‚¯ï¼‰</li>
              <li>ãƒ†ãƒ¼ãƒ–ãƒ«åã‚’ã€Œå‡ºç‰ˆç¤¾ãƒ†ãƒ¼ãƒ–ãƒ«ã€ã«å¤‰æ›´</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- çµæœãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="result-modal" class="modal">
      <div class="modal-content modal-result">
        <div class="result-body">
          <div id="result-icon" class="result-icon"></div>
          <h2 id="result-title" class="result-title"></h2>
          <div id="result-message" class="result-message"></div>
          <button id="close-result-btn" class="btn btn-blue btn-large">é–‰ã˜ã‚‹</button>
        </div>
      </div>
    </div>
  </div>

  <style>
    .container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 2rem;
    }

    .page-header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .page-header h1 {
      font-size: clamp(2rem, 5vw, 3rem);
      color: #1e293b;
      margin-bottom: 1rem;
    }

    .header-description {
      font-size: clamp(1rem, 2vw, 1.25rem);
      color: #64748b;
      max-width: 800px;
      margin: 0 auto;
    }

    /* ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ */
    .toolbar {
      background: white;
      border-radius: 1rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      padding: 1rem;
      margin-bottom: 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .toolbar-left, .toolbar-right {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    /* ãƒœã‚¿ãƒ³ */
    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 0.5rem;
      font-weight: bold;
      font-size: 1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.2s;
      color: white;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .btn-icon {
      font-size: 1.25rem;
    }

    .btn-green {
      background: linear-gradient(135deg, #10b981, #059669);
    }

    .btn-purple {
      background: linear-gradient(135deg, #a855f7, #7c3aed);
    }

    .btn-yellow {
      background: linear-gradient(135deg, #f59e0b, #d97706);
    }

    .btn-blue {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
    }

    .btn-large {
      padding: 1rem 2rem;
      font-size: 1.125rem;
    }

    /* ä½¿ã„æ–¹ã‚«ãƒ¼ãƒ‰ */
    .usage-card {
      background: white;
      border-radius: 1rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .usage-card h2 {
      font-size: 1.5rem;
      color: #4f46e5;
      margin-bottom: 1rem;
    }

    .usage-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
    }

    .usage-item {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
    }

    .usage-icon {
      font-size: 2rem;
      flex-shrink: 0;
    }

    .usage-title {
      font-weight: bold;
      color: #1e293b;
      margin-bottom: 0.25rem;
    }

    .usage-desc {
      font-size: 0.875rem;
      color: #64748b;
    }

    /* ãƒ†ãƒ¼ãƒ–ãƒ«ã‚³ãƒ³ãƒ†ãƒŠ */
    .tables-container {
      display: flex;
      flex-direction: column;
      gap: 2rem;
      margin-bottom: 2rem;
    }

    /* ãƒ†ãƒ¼ãƒ–ãƒ«ã‚«ãƒ¼ãƒ‰ */
    .table-card {
      background: white;
      border-radius: 1rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      padding: 1.5rem;
      transition: box-shadow 0.3s;
    }

    .table-card:hover {
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
    }

    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .table-name {
      font-size: 1.5rem;
      font-weight: bold;
      color: #1e293b;
      cursor: pointer;
      transition: color 0.2s;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .table-name:hover {
      color: #4f46e5;
    }

    .delete-btn {
      background: #ef4444;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }

    .delete-btn:hover {
      background: #dc2626;
      transform: scale(1.05);
    }

    /* Excelãƒ©ã‚¤ã‚¯ãªãƒ†ãƒ¼ãƒ–ãƒ« */
    .excel-table-wrapper {
      overflow-x: auto;
      border: 3px solid #94a3b8;
      border-radius: 0.5rem;
      background: white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .excel-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }

    .excel-table th,
    .excel-table td {
      border: 2px solid #94a3b8;
      padding: 0.75rem;
      text-align: left;
      min-width: 100px;
    }

    .excel-table thead th {
      background: #e2e8f0;
      font-weight: bold;
      color: #1e293b;
      position: relative;
      cursor: move;
      user-select: none;
      transition: all 0.2s;
      border-bottom: 3px solid #64748b;
    }

    .excel-table thead th:hover {
      background: #cbd5e1;
    }

    .excel-table thead th.selected {
      background: #bfdbfe;
      border: 3px solid #3b82f6;
      box-shadow: inset 0 0 0 2px #93c5fd;
    }

    .excel-table thead th.primary-key {
      background: #fde68a;
      border: 3px solid #f59e0b;
      font-weight: bold;
      box-shadow: inset 0 0 0 2px #fbbf24;
    }

    .excel-table thead th.primary-key::before {
      content: 'ğŸ”‘ ';
      font-size: 1rem;
    }

    .excel-table thead th.dragging {
      opacity: 0.5;
      cursor: grabbing;
    }

    .excel-table tbody td {
      background: white;
      color: #475569;
      font-size: 0.875rem;
    }

    .excel-table tbody tr:nth-child(even) td {
      background: #f8fafc;
    }

    .excel-table tbody tr {
      border-bottom: 2px solid #cbd5e1;
    }

    .drop-zone {
      min-height: 100px;
      padding: 1rem;
      border: 2px dashed transparent;
      border-radius: 0.5rem;
      transition: all 0.2s;
    }

    .drop-zone.drag-over {
      background: #f0f9ff;
      border-color: #3b82f6;
    }

    .empty-table-message {
      text-align: center;
      padding: 2rem;
      color: #94a3b8;
      font-style: italic;
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      padding: 1rem;
      overflow-y: auto;
    }

    .modal.show {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: white;
      border-radius: 1rem;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.5rem;
      border-bottom: 1px solid #e2e8f0;
    }

    .modal-header h2 {
      font-size: 1.5rem;
      color: #1e293b;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .modal-icon {
      font-size: 2rem;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 2rem;
      color: #64748b;
      cursor: pointer;
      line-height: 1;
      padding: 0;
      width: 2rem;
      height: 2rem;
      transition: color 0.2s;
    }

    .modal-close:hover {
      color: #1e293b;
    }

    .modal-body {
      padding: 1.5rem;
    }

    .hint-card {
      padding: 1rem;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
      border-left: 4px solid;
    }

    .hint-card:last-child {
      margin-bottom: 0;
    }

    .hint-card h3 {
      font-weight: bold;
      margin-bottom: 0.5rem;
    }

    .hint-card ul {
      margin-left: 1.5rem;
      margin-top: 0.5rem;
    }

    .hint-card li {
      margin-bottom: 0.25rem;
    }

    .hint-yellow {
      background: #fef3c7;
      border-color: #f59e0b;
      color: #92400e;
    }

    .hint-blue {
      background: #dbeafe;
      border-color: #3b82f6;
      color: #1e40af;
    }

    .hint-green {
      background: #d1fae5;
      border-color: #10b981;
      color: #065f46;
    }

    .hint-purple {
      background: #ede9fe;
      border-color: #a855f7;
      color: #6b21a8;
    }

    .hint-orange {
      background: #fed7aa;
      border-color: #f97316;
      color: #9a3412;
    }

    /* çµæœãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal-result {
      max-width: 500px;
    }

    .result-body {
      padding: 2rem;
      text-align: center;
    }

    .result-icon {
      font-size: 5rem;
      margin-bottom: 1rem;
    }

    .result-title {
      font-size: 2rem;
      font-weight: bold;
      margin-bottom: 1rem;
    }

    .result-message {
      font-size: 1rem;
      color: #64748b;
      margin-bottom: 1.5rem;
      text-align: left;
    }

    .result-message p {
      margin-bottom: 0.5rem;
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
    @media (max-width: 768px) {
      .container {
        padding: 1rem;
      }

      .toolbar {
        flex-direction: column;
      }

      .toolbar-left, .toolbar-right {
        width: 100%;
        justify-content: center;
      }

      .usage-grid {
        grid-template-columns: 1fr;
      }

      .excel-table {
        font-size: 0.75rem;
      }

      .excel-table th,
      .excel-table td {
        padding: 0.5rem;
        min-width: 80px;
      }
    }
  </style>

  <script>
    // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿
    const sampleData = [
      {
        'è²¸å‡ºID': 'L001',
        'ä¼šå“¡ç•ªå·': 'M001',
        'ä¼šå“¡æ°å': 'ç”°ä¸­å¤ªéƒ',
        'é›»è©±ç•ªå·': '090-1111-2222',
        'ç™»éŒ²æ—¥': '2023-04-01',
        'ISBN': '978-1111',
        'æ›¸ç±å': 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å…¥é–€',
        'è‘—è€…': 'å±±ç”°ä¸€éƒ',
        'å‡ºç‰ˆç¤¾': 'Aå‡ºç‰ˆ',
        'å‡ºç‰ˆå¹´': '2023',
        'è²¸å‡ºæ—¥': '2024-01-10',
        'è¿”å´äºˆå®šæ—¥': '2024-01-24'
      },
      {
        'è²¸å‡ºID': 'L002',
        'ä¼šå“¡ç•ªå·': 'M002',
        'ä¼šå“¡æ°å': 'éˆ´æœ¨èŠ±å­',
        'é›»è©±ç•ªå·': '090-3333-4444',
        'ç™»éŒ²æ—¥': '2023-05-15',
        'ISBN': '978-3333',
        'æ›¸ç±å': 'Pythonå…¥é–€',
        'è‘—è€…': 'é«˜æ©‹ä¸‰éƒ',
        'å‡ºç‰ˆç¤¾': 'Cå‡ºç‰ˆ',
        'å‡ºç‰ˆå¹´': '2023',
        'è²¸å‡ºæ—¥': '2024-01-11',
        'è¿”å´äºˆå®šæ—¥': '2024-01-25'
      }
    ];

    // ãƒ†ãƒ¼ãƒ–ãƒ«ã®åˆæœŸãƒ‡ãƒ¼ã‚¿
    const initialData = {
      tables: [
        {
          id: 1,
          name: 'è²¸å‡ºç®¡ç†ãƒ†ãƒ¼ãƒ–ãƒ«',
          columns: [
            { id: 1, name: 'è²¸å‡ºID', isPrimaryKey: true },
            { id: 2, name: 'ä¼šå“¡ç•ªå·', isPrimaryKey: false },
            { id: 3, name: 'ä¼šå“¡æ°å', isPrimaryKey: false },
            { id: 4, name: 'é›»è©±ç•ªå·', isPrimaryKey: false },
            { id: 5, name: 'ç™»éŒ²æ—¥', isPrimaryKey: false },
            { id: 6, name: 'ISBN', isPrimaryKey: false },
            { id: 7, name: 'æ›¸ç±å', isPrimaryKey: false },
            { id: 8, name: 'è‘—è€…', isPrimaryKey: false },
            { id: 9, name: 'å‡ºç‰ˆç¤¾', isPrimaryKey: false },
            { id: 10, name: 'å‡ºç‰ˆå¹´', isPrimaryKey: false },
            { id: 11, name: 'è²¸å‡ºæ—¥', isPrimaryKey: false },
            { id: 12, name: 'è¿”å´äºˆå®šæ—¥', isPrimaryKey: false }
          ]
        }
      ],
      nextTableId: 2,
      nextColumnId: 13
    };

    let state = JSON.parse(JSON.stringify(initialData));
    let selectedColumns = new Set();
    let draggedColumn = null;
    let draggedFromTable = null;

    // åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', () => {
      renderTables();
      setupEventListeners();
    });

    // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æç”»
    function renderTables() {
      const container = document.getElementById('tables-container');
      container.innerHTML = '';

      state.tables.forEach(table => {
        const tableCard = createTableCard(table);
        container.appendChild(tableCard);
      });
    }

    // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ
    function createTableCard(table) {
      const card = document.createElement('div');
      card.className = 'table-card';

      // ãƒ˜ãƒƒãƒ€ãƒ¼
      const header = document.createElement('div');
      header.className = 'table-header';

      const tableName = document.createElement('div');
      tableName.className = 'table-name';
      tableName.innerHTML = `<span style="font-size: 1.5rem;">ğŸ“‹</span> ${table.name}`;
      header.appendChild(tableName);

      tableName.addEventListener('click', () => {
        const newName = prompt('ãƒ†ãƒ¼ãƒ–ãƒ«åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', table.name);
        if (newName && newName.trim()) {
          const tableObj = state.tables.find(t => t.id === table.id);
          tableObj.name = newName.trim();
          renderTables();
        }
      });

      if (state.tables.length > 1) {
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-btn';
        deleteBtn.textContent = 'ğŸ—‘ï¸ å‰Šé™¤';
        deleteBtn.addEventListener('click', () => {
          if (confirm(`ã€Œ${table.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆåˆ—ã¯æœ€åˆã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«æˆ»ã‚Šã¾ã™ï¼‰`)) {
            deleteTable(table.id);
          }
        });
        header.appendChild(deleteBtn);
      }

      card.appendChild(header);

      // ãƒ†ãƒ¼ãƒ–ãƒ«æœ¬ä½“
      if (table.columns.length === 0) {
        const dropZone = document.createElement('div');
        dropZone.className = 'drop-zone';
        dropZone.dataset.tableId = table.id;
        dropZone.innerHTML = '<div class="empty-table-message">åˆ—ã‚’ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ãã ã•ã„</div>';
        setupDropZone(dropZone, table.id);
        card.appendChild(dropZone);
      } else {
        const wrapper = document.createElement('div');
        wrapper.className = 'excel-table-wrapper drop-zone';
        wrapper.dataset.tableId = table.id;

        const excelTable = document.createElement('table');
        excelTable.className = 'excel-table';

        // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');

        table.columns.forEach(column => {
          const th = document.createElement('th');
          th.textContent = column.name;
          th.dataset.columnId = column.id;
          th.dataset.tableId = table.id;
          th.draggable = true;

          if (selectedColumns.has(column.id)) {
            th.classList.add('selected');
          }
          if (column.isPrimaryKey) {
            th.classList.add('primary-key');
          }

          // ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠ
          th.addEventListener('click', (e) => {
            if (e.ctrlKey || e.metaKey) {
              if (selectedColumns.has(column.id)) {
                selectedColumns.delete(column.id);
              } else {
                selectedColumns.add(column.id);
              }
            } else {
              selectedColumns.clear();
              selectedColumns.add(column.id);
            }
            renderTables();
          });

          // å³ã‚¯ãƒªãƒƒã‚¯ã§ä¸»ã‚­ãƒ¼è¨­å®š
          th.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            togglePrimaryKey(table.id, column.id);
          });

          // ãƒ‰ãƒ©ãƒƒã‚°ã‚¤ãƒ™ãƒ³ãƒˆ
          th.addEventListener('dragstart', (e) => {
            draggedColumn = column.id;
            draggedFromTable = table.id;
            th.classList.add('dragging');

            if (!selectedColumns.has(column.id)) {
              selectedColumns.clear();
              selectedColumns.add(column.id);
            }
          });

          th.addEventListener('dragend', (e) => {
            th.classList.remove('dragging');
            draggedColumn = null;
            draggedFromTable = null;
          });

          headerRow.appendChild(th);
        });

        thead.appendChild(headerRow);
        excelTable.appendChild(thead);

        // ãƒ‡ãƒ¼ã‚¿è¡Œï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼‰
        const tbody = document.createElement('tbody');
        for (let i = 0; i < 2; i++) {
          const row = document.createElement('tr');
          table.columns.forEach(column => {
            const td = document.createElement('td');
            td.textContent = sampleData[i] ? (sampleData[i][column.name] || '---') : '---';
            row.appendChild(td);
          });
          tbody.appendChild(row);
        }

        excelTable.appendChild(tbody);
        wrapper.appendChild(excelTable);
        setupDropZone(wrapper, table.id);
        card.appendChild(wrapper);
      }

      return card;
    }

    // ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    function setupDropZone(element, tableId) {
      element.addEventListener('dragover', (e) => {
        e.preventDefault();
        element.classList.add('drag-over');
      });

      element.addEventListener('dragleave', (e) => {
        if (e.target === element || !element.contains(e.relatedTarget)) {
          element.classList.remove('drag-over');
        }
      });

      element.addEventListener('drop', (e) => {
        e.preventDefault();
        element.classList.remove('drag-over');

        if (draggedFromTable !== tableId) {
          moveColumns(Array.from(selectedColumns), draggedFromTable, tableId);
          selectedColumns.clear();
          renderTables();
        }
      });
    }

    // åˆ—ã‚’ç§»å‹•
    function moveColumns(columnIds, fromTableId, toTableId) {
      const fromTable = state.tables.find(t => t.id === fromTableId);
      const toTable = state.tables.find(t => t.id === toTableId);

      const columnsToMove = fromTable.columns.filter(c => columnIds.includes(c.id));
      fromTable.columns = fromTable.columns.filter(c => !columnIds.includes(c.id));
      toTable.columns = toTable.columns.concat(columnsToMove);
    }

    // ä¸»ã‚­ãƒ¼ã‚’ãƒˆã‚°ãƒ«
    function togglePrimaryKey(tableId, columnId) {
      const table = state.tables.find(t => t.id === tableId);
      const column = table.columns.find(c => c.id === columnId);
      column.isPrimaryKey = !column.isPrimaryKey;
      renderTables();
    }

    // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å‰Šé™¤
    function deleteTable(tableId) {
      const tableToDelete = state.tables.find(t => t.id === tableId);
      const firstTable = state.tables[0];

      if (tableToDelete.id !== firstTable.id) {
        firstTable.columns = firstTable.columns.concat(tableToDelete.columns);
        state.tables = state.tables.filter(t => t.id !== tableId);
        renderTables();
      }
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    function setupEventListeners() {
      // æ–°ã—ã„ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
      document.getElementById('new-table-btn').addEventListener('click', () => {
        const name = prompt('ãƒ†ãƒ¼ãƒ–ãƒ«åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', `æ–°ã—ã„ãƒ†ãƒ¼ãƒ–ãƒ«${state.nextTableId}`);
        if (name && name.trim()) {
          state.tables.push({
            id: state.nextTableId++,
            name: name.trim(),
            columns: []
          });
          renderTables();
        }
      });

      // ãƒªã‚»ãƒƒãƒˆ
      document.getElementById('reset-btn').addEventListener('click', () => {
        if (confirm('æœ€åˆã®çŠ¶æ…‹ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ')) {
          state = JSON.parse(JSON.stringify(initialData));
          selectedColumns.clear();
          renderTables();
        }
      });

      // ãƒ’ãƒ³ãƒˆ
      document.getElementById('hint-btn').addEventListener('click', () => {
        document.getElementById('hint-modal').classList.add('show');
      });

      document.getElementById('close-hint-btn').addEventListener('click', () => {
        document.getElementById('hint-modal').classList.remove('show');
      });

      // åˆ¤å®š
      document.getElementById('check-btn').addEventListener('click', checkNormalization);

      // çµæœãƒ¢ãƒ¼ãƒ€ãƒ«
      document.getElementById('close-result-btn').addEventListener('click', () => {
        document.getElementById('result-modal').classList.remove('show');
      });

      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
      document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            modal.classList.remove('show');
          }
        });
      });
    }

    // æ­£è¦åŒ–ã‚’åˆ¤å®š
    function checkNormalization() {
      const result = {
        score: 0,
        maxScore: 4,
        feedback: []
      };

      if (state.tables.length === 4) {
        result.score++;
        result.feedback.push('âœ… ãƒ†ãƒ¼ãƒ–ãƒ«æ•°ãŒæ­£ã—ã„ï¼ˆ4ã¤ï¼‰');
      } else {
        result.feedback.push(`âŒ ãƒ†ãƒ¼ãƒ–ãƒ«æ•°ãŒ ${state.tables.length} ã¤ã§ã™ã€‚4ã¤ã®ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå¿…è¦ã§ã™`);
      }

      const memberTable = state.tables.find(t =>
        t.name.includes('ä¼šå“¡') &&
        t.columns.some(c => c.name === 'ä¼šå“¡ç•ªå·' && c.isPrimaryKey)
      );
      if (memberTable && memberTable.columns.length === 4) {
        result.score++;
        result.feedback.push('âœ… ä¼šå“¡ãƒ†ãƒ¼ãƒ–ãƒ«ãŒæ­£ã—ãåˆ†é›¢ã•ã‚Œã¦ã„ã¾ã™');
      } else {
        result.feedback.push('âŒ ä¼šå“¡ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ã€ä¼šå“¡ç•ªå·ã€ä¼šå“¡æ°åã€é›»è©±ç•ªå·ã€ç™»éŒ²æ—¥ã‚’å«ã‚ã¦ãã ã•ã„');
      }

      const bookTable = state.tables.find(t =>
        t.name.includes('æ›¸ç±') &&
        t.columns.some(c => c.name === 'ISBN' && c.isPrimaryKey)
      );
      if (bookTable && bookTable.columns.length >= 4) {
        result.score++;
        result.feedback.push('âœ… æ›¸ç±ãƒ†ãƒ¼ãƒ–ãƒ«ãŒæ­£ã—ãåˆ†é›¢ã•ã‚Œã¦ã„ã¾ã™');
      } else {
        result.feedback.push('âŒ æ›¸ç±ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ã€ISBNã€æ›¸ç±åã€è‘—è€…ã€å‡ºç‰ˆç¤¾ã€å‡ºç‰ˆå¹´ã‚’å«ã‚ã¦ãã ã•ã„');
      }

      const publisherTable = state.tables.find(t =>
        t.name.includes('å‡ºç‰ˆç¤¾')
      );
      if (publisherTable && publisherTable.columns.length >= 1) {
        result.score++;
        result.feedback.push('âœ… å‡ºç‰ˆç¤¾ãƒ†ãƒ¼ãƒ–ãƒ«ãŒåˆ†é›¢ã•ã‚Œã€ç¬¬3æ­£è¦å½¢ã«ãªã£ã¦ã„ã¾ã™ï¼');
      } else {
        result.feedback.push('âŒ å‡ºç‰ˆç¤¾æƒ…å ±ã‚’åˆ¥ãƒ†ãƒ¼ãƒ–ãƒ«ã«åˆ†é›¢ã™ã‚‹ã¨ç¬¬3æ­£è¦å½¢ã«ãªã‚Šã¾ã™');
      }

      showResult(result);
    }

    // çµæœã‚’è¡¨ç¤º
    function showResult(result) {
      const modal = document.getElementById('result-modal');
      const icon = document.getElementById('result-icon');
      const title = document.getElementById('result-title');
      const message = document.getElementById('result-message');

      if (result.score === result.maxScore) {
        icon.textContent = 'ğŸ‰';
        title.textContent = 'å®Œç’§ã§ã™ï¼';
        title.style.color = '#10b981';
        message.innerHTML = `
          <p style="font-weight: bold; color: #10b981; margin-bottom: 1rem;">ç¬¬3æ­£è¦å½¢ã®æ­£è¦åŒ–ãŒå®Œäº†ã—ã¾ã—ãŸï¼</p>
          ${result.feedback.map(f => `<p>${f}</p>`).join('')}
        `;
      } else {
        icon.textContent = 'ğŸ“';
        title.textContent = `ã‚¹ã‚³ã‚¢: ${result.score} / ${result.maxScore}`;
        title.style.color = '#4f46e5';
        message.innerHTML = `
          <p style="margin-bottom: 1rem;">ã‚‚ã†å°‘ã—ã§ã™ï¼ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š</p>
          ${result.feedback.map(f => `<p>${f}</p>`).join('')}
        `;
      }

      modal.classList.add('show');
    }
  </script>
</Layout>
