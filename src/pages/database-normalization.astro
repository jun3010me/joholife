---
import Layout from '../layouts/Layout.astro';
---

<Layout title="ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ­£è¦åŒ– - ã˜ã‚‡ã†ã»ã†ã‚‰ã„ãµ">
  <div class="min-h-screen bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 py-12 px-4">
    <div class="max-w-7xl mx-auto">
      <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
      <div class="text-center mb-8">
        <h1 class="text-5xl font-bold text-gray-900 mb-4 flex items-center justify-center gap-3">
          <span class="text-6xl">ğŸ—„ï¸</span>
          ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ­£è¦åŒ–ã‚’ä½“é¨“ã—ã‚ˆã†
        </h1>
        <p class="text-xl text-gray-600 max-w-3xl mx-auto">
          ãƒã‚¦ã‚¹ã‚„ã‚¿ãƒƒãƒã§åˆ—ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ã€å®Ÿéš›ã«æ‰‹ã‚’å‹•ã‹ã—ã¦æ­£è¦åŒ–ã‚’å­¦ã³ã¾ã—ã‚‡ã†
        </p>
      </div>

      <!-- ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ -->
      <div class="bg-white rounded-xl shadow-lg p-4 mb-6 flex flex-wrap gap-4 items-center justify-between">
        <div class="flex gap-3">
          <button id="new-table-btn" class="px-6 py-3 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700 transition-all shadow-md flex items-center gap-2">
            <span class="text-xl">â•</span>
            æ–°ã—ã„ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆ
          </button>
          <button id="reset-btn" class="px-6 py-3 bg-purple-600 text-white rounded-lg font-bold hover:bg-purple-700 transition-all shadow-md flex items-center gap-2">
            <span class="text-xl">ğŸ”„</span>
            æœ€åˆã«æˆ»ã‚‹
          </button>
        </div>
        <div class="flex gap-3">
          <button id="hint-btn" class="px-6 py-3 bg-yellow-500 text-white rounded-lg font-bold hover:bg-yellow-600 transition-all shadow-md flex items-center gap-2">
            <span class="text-xl">ğŸ’¡</span>
            ãƒ’ãƒ³ãƒˆã‚’è¦‹ã‚‹
          </button>
          <button id="check-btn" class="px-6 py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition-all shadow-md flex items-center gap-2">
            <span class="text-xl">âœ“</span>
            åˆ¤å®šã™ã‚‹
          </button>
        </div>
      </div>

      <!-- èª¬æ˜ã‚«ãƒ¼ãƒ‰ -->
      <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
        <h2 class="text-2xl font-bold text-indigo-600 mb-3">ğŸ“ ä½¿ã„æ–¹</h2>
        <div class="grid md:grid-cols-2 gap-4 text-gray-700">
          <div class="flex items-start gap-3">
            <span class="text-2xl">ğŸ‘†</span>
            <div>
              <p class="font-bold">åˆ—ã‚’ã‚¯ãƒªãƒƒã‚¯</p>
              <p class="text-sm">åˆ—ã‚’é¸æŠï¼ˆè¤‡æ•°é¸æŠå¯èƒ½ï¼‰</p>
            </div>
          </div>
          <div class="flex items-start gap-3">
            <span class="text-2xl">âœŠ</span>
            <div>
              <p class="font-bold">åˆ—ã‚’ãƒ‰ãƒ©ãƒƒã‚°</p>
              <p class="text-sm">åˆ¥ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«ç§»å‹•</p>
            </div>
          </div>
          <div class="flex items-start gap-3">
            <span class="text-2xl">ğŸ”‘</span>
            <div>
              <p class="font-bold">å³ã‚¯ãƒªãƒƒã‚¯</p>
              <p class="text-sm">ä¸»ã‚­ãƒ¼ã«è¨­å®š</p>
            </div>
          </div>
          <div class="flex items-start gap-3">
            <span class="text-2xl">âœï¸</span>
            <div>
              <p class="font-bold">ãƒ†ãƒ¼ãƒ–ãƒ«åã‚’ã‚¯ãƒªãƒƒã‚¯</p>
              <p class="text-sm">ãƒ†ãƒ¼ãƒ–ãƒ«åã‚’ç·¨é›†</p>
            </div>
          </div>
        </div>
      </div>

      <!-- ãƒ†ãƒ¼ãƒ–ãƒ«ã‚³ãƒ³ãƒ†ãƒŠ -->
      <div id="tables-container" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
        <!-- ãƒ†ãƒ¼ãƒ–ãƒ«ã‚«ãƒ¼ãƒ‰ã¯JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
      </div>

      <!-- ãƒ’ãƒ³ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
      <div id="hint-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full p-8 max-h-[90vh] overflow-y-auto">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-3xl font-bold text-yellow-600 flex items-center gap-2">
              <span class="text-4xl">ğŸ’¡</span>
              æ­£è¦åŒ–ã®ãƒ’ãƒ³ãƒˆ
            </h2>
            <button id="close-hint-btn" class="text-gray-500 hover:text-gray-700 text-3xl font-bold">Ã—</button>
          </div>
          <div class="space-y-6">
            <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded">
              <h3 class="font-bold text-yellow-800 mb-2">ğŸ¯ ç›®æ¨™</h3>
              <p class="text-yellow-700">å›³æ›¸é¤¨ã®è²¸ã—å‡ºã—ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã‚’ç¬¬3æ­£è¦å½¢ã¾ã§æ­£è¦åŒ–ã—ã¾ã—ã‚‡ã†</p>
            </div>
            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
              <h3 class="font-bold text-blue-800 mb-2">ğŸ“‹ ã‚¹ãƒ†ãƒƒãƒ—1: ç¬¬1æ­£è¦å½¢</h3>
              <p class="text-blue-700 mb-2">ç¹°ã‚Šè¿”ã—é …ç›®ã‚’æ’é™¤ã—ã¾ã™ã€‚ç¾åœ¨ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã§ã¯ã™ã§ã«ç¬¬1æ­£è¦å½¢ã«ãªã£ã¦ã„ã¾ã™ã€‚</p>
            </div>
            <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded">
              <h3 class="font-bold text-green-800 mb-2">ğŸ‘¤ ã‚¹ãƒ†ãƒƒãƒ—2: ä¼šå“¡æƒ…å ±ã‚’åˆ†é›¢</h3>
              <ul class="text-green-700 list-disc list-inside space-y-1">
                <li>ã€Œä¼šå“¡ç•ªå·ã€ã€Œä¼šå“¡æ°åã€ã€Œé›»è©±ç•ªå·ã€ã€Œç™»éŒ²æ—¥ã€ã‚’æ–°ã—ã„ãƒ†ãƒ¼ãƒ–ãƒ«ã«ç§»å‹•</li>
                <li>ä¼šå“¡ç•ªå·ã‚’ä¸»ã‚­ãƒ¼ã«è¨­å®š</li>
                <li>ãƒ†ãƒ¼ãƒ–ãƒ«åã‚’ã€Œä¼šå“¡ãƒ†ãƒ¼ãƒ–ãƒ«ã€ã«å¤‰æ›´</li>
              </ul>
            </div>
            <div class="bg-purple-50 border-l-4 border-purple-500 p-4 rounded">
              <h3 class="font-bold text-purple-800 mb-2">ğŸ“š ã‚¹ãƒ†ãƒƒãƒ—3: æ›¸ç±æƒ…å ±ã‚’åˆ†é›¢</h3>
              <ul class="text-purple-700 list-disc list-inside space-y-1">
                <li>ã€ŒISBNã€ã€Œæ›¸ç±åã€ã€Œè‘—è€…ã€ã€Œå‡ºç‰ˆç¤¾ã€ã€Œå‡ºç‰ˆå¹´ã€ã‚’æ–°ã—ã„ãƒ†ãƒ¼ãƒ–ãƒ«ã«ç§»å‹•</li>
                <li>ISBNã‚’ä¸»ã‚­ãƒ¼ã«è¨­å®š</li>
                <li>ãƒ†ãƒ¼ãƒ–ãƒ«åã‚’ã€Œæ›¸ç±ãƒ†ãƒ¼ãƒ–ãƒ«ã€ã«å¤‰æ›´</li>
              </ul>
            </div>
            <div class="bg-orange-50 border-l-4 border-orange-500 p-4 rounded">
              <h3 class="font-bold text-orange-800 mb-2">ğŸ¢ ã‚¹ãƒ†ãƒƒãƒ—4: å‡ºç‰ˆç¤¾æƒ…å ±ã‚’åˆ†é›¢ï¼ˆç¬¬3æ­£è¦å½¢ï¼‰</h3>
              <ul class="text-orange-700 list-disc list-inside space-y-1">
                <li>ã€Œå‡ºç‰ˆç¤¾ã€ã‚’æ–°ã—ã„ãƒ†ãƒ¼ãƒ–ãƒ«ã«ç§»å‹•</li>
                <li>å‡ºç‰ˆç¤¾åã‚’ä¸»ã‚­ãƒ¼ã«è¨­å®š</li>
                <li>ãƒ†ãƒ¼ãƒ–ãƒ«åã‚’ã€Œå‡ºç‰ˆç¤¾ãƒ†ãƒ¼ãƒ–ãƒ«ã€ã«å¤‰æ›´</li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <!-- çµæœãƒ¢ãƒ¼ãƒ€ãƒ« -->
      <div id="result-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full p-8">
          <div class="text-center">
            <div id="result-icon" class="text-8xl mb-4"></div>
            <h2 id="result-title" class="text-4xl font-bold mb-4"></h2>
            <div id="result-message" class="text-lg text-gray-700 mb-6"></div>
            <button id="close-result-btn" class="px-8 py-4 bg-indigo-600 text-white rounded-xl font-bold text-lg hover:bg-indigo-700 transition-all">
              é–‰ã˜ã‚‹
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  // ãƒ†ãƒ¼ãƒ–ãƒ«ã®åˆæœŸãƒ‡ãƒ¼ã‚¿
  const initialData = {
    tables: [
      {
        id: 1,
        name: 'è²¸å‡ºç®¡ç†ãƒ†ãƒ¼ãƒ–ãƒ«',
        columns: [
          { id: 1, name: 'è²¸å‡ºID', isPrimaryKey: true },
          { id: 2, name: 'ä¼šå“¡ç•ªå·', isPrimaryKey: false },
          { id: 3, name: 'ä¼šå“¡æ°å', isPrimaryKey: false },
          { id: 4, name: 'é›»è©±ç•ªå·', isPrimaryKey: false },
          { id: 5, name: 'ç™»éŒ²æ—¥', isPrimaryKey: false },
          { id: 6, name: 'ISBN', isPrimaryKey: false },
          { id: 7, name: 'æ›¸ç±å', isPrimaryKey: false },
          { id: 8, name: 'è‘—è€…', isPrimaryKey: false },
          { id: 9, name: 'å‡ºç‰ˆç¤¾', isPrimaryKey: false },
          { id: 10, name: 'å‡ºç‰ˆå¹´', isPrimaryKey: false },
          { id: 11, name: 'è²¸å‡ºæ—¥', isPrimaryKey: false },
          { id: 12, name: 'è¿”å´äºˆå®šæ—¥', isPrimaryKey: false }
        ]
      }
    ],
    nextTableId: 2,
    nextColumnId: 13
  };

  let state = JSON.parse(JSON.stringify(initialData));
  let selectedColumns = new Set();
  let draggedColumn = null;
  let draggedFromTable = null;

  // åˆæœŸåŒ–
  document.addEventListener('DOMContentLoaded', () => {
    renderTables();
    setupEventListeners();
  });

  // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æç”»
  function renderTables() {
    const container = document.getElementById('tables-container');
    container.innerHTML = '';

    state.tables.forEach(table => {
      const tableCard = createTableCard(table);
      container.appendChild(tableCard);
    });
  }

  // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ
  function createTableCard(table) {
    const card = document.createElement('div');
    card.className = 'bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition-shadow';
    card.dataset.tableId = table.id;

    const headerHtml = `
      <div class="mb-4 flex justify-between items-center">
        <h3 class="text-xl font-bold text-gray-800 cursor-pointer hover:text-indigo-600 transition-colors table-name" data-table-id="${table.id}">
          ${table.name}
        </h3>
        ${state.tables.length > 1 ? `
          <button class="text-red-500 hover:text-red-700 font-bold delete-table-btn" data-table-id="${table.id}">
            ğŸ—‘ï¸
          </button>
        ` : ''}
      </div>
    `;

    const columnsHtml = `
      <div class="space-y-2 min-h-[100px] table-drop-zone" data-table-id="${table.id}">
        ${table.columns.map(column => `
          <div class="column-item px-4 py-3 rounded-lg border-2 border-gray-200 cursor-move hover:border-indigo-400 transition-all ${selectedColumns.has(column.id) ? 'border-indigo-600 bg-indigo-50' : 'bg-gray-50'} ${column.isPrimaryKey ? 'border-yellow-500 bg-yellow-50' : ''}"
               data-column-id="${column.id}"
               data-table-id="${table.id}"
               draggable="true">
            <div class="flex items-center justify-between">
              <span class="font-semibold ${column.isPrimaryKey ? 'text-yellow-700' : 'text-gray-700'}">
                ${column.isPrimaryKey ? 'ğŸ”‘ ' : ''}${column.name}
              </span>
            </div>
          </div>
        `).join('')}
      </div>
    `;

    card.innerHTML = headerHtml + columnsHtml;

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
    addTableEventListeners(card, table);

    return card;
  }

  // ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
  function addTableEventListeners(card, table) {
    // ãƒ†ãƒ¼ãƒ–ãƒ«åã®ç·¨é›†
    const tableName = card.querySelector('.table-name');
    tableName.addEventListener('click', () => {
      const newName = prompt('ãƒ†ãƒ¼ãƒ–ãƒ«åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', table.name);
      if (newName && newName.trim()) {
        const tableObj = state.tables.find(t => t.id === table.id);
        tableObj.name = newName.trim();
        renderTables();
      }
    });

    // ãƒ†ãƒ¼ãƒ–ãƒ«å‰Šé™¤
    const deleteBtn = card.querySelector('.delete-table-btn');
    if (deleteBtn) {
      deleteBtn.addEventListener('click', () => {
        if (confirm(`ã€Œ${table.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆåˆ—ã¯æœ€åˆã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«æˆ»ã‚Šã¾ã™ï¼‰`)) {
          deleteTable(table.id);
        }
      });
    }

    // åˆ—ã®ã‚¤ãƒ™ãƒ³ãƒˆ
    const columns = card.querySelectorAll('.column-item');
    columns.forEach(columnEl => {
      const columnId = parseInt(columnEl.dataset.columnId);

      // ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠ
      columnEl.addEventListener('click', (e) => {
        if (e.ctrlKey || e.metaKey) {
          // Ctrl/Cmdã‚­ãƒ¼ã§è¤‡æ•°é¸æŠ
          if (selectedColumns.has(columnId)) {
            selectedColumns.delete(columnId);
          } else {
            selectedColumns.add(columnId);
          }
        } else {
          // å˜ä¸€é¸æŠ
          selectedColumns.clear();
          selectedColumns.add(columnId);
        }
        renderTables();
      });

      // å³ã‚¯ãƒªãƒƒã‚¯ã§ä¸»ã‚­ãƒ¼è¨­å®š
      columnEl.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        togglePrimaryKey(table.id, columnId);
      });

      // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹
      columnEl.addEventListener('dragstart', (e) => {
        draggedColumn = columnId;
        draggedFromTable = table.id;
        columnEl.classList.add('opacity-50');

        // é¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆã¯é¸æŠ
        if (!selectedColumns.has(columnId)) {
          selectedColumns.clear();
          selectedColumns.add(columnId);
        }
      });

      // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†
      columnEl.addEventListener('dragend', (e) => {
        columnEl.classList.remove('opacity-50');
        draggedColumn = null;
        draggedFromTable = null;
      });
    });

    // ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³
    const dropZone = card.querySelector('.table-drop-zone');

    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('bg-indigo-100', 'border-2', 'border-dashed', 'border-indigo-400');
    });

    dropZone.addEventListener('dragleave', (e) => {
      dropZone.classList.remove('bg-indigo-100', 'border-2', 'border-dashed', 'border-indigo-400');
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('bg-indigo-100', 'border-2', 'border-dashed', 'border-indigo-400');

      const targetTableId = parseInt(dropZone.dataset.tableId);

      if (draggedFromTable !== targetTableId) {
        moveColumns(Array.from(selectedColumns), draggedFromTable, targetTableId);
        selectedColumns.clear();
      }
    });
  }

  // åˆ—ã‚’ç§»å‹•
  function moveColumns(columnIds, fromTableId, toTableId) {
    const fromTable = state.tables.find(t => t.id === fromTableId);
    const toTable = state.tables.find(t => t.id === toTableId);

    const columnsToMove = fromTable.columns.filter(c => columnIds.includes(c.id));
    fromTable.columns = fromTable.columns.filter(c => !columnIds.includes(c.id));
    toTable.columns = toTable.columns.concat(columnsToMove);

    renderTables();
  }

  // ä¸»ã‚­ãƒ¼ã‚’ãƒˆã‚°ãƒ«
  function togglePrimaryKey(tableId, columnId) {
    const table = state.tables.find(t => t.id === tableId);
    const column = table.columns.find(c => c.id === columnId);
    column.isPrimaryKey = !column.isPrimaryKey;
    renderTables();
  }

  // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å‰Šé™¤
  function deleteTable(tableId) {
    const tableToDelete = state.tables.find(t => t.id === tableId);
    const firstTable = state.tables[0];

    if (tableToDelete.id !== firstTable.id) {
      firstTable.columns = firstTable.columns.concat(tableToDelete.columns);
      state.tables = state.tables.filter(t => t.id !== tableId);
      renderTables();
    }
  }

  // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
  function setupEventListeners() {
    // æ–°ã—ã„ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
    document.getElementById('new-table-btn').addEventListener('click', () => {
      const name = prompt('ãƒ†ãƒ¼ãƒ–ãƒ«åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', `æ–°ã—ã„ãƒ†ãƒ¼ãƒ–ãƒ«${state.nextTableId}`);
      if (name && name.trim()) {
        state.tables.push({
          id: state.nextTableId++,
          name: name.trim(),
          columns: []
        });
        renderTables();
      }
    });

    // ãƒªã‚»ãƒƒãƒˆ
    document.getElementById('reset-btn').addEventListener('click', () => {
      if (confirm('æœ€åˆã®çŠ¶æ…‹ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ')) {
        state = JSON.parse(JSON.stringify(initialData));
        selectedColumns.clear();
        renderTables();
      }
    });

    // ãƒ’ãƒ³ãƒˆ
    document.getElementById('hint-btn').addEventListener('click', () => {
      document.getElementById('hint-modal').classList.remove('hidden');
    });

    document.getElementById('close-hint-btn').addEventListener('click', () => {
      document.getElementById('hint-modal').classList.add('hidden');
    });

    // åˆ¤å®š
    document.getElementById('check-btn').addEventListener('click', checkNormalization);

    // çµæœãƒ¢ãƒ¼ãƒ€ãƒ«
    document.getElementById('close-result-btn').addEventListener('click', () => {
      document.getElementById('result-modal').classList.add('hidden');
    });
  }

  // æ­£è¦åŒ–ã‚’åˆ¤å®š
  function checkNormalization() {
    const result = {
      score: 0,
      maxScore: 4,
      feedback: []
    };

    // ãƒ†ãƒ¼ãƒ–ãƒ«ãŒ4ã¤ã‚ã‚‹ã‹
    if (state.tables.length === 4) {
      result.score++;
      result.feedback.push('âœ… ãƒ†ãƒ¼ãƒ–ãƒ«æ•°ãŒæ­£ã—ã„ï¼ˆ4ã¤ï¼‰');
    } else {
      result.feedback.push(`âŒ ãƒ†ãƒ¼ãƒ–ãƒ«æ•°ãŒ ${state.tables.length} ã¤ã§ã™ã€‚4ã¤ã®ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå¿…è¦ã§ã™`);
    }

    // å„ãƒ†ãƒ¼ãƒ–ãƒ«ã®åˆ—æ•°ã‚’ãƒã‚§ãƒƒã‚¯
    const expectedColumns = {
      'è²¸å‡º': ['è²¸å‡ºID', 'ä¼šå“¡ç•ªå·', 'ISBN', 'è²¸å‡ºæ—¥', 'è¿”å´äºˆå®šæ—¥'],
      'ä¼šå“¡': ['ä¼šå“¡ç•ªå·', 'ä¼šå“¡æ°å', 'é›»è©±ç•ªå·', 'ç™»éŒ²æ—¥'],
      'æ›¸ç±': ['ISBN', 'æ›¸ç±å', 'è‘—è€…', 'å‡ºç‰ˆç¤¾', 'å‡ºç‰ˆå¹´'],
      'å‡ºç‰ˆç¤¾': ['å‡ºç‰ˆç¤¾']
    };

    // ä¼šå“¡ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒã‚§ãƒƒã‚¯
    const memberTable = state.tables.find(t =>
      t.name.includes('ä¼šå“¡') &&
      t.columns.some(c => c.name === 'ä¼šå“¡ç•ªå·' && c.isPrimaryKey)
    );
    if (memberTable && memberTable.columns.length === 4) {
      result.score++;
      result.feedback.push('âœ… ä¼šå“¡ãƒ†ãƒ¼ãƒ–ãƒ«ãŒæ­£ã—ãåˆ†é›¢ã•ã‚Œã¦ã„ã¾ã™');
    } else {
      result.feedback.push('âŒ ä¼šå“¡ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ã€ä¼šå“¡ç•ªå·ã€ä¼šå“¡æ°åã€é›»è©±ç•ªå·ã€ç™»éŒ²æ—¥ã‚’å«ã‚ã¦ãã ã•ã„');
    }

    // æ›¸ç±ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒã‚§ãƒƒã‚¯
    const bookTable = state.tables.find(t =>
      t.name.includes('æ›¸ç±') &&
      t.columns.some(c => c.name === 'ISBN' && c.isPrimaryKey)
    );
    if (bookTable && bookTable.columns.length >= 4) {
      result.score++;
      result.feedback.push('âœ… æ›¸ç±ãƒ†ãƒ¼ãƒ–ãƒ«ãŒæ­£ã—ãåˆ†é›¢ã•ã‚Œã¦ã„ã¾ã™');
    } else {
      result.feedback.push('âŒ æ›¸ç±ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ã€ISBNã€æ›¸ç±åã€è‘—è€…ã€å‡ºç‰ˆç¤¾ã€å‡ºç‰ˆå¹´ã‚’å«ã‚ã¦ãã ã•ã„');
    }

    // å‡ºç‰ˆç¤¾ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒã‚§ãƒƒã‚¯ï¼ˆç¬¬3æ­£è¦å½¢ï¼‰
    const publisherTable = state.tables.find(t =>
      t.name.includes('å‡ºç‰ˆç¤¾')
    );
    if (publisherTable && publisherTable.columns.length >= 1) {
      result.score++;
      result.feedback.push('âœ… å‡ºç‰ˆç¤¾ãƒ†ãƒ¼ãƒ–ãƒ«ãŒåˆ†é›¢ã•ã‚Œã€ç¬¬3æ­£è¦å½¢ã«ãªã£ã¦ã„ã¾ã™ï¼');
    } else {
      result.feedback.push('âŒ å‡ºç‰ˆç¤¾æƒ…å ±ã‚’åˆ¥ãƒ†ãƒ¼ãƒ–ãƒ«ã«åˆ†é›¢ã™ã‚‹ã¨ç¬¬3æ­£è¦å½¢ã«ãªã‚Šã¾ã™');
    }

    // çµæœã‚’è¡¨ç¤º
    showResult(result);
  }

  // çµæœã‚’è¡¨ç¤º
  function showResult(result) {
    const modal = document.getElementById('result-modal');
    const icon = document.getElementById('result-icon');
    const title = document.getElementById('result-title');
    const message = document.getElementById('result-message');

    if (result.score === result.maxScore) {
      icon.textContent = 'ğŸ‰';
      title.textContent = 'å®Œç’§ã§ã™ï¼';
      title.className = 'text-4xl font-bold mb-4 text-green-600';
      message.innerHTML = `
        <p class="text-xl font-bold text-green-600 mb-4">ç¬¬3æ­£è¦å½¢ã®æ­£è¦åŒ–ãŒå®Œäº†ã—ã¾ã—ãŸï¼</p>
        <div class="text-left space-y-2">
          ${result.feedback.map(f => `<p>${f}</p>`).join('')}
        </div>
      `;
    } else {
      icon.textContent = 'ğŸ“';
      title.textContent = `ã‚¹ã‚³ã‚¢: ${result.score} / ${result.maxScore}`;
      title.className = 'text-4xl font-bold mb-4 text-indigo-600';
      message.innerHTML = `
        <p class="mb-4">ã‚‚ã†å°‘ã—ã§ã™ï¼ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š</p>
        <div class="text-left space-y-2">
          ${result.feedback.map(f => `<p>${f}</p>`).join('')}
        </div>
      `;
    }

    modal.classList.remove('hidden');
  }
</script>

<style>
  .table-drop-zone {
    min-height: 150px;
    transition: all 0.2s;
  }

  .column-item {
    user-select: none;
  }

  .column-item:active {
    cursor: grabbing;
  }
</style>
</Layout>
