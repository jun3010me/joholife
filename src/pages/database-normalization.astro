---
import Layout from '../layouts/Layout.astro';
---

<Layout title="データベース正規化 - じょうほうらいふ">
  <div class="min-h-screen bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 py-12 px-4">
    <div class="max-w-7xl mx-auto">
      <!-- ヘッダー -->
      <div class="text-center mb-12">
        <h1 class="text-5xl font-bold text-gray-900 mb-4 flex items-center justify-center gap-3">
          <span class="text-6xl">🗄️</span>
          データベース正規化を学ぼう
        </h1>
        <p class="text-xl text-gray-600 max-w-3xl mx-auto">
          図書館の貸し出し管理システムを例に、リレーショナルデータベースの正規化を視覚的に理解しましょう
        </p>
      </div>

      <!-- プログレスバー -->
      <div class="mb-8">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-2">
            <div class="w-10 h-10 rounded-full bg-indigo-600 text-white flex items-center justify-center font-bold step-indicator" data-step="0">0</div>
            <span class="font-semibold text-gray-700 step-label" data-step="0">非正規形</span>
          </div>
          <div class="flex-1 h-1 bg-gray-300 mx-4 progress-line" data-line="1"></div>
          <div class="flex items-center gap-2">
            <div class="w-10 h-10 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center font-bold step-indicator" data-step="1">1</div>
            <span class="font-semibold text-gray-500 step-label" data-step="1">第1正規形</span>
          </div>
          <div class="flex-1 h-1 bg-gray-300 mx-4 progress-line" data-line="2"></div>
          <div class="flex items-center gap-2">
            <div class="w-10 h-10 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center font-bold step-indicator" data-step="2">2</div>
            <span class="font-semibold text-gray-500 step-label" data-step="2">第2正規形</span>
          </div>
          <div class="flex-1 h-1 bg-gray-300 mx-4 progress-line" data-line="3"></div>
          <div class="flex items-center gap-2">
            <div class="w-10 h-10 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center font-bold step-indicator" data-step="3">3</div>
            <span class="font-semibold text-gray-500 step-label" data-step="3">第3正規形</span>
          </div>
        </div>
      </div>

      <!-- 説明カード -->
      <div class="bg-white rounded-2xl shadow-xl p-8 mb-8" id="explanation-card">
        <h2 class="text-3xl font-bold text-indigo-600 mb-4" id="step-title">非正規形（正規化前）</h2>
        <div class="prose max-w-none" id="step-description">
          <p class="text-lg text-gray-700 mb-4">
            これは図書館の貸し出し管理システムのデータです。1つの行に複数の書籍情報が含まれており、データの重複や更新の不整合が発生しやすい状態です。
          </p>
          <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-4">
            <p class="font-semibold text-red-800">❌ 問題点：</p>
            <ul class="list-disc list-inside text-red-700 mt-2 space-y-1">
              <li>1つのセルに複数の値が入っている（繰り返し項目）</li>
              <li>データの追加・更新・削除が複雑</li>
              <li>検索や集計が困難</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- テーブル表示エリア -->
      <div class="bg-white rounded-2xl shadow-xl p-8 mb-8" id="table-container">
        <!-- テーブルはJavaScriptで動的に生成 -->
      </div>

      <!-- コントロールボタン -->
      <div class="flex justify-center gap-4 mb-8">
        <button id="prev-btn" class="px-8 py-4 bg-gray-400 text-white rounded-xl font-bold text-lg shadow-lg hover:bg-gray-500 transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled>
          ← 前のステップ
        </button>
        <button id="reset-btn" class="px-8 py-4 bg-purple-600 text-white rounded-xl font-bold text-lg shadow-lg hover:bg-purple-700 transition-all">
          🔄 最初に戻る
        </button>
        <button id="next-btn" class="px-8 py-4 bg-indigo-600 text-white rounded-xl font-bold text-lg shadow-lg hover:bg-indigo-700 transition-all">
          次のステップ →
        </button>
      </div>

      <!-- 学習ポイント -->
      <div class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-2xl shadow-xl p-8 text-white">
        <h3 class="text-2xl font-bold mb-4">📚 正規化を学ぶメリット</h3>
        <div class="grid md:grid-cols-3 gap-6">
          <div class="bg-white bg-opacity-20 rounded-xl p-6 backdrop-blur-sm">
            <div class="text-4xl mb-3">✨</div>
            <h4 class="font-bold text-lg mb-2">データの整合性</h4>
            <p class="text-sm">データの重複を排除し、更新時の不整合を防ぎます</p>
          </div>
          <div class="bg-white bg-opacity-20 rounded-xl p-6 backdrop-blur-sm">
            <div class="text-4xl mb-3">🚀</div>
            <h4 class="font-bold text-lg mb-2">効率的な管理</h4>
            <p class="text-sm">データの追加・更新・削除が簡単になります</p>
          </div>
          <div class="bg-white bg-opacity-20 rounded-xl p-6 backdrop-blur-sm">
            <div class="text-4xl mb-3">🔍</div>
            <h4 class="font-bold text-lg mb-2">検索の高速化</h4>
            <p class="text-sm">適切な構造により検索や集計が効率的になります</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  // 正規化のステップデータ
  const steps = [
    {
      step: 0,
      title: '非正規形（正規化前）',
      description: `
        <p class="text-lg text-gray-700 mb-4">
          これは図書館の貸し出し管理システムのデータです。1つの行に複数の書籍情報が含まれており、データの重複や更新の不整合が発生しやすい状態です。
        </p>
        <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-4">
          <p class="font-semibold text-red-800">❌ 問題点：</p>
          <ul class="list-disc list-inside text-red-700 mt-2 space-y-1">
            <li>1つのセルに複数の値が入っている（繰り返し項目）</li>
            <li>データの追加・更新・削除が複雑</li>
            <li>検索や集計が困難</li>
          </ul>
        </div>
      `,
      tables: [
        {
          name: '貸出管理テーブル',
          headers: ['貸出ID', '会員番号', '会員氏名', '書籍名', '著者', '出版社', 'ISBN', '貸出日', '返却予定日'],
          rows: [
            ['L001', 'M001', '田中太郎', 'データベース入門, SQL基礎', '山田一郎, 佐藤次郎', 'A出版, B出版', '978-1111, 978-2222', '2024-01-10', '2024-01-24'],
            ['L002', 'M002', '鈴木花子', 'Python入門', '高橋三郎', 'C出版', '978-3333', '2024-01-11', '2024-01-25'],
            ['L003', 'M001', '田中太郎', 'Web技術, ネットワーク', '伊藤四郎, 渡辺五郎', 'A出版, D出版', '978-4444, 978-5555', '2024-01-12', '2024-01-26']
          ],
          highlight: ['書籍名', '著者', '出版社', 'ISBN']
        }
      ]
    },
    {
      step: 1,
      title: '第1正規形（1NF）',
      description: `
        <p class="text-lg text-gray-700 mb-4">
          繰り返し項目を排除し、各セルに1つの値のみを格納するようにしました。複数の書籍を借りた場合は、行を分けて記録します。
        </p>
        <div class="bg-green-50 border-l-4 border-green-500 p-4 mb-4">
          <p class="font-semibold text-green-800">✅ 改善点：</p>
          <ul class="list-disc list-inside text-green-700 mt-2 space-y-1">
            <li>各セルに1つの値のみが格納される（原子性の確保）</li>
            <li>繰り返し項目が排除された</li>
            <li>各行が一意に識別できる</li>
          </ul>
        </div>
        <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4">
          <p class="font-semibold text-yellow-800">⚠️ まだ残る問題：</p>
          <ul class="list-disc list-inside text-yellow-700 mt-2 space-y-1">
            <li>会員情報が重複している（田中太郎が2回出現）</li>
            <li>書籍情報が重複する可能性がある</li>
          </ul>
        </div>
      `,
      tables: [
        {
          name: '貸出管理テーブル（第1正規形）',
          headers: ['貸出ID', '会員番号', '会員氏名', '書籍名', '著者', '出版社', 'ISBN', '貸出日', '返却予定日'],
          rows: [
            ['L001-1', 'M001', '田中太郎', 'データベース入門', '山田一郎', 'A出版', '978-1111', '2024-01-10', '2024-01-24'],
            ['L001-2', 'M001', '田中太郎', 'SQL基礎', '佐藤次郎', 'B出版', '978-2222', '2024-01-10', '2024-01-24'],
            ['L002-1', 'M002', '鈴木花子', 'Python入門', '高橋三郎', 'C出版', '978-3333', '2024-01-11', '2024-01-25'],
            ['L003-1', 'M001', '田中太郎', 'Web技術', '伊藤四郎', 'A出版', '978-4444', '2024-01-12', '2024-01-26'],
            ['L003-2', 'M001', '田中太郎', 'ネットワーク', '渡辺五郎', 'D出版', '978-5555', '2024-01-12', '2024-01-26']
          ],
          highlight: ['会員番号', '会員氏名']
        }
      ]
    },
    {
      step: 2,
      title: '第2正規形（2NF）',
      description: `
        <p class="text-lg text-gray-700 mb-4">
          部分関数従属を排除し、テーブルを分割しました。会員情報と書籍情報を別のテーブルに分離することで、データの重複を減らしました。
        </p>
        <div class="bg-green-50 border-l-4 border-green-500 p-4 mb-4">
          <p class="font-semibold text-green-800">✅ 改善点：</p>
          <ul class="list-disc list-inside text-green-700 mt-2 space-y-1">
            <li>部分関数従属が排除された</li>
            <li>会員情報が1箇所で管理される（重複なし）</li>
            <li>書籍情報が1箇所で管理される（重複なし）</li>
            <li>貸出テーブルは関係のみを管理</li>
          </ul>
        </div>
        <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4">
          <p class="font-semibold text-yellow-800">⚠️ まだ残る問題：</p>
          <ul class="list-disc list-inside text-yellow-700 mt-2 space-y-1">
            <li>書籍テーブルに出版社名が含まれている</li>
            <li>同じ出版社が複数回登場する可能性がある</li>
          </ul>
        </div>
      `,
      tables: [
        {
          name: '貸出テーブル',
          headers: ['貸出ID', '会員番号', 'ISBN', '貸出日', '返却予定日'],
          rows: [
            ['L001-1', 'M001', '978-1111', '2024-01-10', '2024-01-24'],
            ['L001-2', 'M001', '978-2222', '2024-01-10', '2024-01-24'],
            ['L002-1', 'M002', '978-3333', '2024-01-11', '2024-01-25'],
            ['L003-1', 'M001', '978-4444', '2024-01-12', '2024-01-26'],
            ['L003-2', 'M001', '978-5555', '2024-01-12', '2024-01-26']
          ],
          highlight: []
        },
        {
          name: '会員テーブル',
          headers: ['会員番号', '会員氏名', '電話番号', '登録日'],
          rows: [
            ['M001', '田中太郎', '090-1111-2222', '2023-04-01'],
            ['M002', '鈴木花子', '090-3333-4444', '2023-05-15']
          ],
          highlight: []
        },
        {
          name: '書籍テーブル',
          headers: ['ISBN', '書籍名', '著者', '出版社', '出版年'],
          rows: [
            ['978-1111', 'データベース入門', '山田一郎', 'A出版', '2023'],
            ['978-2222', 'SQL基礎', '佐藤次郎', 'B出版', '2022'],
            ['978-3333', 'Python入門', '高橋三郎', 'C出版', '2023'],
            ['978-4444', 'Web技術', '伊藤四郎', 'A出版', '2024'],
            ['978-5555', 'ネットワーク', '渡辺五郎', 'D出版', '2023']
          ],
          highlight: ['出版社']
        }
      ]
    },
    {
      step: 3,
      title: '第3正規形（3NF）',
      description: `
        <p class="text-lg text-gray-700 mb-4">
          推移的関数従属を排除し、出版社情報を別テーブルに分離しました。これにより、データベースが最も効率的で整合性の高い状態になりました。
        </p>
        <div class="bg-green-50 border-l-4 border-green-500 p-4 mb-4">
          <p class="font-semibold text-green-800">✅ 改善点：</p>
          <ul class="list-disc list-inside text-green-700 mt-2 space-y-1">
            <li>推移的関数従属が排除された</li>
            <li>出版社情報が1箇所で管理される</li>
            <li>データの重複が完全に排除された</li>
            <li>更新の不整合が発生しない</li>
            <li>データの追加・更新・削除が簡単</li>
          </ul>
        </div>
        <div class="bg-blue-50 border-l-4 border-blue-500 p-4">
          <p class="font-semibold text-blue-800">🎉 正規化完了！</p>
          <p class="text-blue-700 mt-2">
            これで、データベースは効率的で整合性の高い状態になりました。実際のシステム開発では、このように正規化を行ってからテーブル設計を行います。
          </p>
        </div>
      `,
      tables: [
        {
          name: '貸出テーブル',
          headers: ['貸出ID', '会員番号', 'ISBN', '貸出日', '返却予定日'],
          rows: [
            ['L001-1', 'M001', '978-1111', '2024-01-10', '2024-01-24'],
            ['L001-2', 'M001', '978-2222', '2024-01-10', '2024-01-24'],
            ['L002-1', 'M002', '978-3333', '2024-01-11', '2024-01-25'],
            ['L003-1', 'M001', '978-4444', '2024-01-12', '2024-01-26'],
            ['L003-2', 'M001', '978-5555', '2024-01-12', '2024-01-26']
          ],
          highlight: []
        },
        {
          name: '会員テーブル',
          headers: ['会員番号', '会員氏名', '電話番号', '登録日'],
          rows: [
            ['M001', '田中太郎', '090-1111-2222', '2023-04-01'],
            ['M002', '鈴木花子', '090-3333-4444', '2023-05-15']
          ],
          highlight: []
        },
        {
          name: '書籍テーブル',
          headers: ['ISBN', '書籍名', '著者', '出版社コード', '出版年'],
          rows: [
            ['978-1111', 'データベース入門', '山田一郎', 'P001', '2023'],
            ['978-2222', 'SQL基礎', '佐藤次郎', 'P002', '2022'],
            ['978-3333', 'Python入門', '高橋三郎', 'P003', '2023'],
            ['978-4444', 'Web技術', '伊藤四郎', 'P001', '2024'],
            ['978-5555', 'ネットワーク', '渡辺五郎', 'P004', '2023']
          ],
          highlight: ['出版社コード']
        },
        {
          name: '出版社テーブル',
          headers: ['出版社コード', '出版社名', '電話番号', '住所'],
          rows: [
            ['P001', 'A出版', '03-1111-2222', '東京都千代田区'],
            ['P002', 'B出版', '03-3333-4444', '東京都港区'],
            ['P003', 'C出版', '06-5555-6666', '大阪府大阪市'],
            ['P004', 'D出版', '03-7777-8888', '東京都新宿区']
          ],
          highlight: []
        }
      ]
    }
  ];

  let currentStep = 0;

  // 初期化
  document.addEventListener('DOMContentLoaded', () => {
    renderStep(currentStep);
    updateProgress();
  });

  // ステップを描画
  function renderStep(stepIndex) {
    const step = steps[stepIndex];

    // タイトルと説明を更新
    document.getElementById('step-title').textContent = step.title;
    document.getElementById('step-description').innerHTML = step.description;

    // テーブルを描画
    const container = document.getElementById('table-container');
    container.innerHTML = '';

    step.tables.forEach((table, index) => {
      const tableDiv = document.createElement('div');
      tableDiv.className = 'mb-8 last:mb-0 opacity-0 transform translate-y-4 transition-all duration-500';

      const tableHtml = `
        <h3 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
          <span class="text-3xl">${index === 0 ? '📋' : index === 1 ? '👤' : index === 2 ? '📚' : '🏢'}</span>
          ${table.name}
        </h3>
        <div class="overflow-x-auto">
          <table class="min-w-full border-collapse border-2 border-gray-300 shadow-lg">
            <thead>
              <tr class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white">
                ${table.headers.map(header => `
                  <th class="border-2 border-gray-300 px-4 py-3 font-bold text-left ${table.highlight.includes(header) ? 'bg-yellow-500 bg-opacity-30' : ''}">
                    ${header}
                  </th>
                `).join('')}
              </tr>
            </thead>
            <tbody>
              ${table.rows.map((row, rowIndex) => `
                <tr class="${rowIndex % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-indigo-50 transition-colors">
                  ${row.map((cell, cellIndex) => `
                    <td class="border border-gray-300 px-4 py-3 ${table.highlight.includes(table.headers[cellIndex]) ? 'bg-yellow-100 font-semibold' : ''}">
                      ${cell}
                    </td>
                  `).join('')}
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;

      tableDiv.innerHTML = tableHtml;
      container.appendChild(tableDiv);

      // アニメーション
      setTimeout(() => {
        tableDiv.classList.remove('opacity-0', 'translate-y-4');
        tableDiv.classList.add('opacity-100', 'translate-y-0');
      }, index * 200);
    });

    // ボタンの状態を更新
    document.getElementById('prev-btn').disabled = stepIndex === 0;
    document.getElementById('next-btn').disabled = stepIndex === steps.length - 1;

    if (stepIndex === steps.length - 1) {
      document.getElementById('next-btn').textContent = '✅ 完了';
    } else {
      document.getElementById('next-btn').textContent = '次のステップ →';
    }
  }

  // プログレスバーを更新
  function updateProgress() {
    // すべてのステップインジケーターとラベルをリセット
    document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
      if (index <= currentStep) {
        indicator.classList.remove('bg-gray-300', 'text-gray-600');
        indicator.classList.add('bg-indigo-600', 'text-white');
      } else {
        indicator.classList.remove('bg-indigo-600', 'text-white');
        indicator.classList.add('bg-gray-300', 'text-gray-600');
      }
    });

    document.querySelectorAll('.step-label').forEach((label, index) => {
      if (index <= currentStep) {
        label.classList.remove('text-gray-500');
        label.classList.add('text-gray-700', 'font-bold');
      } else {
        label.classList.remove('text-gray-700', 'font-bold');
        label.classList.add('text-gray-500');
      }
    });

    // プログレスラインを更新
    document.querySelectorAll('.progress-line').forEach((line, index) => {
      if (index < currentStep) {
        line.classList.remove('bg-gray-300');
        line.classList.add('bg-indigo-600');
      } else {
        line.classList.remove('bg-indigo-600');
        line.classList.add('bg-gray-300');
      }
    });
  }

  // イベントリスナー
  document.getElementById('next-btn').addEventListener('click', () => {
    if (currentStep < steps.length - 1) {
      currentStep++;
      renderStep(currentStep);
      updateProgress();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  });

  document.getElementById('prev-btn').addEventListener('click', () => {
    if (currentStep > 0) {
      currentStep--;
      renderStep(currentStep);
      updateProgress();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  });

  document.getElementById('reset-btn').addEventListener('click', () => {
    currentStep = 0;
    renderStep(currentStep);
    updateProgress();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });
</script>

<style>
  .prose {
    max-width: none;
  }

  table {
    font-size: 0.95rem;
  }

  @media (max-width: 768px) {
    table {
      font-size: 0.85rem;
    }

    th, td {
      padding: 0.5rem !important;
    }
  }
</style>
</Layout>
