// „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
let currentTab = 'resolution';
let pixelGrid = [];
let currentProblem = 0;
let currentLevel = 1;
let correctCount = 0;
let totalCount = 0;
let problemsAnswered = new Set(); // Ëß£Á≠îÊ∏à„ÅøÂïèÈ°å„ÇíËøΩË∑°
let correctProblems = new Set(); // Ê≠£Ëß£„Åó„ÅüÂïèÈ°å„ÇíËøΩË∑°

// Á∑¥ÁøíÂïèÈ°å„Éá„Éº„Çø
const problems = {
    1: [
        {
            question: "8√ó8„Éî„ÇØ„Çª„É´„ÄÅ24„Éì„ÉÉ„Éà„Ç´„É©„Éº„ÅÆÁîªÂÉè„ÅÆ„Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„ÇíË®àÁÆó„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
            width: 8,
            height: 8,
            colorDepth: 24,
            answer: 192,
            unit: "bytes",
            hint: "ÊâãÈ†ÜÔºö‚ë†Á∑è„Éî„ÇØ„Çª„É´Êï∞„ÇíË®àÁÆóÔºàÂπÖ√óÈ´ò„ÅïÔºâ‚ë°1„Éî„ÇØ„Çª„É´„ÅÆ„Éê„Ç§„ÉàÊï∞„ÇíË®àÁÆóÔºà24„Éì„ÉÉ„Éà√∑8Ôºâ‚ë¢Á∑è„Éê„Ç§„ÉàÊï∞„ÇíË®àÁÆóÔºà‚ë†√ó‚ë°Ôºâ"
        },
        {
            question: "16√ó16„Éî„ÇØ„Çª„É´„ÄÅ8„Éì„ÉÉ„Éà„Ç´„É©„Éº„ÅÆÁîªÂÉè„ÅÆ„Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„ÇíË®àÁÆó„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
            width: 16,
            height: 16,
            colorDepth: 8,
            answer: 256,
            unit: "bytes",
            hint: "ÊâãÈ†ÜÔºö‚ë†16√ó16„ÅßÁ∑è„Éî„ÇØ„Çª„É´Êï∞„ÇíÊ±Ç„ÇÅ„Çã‚ë°8„Éì„ÉÉ„Éà√∑8„Åß1„Éî„ÇØ„Çª„É´„ÅÆ„Éê„Ç§„ÉàÊï∞„ÇíÊ±Ç„ÇÅ„Çã‚ë¢‚ë†√ó‚ë°„ÅßÁ∑è„Éê„Ç§„ÉàÊï∞„ÇíË®àÁÆó"
        }
    ],
    2: [
        {
            question: "256√ó128„Éî„ÇØ„Çª„É´„ÄÅ24„Éì„ÉÉ„Éà„Ç´„É©„Éº„ÅÆÁîªÂÉè„ÅÆ„Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„ÇíKBÂçò‰Ωç„ÅßË®àÁÆó„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
            width: 256,
            height: 128,
            colorDepth: 24,
            answer: 96,
            unit: "kb",
            hint: "ÊâãÈ†ÜÔºö‚ë†256√ó128„ÅßÁ∑è„Éî„ÇØ„Çª„É´Êï∞‚ë°24√∑8„Åß1„Éî„ÇØ„Çª„É´„ÅÆ„Éê„Ç§„ÉàÊï∞‚ë¢Á∑è„Éê„Ç§„ÉàÊï∞„ÇíË®àÁÆó‚ë£„Éê„Ç§„Éà„ÇíKB„Å´Â§âÊèõÔºà√∑1024Ôºâ"
        },
        {
            question: "512√ó256„Éî„ÇØ„Çª„É´„ÄÅ8„Éì„ÉÉ„Éà„Ç´„É©„Éº„ÅÆÁîªÂÉè„ÅÆ„Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„ÇíKBÂçò‰Ωç„ÅßË®àÁÆó„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
            width: 512,
            height: 256,
            colorDepth: 8,
            answer: 128,
            unit: "kb",
            hint: "ÊâãÈ†ÜÔºö‚ë†512√ó256„ÅßÁ∑è„Éî„ÇØ„Çª„É´Êï∞‚ë°8√∑8„Åß1„Éî„ÇØ„Çª„É´„ÅÆ„Éê„Ç§„ÉàÊï∞‚ë¢Á∑è„Éê„Ç§„ÉàÊï∞„ÇíË®àÁÆó‚ë£„Éê„Ç§„Éà„ÇíKB„Å´Â§âÊèõÔºà√∑1024Ôºâ"
        }
    ],
    3: [
        {
            question: "512√ó512„Éî„ÇØ„Çª„É´„ÄÅ24„Éì„ÉÉ„Éà„Ç´„É©„Éº„ÅÆÁîªÂÉè„ÅÆ„Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„ÇíKBÂçò‰Ωç„ÅßË®àÁÆó„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
            width: 512,
            height: 512,
            colorDepth: 24,
            answer: 768,
            unit: "kb",
            hint: "ÊâãÈ†ÜÔºö‚ë†512√ó512„ÅßÁ∑è„Éî„ÇØ„Çª„É´Êï∞Ôºà512„ÅÆ‰∫å‰πóÔºâ‚ë°24√∑8„Åß1„Éî„ÇØ„Çª„É´„ÅÆ„Éê„Ç§„ÉàÊï∞‚ë¢Á∑è„Éê„Ç§„ÉàÊï∞„ÇíË®àÁÆó‚ë£√∑1024„ÅßKB„Å´Â§âÊèõ"
        },
        {
            question: "1024√ó1024„Éî„ÇØ„Çª„É´„ÄÅ8„Éì„ÉÉ„Éà„Ç´„É©„Éº„ÅÆÁîªÂÉè„ÅÆ„Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„ÇíMBÂçò‰Ωç„ÅßË®àÁÆó„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
            width: 1024,
            height: 1024,
            colorDepth: 8,
            answer: 1,
            unit: "mb",
            hint: "ÊâãÈ†ÜÔºö‚ë†1024√ó1024„ÅßÁ∑è„Éî„ÇØ„Çª„É´Êï∞‚ë°8√∑8„Åß1„Éî„ÇØ„Çª„É´„ÅÆ„Éê„Ç§„ÉàÊï∞‚ë¢Á∑è„Éê„Ç§„ÉàÊï∞„ÇíË®àÁÆó‚ë£√∑1024√∑1024„ÅßMB„Å´Â§âÊèõ"
        }
    ],
    4: [
        {
            question: "1024√ó512„Éî„ÇØ„Çª„É´„ÄÅ24„Éì„ÉÉ„Éà„Ç´„É©„Éº„ÅÆÁîªÂÉè„ÅÆ„Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„ÇíMBÂçò‰Ωç„ÅßË®àÁÆó„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
            width: 1024,
            height: 512,
            colorDepth: 24,
            answer: 1.5,
            unit: "mb",
            hint: "ÊâãÈ†ÜÔºö‚ë†1024√ó512„ÅßÁ∑è„Éî„ÇØ„Çª„É´Êï∞‚ë°24√∑8„Åß1„Éî„ÇØ„Çª„É´„ÅÆ„Éê„Ç§„ÉàÊï∞‚ë¢Á∑è„Éê„Ç§„ÉàÊï∞„ÇíË®àÁÆó‚ë£√∑1024„ÅßKB‚ë§√∑1024„ÅßMB„Å´Â§âÊèõ"
        },
        {
            question: "2048√ó1024„Éî„ÇØ„Çª„É´„ÄÅ8„Éì„ÉÉ„Éà„Ç´„É©„Éº„ÅÆÁîªÂÉè„ÅÆ„Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„ÇíMBÂçò‰Ωç„ÅßË®àÁÆó„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
            width: 2048,
            height: 1024,
            colorDepth: 8,
            answer: 2,
            unit: "mb",
            hint: "ÊâãÈ†ÜÔºö‚ë†2048√ó1024„ÅßÁ∑è„Éî„ÇØ„Çª„É´Êï∞‚ë°8√∑8„Åß1„Éî„ÇØ„Çª„É´„ÅÆ„Éê„Ç§„ÉàÊï∞‚ë¢Á∑è„Éê„Ç§„ÉàÊï∞„ÇíË®àÁÆó‚ë£√∑1024√∑1024„ÅßMB„Å´Â§âÊèõ"
        }
    ]
};

// ÂàùÊúüÂåñ
document.addEventListener('DOMContentLoaded', function() {
    initializeApp();
});

function initializeApp() {
    setupTabNavigation();
    setupCalculator();
    setupPixelDisplay();
    setupColorDepthComparison();
    setupPracticeProblems();
}

// „Çø„Éñ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥
function setupTabNavigation() {
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');

    tabButtons.forEach(button => {
        button.addEventListener('click', function() {
            const targetTab = this.dataset.tab;
            
            // „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Çø„Éñ„ÇíÊõ¥Êñ∞
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            
            this.classList.add('active');
            document.getElementById(targetTab + '-tab').classList.add('active');
            
            currentTab = targetTab;
            
            // „Çø„ÉñÂàá„ÇäÊõø„ÅàÊôÇ„ÅÆÂàùÊúüÂåñÂá¶ÁêÜ
            if (targetTab === 'pixel') {
                drawPixelGrid();
            } else if (targetTab === 'color-depth') {
                updateColorDepthComparison();
            }
        });
    });
}

// „Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫Ë®àÁÆóÊ©ü
function setupCalculator() {
    const widthInput = document.getElementById('width-input');
    const heightInput = document.getElementById('height-input');
    const colorDepthInput = document.getElementById('color-depth-input');

    [widthInput, heightInput, colorDepthInput].forEach(input => {
        input.addEventListener('input', updateCalculation);
    });

    updateCalculation();
}

function updateCalculation() {
    const width = parseInt(document.getElementById('width-input').value) || 0;
    const height = parseInt(document.getElementById('height-input').value) || 0;
    const colorDepth = parseInt(document.getElementById('color-depth-input').value) || 0;

    // Ë®àÁÆóÈÅéÁ®ã„ÇíÊõ¥Êñ∞
    const totalPixels = width * height;
    const bytesPerPixel = colorDepth / 8;
    const totalBytes = totalPixels * bytesPerPixel;
    const totalMB = totalBytes / (1024 * 1024);

    // Ë°®Á§∫„ÇíÊõ¥Êñ∞
    document.getElementById('pixel-total').textContent = 
        `${width.toLocaleString()} √ó ${height.toLocaleString()} = ${totalPixels.toLocaleString()} „Éî„ÇØ„Çª„É´`;
    
    document.getElementById('bytes-per-pixel').textContent = 
        `${colorDepth}„Éì„ÉÉ„Éà √∑ 8 = ${bytesPerPixel} „Éê„Ç§„Éà/„Éî„ÇØ„Çª„É´`;
    
    document.getElementById('total-bytes').textContent = 
        `${totalPixels.toLocaleString()} √ó ${bytesPerPixel} = ${totalBytes.toLocaleString()} „Éê„Ç§„Éà`;
    
    document.getElementById('total-mb').textContent = 
        `${totalBytes.toLocaleString()} √∑ 1,048,576 = ${totalMB.toFixed(2)} MB`;
    
    document.getElementById('final-result').textContent = `${totalMB.toFixed(2)} MB`;

    // ÊØîËºÉÊÉÖÂ†±„ÇíÊõ¥Êñ∞
    updateComparisonInfo(totalMB);
}

function updateComparisonInfo(sizeInMB) {
    const comparisonDiv = document.getElementById('comparison-info');
    let comparisons = [];

    if (sizeInMB <= 1.44) {
        comparisons.push('üíæ „Éï„É≠„ÉÉ„Éî„Éº„Éá„Ç£„Çπ„ÇØ: Âèé„Åæ„Çä„Åæ„Åô');
    } else {
        comparisons.push(`üíæ „Éï„É≠„ÉÉ„Éî„Éº„Éá„Ç£„Çπ„ÇØ: ${Math.ceil(sizeInMB / 1.44)} ÊûöÂøÖË¶Å`);
    }

    if (sizeInMB <= 10) {
        comparisons.push('üìß „É°„Éº„É´Ê∑ª‰ªò: ‰∏ÄËà¨ÁöÑ„Å™ÂÆπÈáèÂà∂ÈôêÂÜÖ');
    } else {
        comparisons.push('üìß „É°„Éº„É´Ê∑ª‰ªò: ÂÆπÈáèÂà∂Èôê„ÇíË∂Ö„Åà„ÇãÂèØËÉΩÊÄß');
    }

    if (sizeInMB <= 5) {
        comparisons.push('üì± „Çπ„Éû„Éº„Éà„Éï„Ç©„É≥: Ê®ôÊ∫ñÁöÑ„Å™„Çµ„Ç§„Ç∫');
    } else {
        comparisons.push('üì± „Çπ„Éû„Éº„Éà„Éï„Ç©„É≥: È´òÁîªË≥™ÂÜôÁúü„Çµ„Ç§„Ç∫');
    }

    comparisonDiv.innerHTML = comparisons.map(comp => `<p>${comp}</p>`).join('');
}

// „Éî„ÇØ„Çª„É´Ë°®Á§∫Ê©üËÉΩ
function setupPixelDisplay() {
    const pixelSizeSelect = document.getElementById('pixel-size');
    const pixelZoomSlider = document.getElementById('pixel-zoom');
    const pixelZoomValue = document.getElementById('pixel-zoom-value');
    const canvas = document.getElementById('pixel-canvas');

    pixelSizeSelect.addEventListener('change', function() {
        generatePixelGrid();
        updatePixelInfo();
    });
    
    pixelZoomSlider.addEventListener('input', function() {
        pixelZoomValue.textContent = this.value + 'px';
        drawPixelGrid();
        updatePixelInfo();
    });

    canvas.addEventListener('click', handlePixelClick);

    generatePixelGrid();
    updatePixelInfo();
}

function generatePixelGrid() {
    const size = parseInt(document.getElementById('pixel-size').value);
    pixelGrid = [];
    
    for (let y = 0; y < size; y++) {
        pixelGrid[y] = [];
        for (let x = 0; x < size; x++) {
            pixelGrid[y][x] = {
                r: Math.floor(Math.random() * 256),
                g: Math.floor(Math.random() * 256),
                b: Math.floor(Math.random() * 256)
            };
        }
    }
    
    drawPixelGrid();
}

function drawPixelGrid() {
    const canvas = document.getElementById('pixel-canvas');
    const ctx = canvas.getContext('2d');
    const pixelSize = parseInt(document.getElementById('pixel-zoom').value);
    const gridSize = pixelGrid.length;
    
    // ÂÆüÈöõ„ÅÆ„Çµ„Ç§„Ç∫„Åß„Ç≠„É£„É≥„Éê„Çπ„ÇíË®≠ÂÆö
    canvas.width = gridSize * pixelSize;
    canvas.height = gridSize * pixelSize;
    
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // ÂÖ®„Éî„ÇØ„Çª„É´„ÇíÊèèÁîª
    for (let y = 0; y < gridSize; y++) {
        for (let x = 0; x < gridSize; x++) {
            const pixel = pixelGrid[y][x];
            ctx.fillStyle = `rgb(${pixel.r}, ${pixel.g}, ${pixel.b})`;
            ctx.fillRect(x * pixelSize, y * pixelSize, pixelSize, pixelSize);
            
            // „Ç∞„É™„ÉÉ„ÉâÁ∑öÔºà„Éî„ÇØ„Çª„É´„Çµ„Ç§„Ç∫„ÅåÂ∞è„Åï„Åô„Åé„ÇãÂ†¥Âêà„ÅØÊèèÁîª„Åó„Å™„ÅÑÔºâ
            if (pixelSize >= 3) {
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 1;
                ctx.strokeRect(x * pixelSize, y * pixelSize, pixelSize, pixelSize);
            }
        }
    }
}

function handlePixelClick(event) {
    const canvas = event.target;
    const rect = canvas.getBoundingClientRect();
    const pixelSize = parseInt(document.getElementById('pixel-zoom').value);
    
    const x = Math.floor((event.clientX - rect.left) / pixelSize);
    const y = Math.floor((event.clientY - rect.top) / pixelSize);
    
    if (x >= 0 && x < pixelGrid[0].length && y >= 0 && y < pixelGrid.length) {
        const pixel = pixelGrid[y][x];
        const pixelInfo = document.getElementById('selected-pixel-info');
        
        pixelInfo.innerHTML = `
            <strong>‰ΩçÁΩÆ:</strong> (${x}, ${y})<br>
            <strong>RGBÂÄ§:</strong><br>
            Ëµ§: ${pixel.r} (${pixel.r.toString(16).padStart(2, '0')})<br>
            Á∑ë: ${pixel.g} (${pixel.g.toString(16).padStart(2, '0')})<br>
            Èùí: ${pixel.b} (${pixel.b.toString(16).padStart(2, '0')})<br>
            <strong>16ÈÄ≤Êï∞:</strong> #${pixel.r.toString(16).padStart(2, '0')}${pixel.g.toString(16).padStart(2, '0')}${pixel.b.toString(16).padStart(2, '0')}<br>
            <strong>„Éá„Éº„Çø„Çµ„Ç§„Ç∫:</strong> 3„Éê„Ç§„Éà (24„Éì„ÉÉ„Éà)
        `;
    }
}

function updatePixelInfo() {
    const size = parseInt(document.getElementById('pixel-size').value);
    const pixelSize = parseInt(document.getElementById('pixel-zoom').value);
    const canvasSize = size * pixelSize;
    
    // CanvasË°®Á§∫„Çµ„Ç§„Ç∫ÊÉÖÂ†±
    document.getElementById('canvas-size-info').textContent = `Canvas: ${canvasSize}√ó${canvasSize}px`;
    
    // „É°„É¢„É™‰ΩøÁî®ÈáèË®àÁÆóÔºà24„Éì„ÉÉ„Éà„Ç´„É©„Éº„ÅÆÂ†¥ÂêàÔºâ
    const totalPixels = size * size;
    const bytesPerPixel = 3; // 24„Éì„ÉÉ„Éà = 3„Éê„Ç§„Éà
    const totalBytes = totalPixels * bytesPerPixel;
    const totalMB = totalBytes / (1024 * 1024);
    
    let memoryText = '';
    if (totalMB >= 1) {
        memoryText = `„É°„É¢„É™‰ΩøÁî®Èáè: ${totalMB.toFixed(2)}MBÁõ∏ÂΩì`;
    } else if (totalBytes >= 1024) {
        memoryText = `„É°„É¢„É™‰ΩøÁî®Èáè: ${(totalBytes / 1024).toFixed(1)}KBÁõ∏ÂΩì`;
    } else {
        memoryText = `„É°„É¢„É™‰ΩøÁî®Èáè: ${totalBytes}„Éê„Ç§„ÉàÁõ∏ÂΩì`;
    }
    
    document.getElementById('memory-usage').textContent = memoryText;
}

// Ëâ≤Ê∑±Â∫¶ÊØîËºÉÊ©üËÉΩ
function setupColorDepthComparison() {
    const sampleImageSelect = document.getElementById('sample-image');
    sampleImageSelect.addEventListener('change', updateColorDepthComparison);
    updateColorDepthComparison();
}

function updateColorDepthComparison() {
    const sampleType = document.getElementById('sample-image').value;
    const canvases = ['depth-1bit', 'depth-4bit', 'depth-8bit', 'depth-24bit'];
    const sizes = ['size-1bit', 'size-4bit', 'size-8bit', 'size-24bit'];
    const depths = [1, 4, 8, 24];
    
    canvases.forEach((canvasId, index) => {
        const canvas = document.getElementById(canvasId);
        const ctx = canvas.getContext('2d');
        const width = canvas.width;
        const height = canvas.height;
        
        // „Çµ„É≥„Éó„É´ÁîªÂÉè„ÇíÁîüÊàê
        generateSampleImage(ctx, width, height, sampleType, depths[index]);
        
        // „Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„ÇíË®àÁÆó
        const pixelCount = width * height;
        const bytesPerPixel = depths[index] / 8;
        const totalBytes = pixelCount * bytesPerPixel;
        const totalMB = totalBytes / (1024 * 1024);
        
        document.getElementById(sizes[index]).textContent = totalMB.toFixed(3) + ' MB';
    });
}

function generateSampleImage(ctx, width, height, sampleType, colorDepth) {
    const imageData = ctx.createImageData(width, height);
    const data = imageData.data;
    
    for (let y = 0; y < height; y++) {
        for (let x = 0; x < width; x++) {
            const index = (y * width + x) * 4;
            let r, g, b;
            
            if (sampleType === 'gradient') {
                r = Math.floor((x / width) * 255);
                g = Math.floor((y / height) * 255);
                b = Math.floor(((x + y) / (width + height)) * 255);
            } else if (sampleType === 'photo') {
                r = 120 + Math.sin(x * 0.1) * 50;
                g = 80 + Math.cos(y * 0.1) * 70;
                b = 60 + Math.sin((x + y) * 0.05) * 60;
            } else { // simple
                r = x < width / 2 ? 255 : 0;
                g = y < height / 2 ? 255 : 0;
                b = (x + y) % 50 < 25 ? 255 : 0;
            }
            
            // Ëâ≤Ê∑±Â∫¶„Å´Âøú„Åò„Å¶ÈáèÂ≠êÂåñ
            if (colorDepth === 1) {
                const gray = (r + g + b) / 3;
                r = g = b = gray > 128 ? 255 : 0;
            } else if (colorDepth === 4) {
                r = Math.floor(r / 85) * 85;
                g = Math.floor(g / 85) * 85;
                b = Math.floor(b / 85) * 85;
            } else if (colorDepth === 8) {
                r = Math.floor(r / 32) * 32;
                g = Math.floor(g / 32) * 32;
                b = Math.floor(b / 32) * 32;
            }
            
            data[index] = r;
            data[index + 1] = g;
            data[index + 2] = b;
            data[index + 3] = 255; // alpha
        }
    }
    
    ctx.putImageData(imageData, 0, 0);
}

// Á∑¥ÁøíÂïèÈ°åÊ©üËÉΩ
function setupPracticeProblems() {
    const levelButtons = document.querySelectorAll('.level-button');
    const hintButton = document.getElementById('hint-button');
    const checkButton = document.getElementById('check-answer');
    const nextButton = document.getElementById('next-problem');

    levelButtons.forEach(button => {
        button.addEventListener('click', function() {
            levelButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            currentLevel = parseInt(this.dataset.level);
            currentProblem = 0;
            loadProblem();
        });
    });

    hintButton.addEventListener('click', showHint);
    checkButton.addEventListener('click', checkAnswer);
    nextButton.addEventListener('click', nextProblem);

    // ‰øÆ‰∫ÜË®ºÈñ¢ÈÄ£„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
    setupCertificateEvents();

    loadProblem();
}

function loadProblem() {
    const problemData = problems[currentLevel];
    if (!problemData || currentProblem >= problemData.length) {
        currentProblem = 0;
    }

    const problem = problemData[currentProblem];
    const problemDiv = document.getElementById('current-problem');

    problemDiv.querySelector('h3').textContent = `ÂïèÈ°å ${currentProblem + 1}`;
    problemDiv.querySelector('p').textContent = problem.question;

    const answerInput = document.getElementById('answer-input');
    const unitSelect = document.getElementById('unit-select');
    const feedback = document.getElementById('feedback');
    const hintPanel = document.getElementById('hint-panel');

    answerInput.value = '';
    unitSelect.value = problem.unit;
    feedback.innerHTML = '';
    feedback.className = 'feedback';
    hintPanel.style.display = 'none';

    updateScoreDisplay();
}

function showHint() {
    const problemData = problems[currentLevel][currentProblem];
    const hintPanel = document.getElementById('hint-panel');
    
    hintPanel.innerHTML = `<strong>„Éí„É≥„Éà:</strong> ${problemData.hint}`;
    hintPanel.style.display = 'block';
}

function checkAnswer() {
    const answerInput = document.getElementById('answer-input');
    const unitSelect = document.getElementById('unit-select');
    const feedback = document.getElementById('feedback');
    const problemData = problems[currentLevel][currentProblem];

    const userAnswer = parseFloat(answerInput.value);
    const userUnit = unitSelect.value;
    
    const problemId = `${currentLevel}-${currentProblem}`;
    
    // Êó¢„Å´Ëß£Á≠îÊ∏à„Åø„ÅÆÂïèÈ°å„Åß„Å™„ÅÑÂ†¥Âêà„ÅÆ„Åø„Ç´„Ç¶„É≥„Éà
    if (!problemsAnswered.has(problemId)) {
        totalCount++;
        problemsAnswered.add(problemId);
    }

    if (isNaN(userAnswer)) {
        feedback.innerHTML = 'Êï∞ÂÄ§„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
        feedback.className = 'feedback incorrect';
        return;
    }

    const isCorrect = Math.abs(userAnswer - problemData.answer) < 0.1 && userUnit === problemData.unit;

    if (isCorrect) {
        if (!correctProblems.has(problemId)) {
            correctCount++;
            correctProblems.add(problemId);
        }
        feedback.innerHTML = 'üéâ Ê≠£Ëß£„Åß„ÅôÔºÅ';
        feedback.className = 'feedback correct';
    } else {
        feedback.innerHTML = '‚ùå ‰∏çÊ≠£Ëß£„Åß„Åô„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶Ë®àÁÆó„Åó„Å¶„Åø„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
        feedback.className = 'feedback incorrect';
        correctProblems.delete(problemId); // ÈñìÈÅï„Åà„ÅüÂ†¥Âêà„ÅØÊ≠£Ëß£„Çª„ÉÉ„Éà„Åã„ÇâÂâäÈô§
    }

    updateScoreDisplay();
    checkCompletion();
}

function nextProblem() {
    currentProblem++;
    const problemData = problems[currentLevel];
    
    if (currentProblem >= problemData.length) {
        currentProblem = 0;
    }
    
    loadProblem();
}

function updateScoreDisplay() {
    document.getElementById('correct-count').textContent = correctCount;
    document.getElementById('total-count').textContent = totalCount;
}

// ‰øÆ‰∫ÜÂà§ÂÆö„Å®‰øÆ‰∫ÜË®ºË°®Á§∫
function checkCompletion() {
    const totalProblems = getTotalProblemsCount();
    const completionStatus = document.getElementById('completion-status');
    
    if (correctProblems.size === totalProblems) {
        completionStatus.innerHTML = `
            <div class="completed">
                üéâ „Åô„Åπ„Å¶„ÅÆÂïèÈ°å„ÇíÊ≠£Ëß£„Åó„Åæ„Åó„ÅüÔºÅ
                <br>
                <button onclick="showCertificate()">üèÜ ‰øÆ‰∫ÜË®º„ÇíË°®Á§∫</button>
            </div>
        `;
        completionStatus.className = 'completion-status completed';
    } else {
        completionStatus.innerHTML = `
            ÊÆã„Çä ${totalProblems - correctProblems.size} Âïè„ÅÆÊ≠£Ëß£„Åß‰øÆ‰∫ÜË®º„ÇíÂèñÂæó„Åß„Åç„Åæ„Åô
        `;
        completionStatus.className = 'completion-status';
    }
}

function getTotalProblemsCount() {
    let total = 0;
    for (let level in problems) {
        total += problems[level].length;
    }
    return total;
}

// ‰øÆ‰∫ÜË®ºÊ©üËÉΩ
function setupCertificateEvents() {
    const modal = document.getElementById('certificate-modal');
    const closeButtons = [
        document.getElementById('certificate-close'),
        document.getElementById('close-certificate')
    ];
    const downloadButton = document.getElementById('download-certificate');

    closeButtons.forEach(button => {
        button.addEventListener('click', () => {
            modal.style.display = 'none';
        });
    });

    window.addEventListener('click', (event) => {
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    });

    downloadButton.addEventListener('click', downloadCertificate);
}

function showCertificate() {
    const modal = document.getElementById('certificate-modal');
    modal.style.display = 'block';
    generateCertificate();
}

function generateCertificate() {
    const canvas = document.getElementById('certificate-canvas');
    const ctx = canvas.getContext('2d');
    
    // ËÉåÊôØ„Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥
    const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
    gradient.addColorStop(0, '#667eea');
    gradient.addColorStop(1, '#764ba2');
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Â§ñÊû†
    ctx.strokeStyle = '#fff';
    ctx.lineWidth = 8;
    ctx.strokeRect(20, 20, canvas.width - 40, canvas.height - 40);
    
    // ÂÜÖÂÅ¥„ÅÆÈ£æ„ÇäÊû†
    ctx.strokeStyle = '#f8f9ff';
    ctx.lineWidth = 2;
    ctx.strokeRect(40, 40, canvas.width - 80, canvas.height - 80);
    
    // „Çø„Ç§„Éà„É´
    ctx.fillStyle = '#fff';
    ctx.font = 'bold 48px "Segoe UI", Arial, sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('‰øÆ‰∫ÜË®º', canvas.width / 2, 120);
    
    // Ë™çÂÆöÊñá
    ctx.font = '28px "Segoe UI", Arial, sans-serif';
    ctx.fillText('Certificate of Completion', canvas.width / 2, 170);
    
    // „É°„Ç§„É≥ÊñáÁ´†
    ctx.font = '24px "Segoe UI", Arial, sans-serif';
    ctx.fillText('‰∏äË®ò„ÅÆËÄÖ„ÅØ', canvas.width / 2, 240);
    
    ctx.font = 'bold 32px "Segoe UI", Arial, sans-serif';
    ctx.fillText('ÁîªÂÉè„Éá„Ç∏„Çø„É´Âåñ„Éª„Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫Â≠¶Áøí', canvas.width / 2, 290);
    
    ctx.font = '24px "Segoe UI", Arial, sans-serif';
    ctx.fillText('„Å´„Åä„ÅÑ„Å¶„ÄÅÂÖ®„Å¶„ÅÆÁ∑¥ÁøíÂïèÈ°å„ÇíÊ≠£Ëß£„Åó', canvas.width / 2, 340);
    ctx.fillText('ÊâÄÂÆö„ÅÆË™≤Á®ã„Çí‰øÆ‰∫Ü„Åó„Åü„Åì„Å®„ÇíË™çÂÆö„Åó„Åæ„Åô', canvas.width / 2, 380);
    
    // Êó•‰ªò
    const today = new Date();
    const dateString = `${today.getFullYear()}Âπ¥${today.getMonth() + 1}Êúà${today.getDate()}Êó•`;
    ctx.font = '20px "Segoe UI", Arial, sans-serif';
    ctx.fillText(dateString, canvas.width / 2, 450);
    
    // Áô∫Ë°åËÄÖ
    ctx.font = '18px "Segoe UI", Arial, sans-serif';
    ctx.fillText('ÁîªÂÉè„Éá„Ç∏„Çø„É´ÂåñÂ≠¶Áøí„ÉÑ„Éº„É´', canvas.width / 2, 520);
    ctx.fillText('È´òÊ†°ÊÉÖÂ†±‚Ö†ÂØæÂøú', canvas.width / 2, 545);
    
    // Ë£ÖÈ£æÁöÑ„Å™Ë¶ÅÁ¥†
    drawDecorations(ctx, canvas.width, canvas.height);
}

function drawDecorations(ctx, width, height) {
    // Â∑¶‰∏ä„ÅÆË£ÖÈ£æ
    ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
    ctx.beginPath();
    ctx.arc(100, 100, 30, 0, 2 * Math.PI);
    ctx.fill();
    
    // Âè≥‰∏ä„ÅÆË£ÖÈ£æ
    ctx.beginPath();
    ctx.arc(width - 100, 100, 25, 0, 2 * Math.PI);
    ctx.fill();
    
    // Â∑¶‰∏ã„ÅÆË£ÖÈ£æ
    ctx.beginPath();
    ctx.arc(100, height - 100, 25, 0, 2 * Math.PI);
    ctx.fill();
    
    // Âè≥‰∏ã„ÅÆË£ÖÈ£æ
    ctx.beginPath();
    ctx.arc(width - 100, height - 100, 30, 0, 2 * Math.PI);
    ctx.fill();
    
    // Êòü„ÅÆË£ÖÈ£æ
    drawStar(ctx, width / 2 - 200, 200, 15);
    drawStar(ctx, width / 2 + 200, 200, 15);
    drawStar(ctx, width / 2 - 150, 480, 12);
    drawStar(ctx, width / 2 + 150, 480, 12);
}

function drawStar(ctx, x, y, size) {
    ctx.fillStyle = 'rgba(255, 255, 255, 0.4)';
    ctx.beginPath();
    for (let i = 0; i < 5; i++) {
        const angle = (i * 2 * Math.PI) / 5 - Math.PI / 2;
        const x1 = x + Math.cos(angle) * size;
        const y1 = y + Math.sin(angle) * size;
        
        const angle2 = ((i + 0.5) * 2 * Math.PI) / 5 - Math.PI / 2;
        const x2 = x + Math.cos(angle2) * (size * 0.5);
        const y2 = y + Math.sin(angle2) * (size * 0.5);
        
        if (i === 0) {
            ctx.moveTo(x1, y1);
        } else {
            ctx.lineTo(x1, y1);
        }
        ctx.lineTo(x2, y2);
    }
    ctx.closePath();
    ctx.fill();
}

function downloadCertificate() {
    const canvas = document.getElementById('certificate-canvas');
    const link = document.createElement('a');
    
    const today = new Date();
    const dateString = `${today.getFullYear()}${(today.getMonth() + 1).toString().padStart(2, '0')}${today.getDate().toString().padStart(2, '0')}`;
    
    link.download = `ÁîªÂÉè„Éá„Ç∏„Çø„É´ÂåñÂ≠¶Áøí_‰øÆ‰∫ÜË®º_${dateString}.png`;
    link.href = canvas.toDataURL('image/png');
    link.click();
}